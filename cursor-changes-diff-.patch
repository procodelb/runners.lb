diff --git a/client/package-lock.json b/client/package-lock.json
index 0d9e839..f9990b9 100644
--- a/client/package-lock.json
+++ b/client/package-lock.json
@@ -16,8 +16,9 @@
         "html2canvas": "^1.4.1",
         "i18next": "^23.7.6",
         "i18next-browser-languagedetector": "^7.2.0",
-        "jspdf": "^2.5.1",
+        "jspdf": "^2.5.2",
         "lucide-react": "^0.294.0",
+        "papaparse": "^5.5.3",
         "react": "^18.2.0",
         "react-dom": "^18.2.0",
         "react-hook-form": "^7.48.2",
@@ -26,7 +27,8 @@
         "react-query": "^3.39.3",
         "react-router-dom": "^6.20.1",
         "socket.io-client": "^4.7.4",
-        "tailwind-merge": "^2.0.0"
+        "tailwind-merge": "^2.0.0",
+        "xlsx": "^0.18.5"
       },
       "devDependencies": {
         "@types/react": "^18.2.37",
@@ -1358,6 +1360,14 @@
         "acorn": "^6.0.0 || ^7.0.0 || ^8.0.0"
       }
     },
+    "node_modules/adler-32": {
+      "version": "1.3.1",
+      "resolved": "https://registry.npmjs.org/adler-32/-/adler-32-1.3.1.tgz",
+      "integrity": "sha512-ynZ4w/nUUv5rrsR8UUGoe1VC9hZj6V5hU9Qw1HlMDJGEJw5S7TfTErWTjMys6M7vr0YWcPqs3qAr4ss0nDfP+A==",
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
     "node_modules/ajv": {
       "version": "6.12.6",
       "resolved": "https://registry.npmjs.org/ajv/-/ajv-6.12.6.tgz",
@@ -1854,6 +1864,18 @@
         "node": ">=10.0.0"
       }
     },
+    "node_modules/cfb": {
+      "version": "1.2.2",
+      "resolved": "https://registry.npmjs.org/cfb/-/cfb-1.2.2.tgz",
+      "integrity": "sha512-KfdUZsSOw19/ObEWasvBP/Ac4reZvAGauZhs6S/gqNhXhI7cKwvlH7ulj+dOEYnca4bm4SGo8C1bTAQvnTjgQA==",
+      "dependencies": {
+        "adler-32": "~1.3.0",
+        "crc-32": "~1.2.0"
+      },
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
     "node_modules/chalk": {
       "version": "4.1.2",
       "resolved": "https://registry.npmjs.org/chalk/-/chalk-4.1.2.tgz",
@@ -1912,6 +1934,14 @@
         "node": ">=6"
       }
     },
+    "node_modules/codepage": {
+      "version": "1.15.0",
+      "resolved": "https://registry.npmjs.org/codepage/-/codepage-1.15.0.tgz",
+      "integrity": "sha512-3g6NUTPd/YtuuGrhMnOMRjFc+LJw/bnMp3+0r/Wcz3IXUuCosKRJvMphm5+Q+bvTVGcJJuRvVLuYba+WojaFaA==",
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
     "node_modules/color-convert": {
       "version": "2.0.1",
       "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz",
@@ -1969,6 +1999,17 @@
         "url": "https://opencollective.com/core-js"
       }
     },
+    "node_modules/crc-32": {
+      "version": "1.2.2",
+      "resolved": "https://registry.npmjs.org/crc-32/-/crc-32-1.2.2.tgz",
+      "integrity": "sha512-ROmzCKrTnOwybPcJApAA6WBWij23HVfGVNKqqrZpuyZOHqK2CwHSvpGuyt/UNNvaIjEd8X5IFGp4Mh+Ie1IHJQ==",
+      "bin": {
+        "crc32": "bin/crc32.njs"
+      },
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
     "node_modules/cross-spawn": {
       "version": "7.0.6",
       "resolved": "https://registry.npmjs.org/cross-spawn/-/cross-spawn-7.0.6.tgz",
@@ -2847,6 +2888,14 @@
         "node": ">= 6"
       }
     },
+    "node_modules/frac": {
+      "version": "1.1.2",
+      "resolved": "https://registry.npmjs.org/frac/-/frac-1.1.2.tgz",
+      "integrity": "sha512-w/XBfkibaTl3YDqASwfDUqkna4Z2p9cFSr1aHDt0WoMTECnRfBOv2WArlZILlqgWlmdIlALXGpM2AOhEk5W3IA==",
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
     "node_modules/fraction.js": {
       "version": "4.3.7",
       "resolved": "https://registry.npmjs.org/fraction.js/-/fraction.js-4.3.7.tgz",
@@ -4253,6 +4302,11 @@
       "resolved": "https://registry.npmjs.org/package-json-from-dist/-/package-json-from-dist-1.0.1.tgz",
       "integrity": "sha512-UEZIS3/by4OC8vL3P2dTXRETpebLI2NiI5vIrjaD/5UtrkFX/tNbwjTSRAGC/+7CAo2pIcBaRgWmcBBHcsaCIw=="
     },
+    "node_modules/papaparse": {
+      "version": "5.5.3",
+      "resolved": "https://registry.npmjs.org/papaparse/-/papaparse-5.5.3.tgz",
+      "integrity": "sha512-5QvjGxYVjxO59MGU2lHVYpRWBBtKHnlIAcSe1uNFCkkptUh63NFRj0FJQm7nR67puEruUci/ZkjmEFrjCAyP4A=="
+    },
     "node_modules/parent-module": {
       "version": "1.0.1",
       "resolved": "https://registry.npmjs.org/parent-module/-/parent-module-1.0.1.tgz",
@@ -5200,6 +5254,17 @@
         "node": ">=0.10.0"
       }
     },
+    "node_modules/ssf": {
+      "version": "0.11.2",
+      "resolved": "https://registry.npmjs.org/ssf/-/ssf-0.11.2.tgz",
+      "integrity": "sha512-+idbmIXoYET47hH+d7dfm2epdOMUDjqcB4648sTZ+t2JwoyBFL/insLfB/racrDmsKB3diwsDA696pZMieAC5g==",
+      "dependencies": {
+        "frac": "~1.1.2"
+      },
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
     "node_modules/stackblur-canvas": {
       "version": "2.7.0",
       "resolved": "https://registry.npmjs.org/stackblur-canvas/-/stackblur-canvas-2.7.0.tgz",
@@ -5965,6 +6030,22 @@
         "url": "https://github.com/sponsors/ljharb"
       }
     },
+    "node_modules/wmf": {
+      "version": "1.0.2",
+      "resolved": "https://registry.npmjs.org/wmf/-/wmf-1.0.2.tgz",
+      "integrity": "sha512-/p9K7bEh0Dj6WbXg4JG0xvLQmIadrner1bi45VMJTfnbVHsc7yIajZyoSoK60/dtVBs12Fm6WkUI5/3WAVsNMw==",
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
+    "node_modules/word": {
+      "version": "0.3.0",
+      "resolved": "https://registry.npmjs.org/word/-/word-0.3.0.tgz",
+      "integrity": "sha512-OELeY0Q61OXpdUfTp+oweA/vtLVg5VDOXh+3he3PNzLGG/y0oylSOC1xRVj0+l4vQ3tj/bB1HVHv1ocXkQceFA==",
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
     "node_modules/word-wrap": {
       "version": "1.2.5",
       "resolved": "https://registry.npmjs.org/word-wrap/-/word-wrap-1.2.5.tgz",
@@ -6086,6 +6167,26 @@
         }
       }
     },
+    "node_modules/xlsx": {
+      "version": "0.18.5",
+      "resolved": "https://registry.npmjs.org/xlsx/-/xlsx-0.18.5.tgz",
+      "integrity": "sha512-dmg3LCjBPHZnQp5/F/+nnTa+miPJxUXB6vtk42YjBBKayDNagxGEeIdWApkYPOf3Z3pm3k62Knjzp7lMeTEtFQ==",
+      "dependencies": {
+        "adler-32": "~1.3.0",
+        "cfb": "~1.2.1",
+        "codepage": "~1.15.0",
+        "crc-32": "~1.2.1",
+        "ssf": "~0.11.2",
+        "wmf": "~1.0.1",
+        "word": "~0.3.0"
+      },
+      "bin": {
+        "xlsx": "bin/xlsx.njs"
+      },
+      "engines": {
+        "node": ">=0.8"
+      }
+    },
     "node_modules/xmlhttprequest-ssl": {
       "version": "2.1.2",
       "resolved": "https://registry.npmjs.org/xmlhttprequest-ssl/-/xmlhttprequest-ssl-2.1.2.tgz",
diff --git a/client/package.json b/client/package.json
index edb711d..7a29fce 100644
--- a/client/package.json
+++ b/client/package.json
@@ -18,10 +18,10 @@
     "html2canvas": "^1.4.1",
     "i18next": "^23.7.6",
     "i18next-browser-languagedetector": "^7.2.0",
-    "jspdf": "^2.5.1",
+    "jspdf": "^2.5.2",
     "lucide-react": "^0.294.0",
+    "papaparse": "^5.5.3",
     "react": "^18.2.0",
-    "html2canvas": "^1.4.1",
     "react-dom": "^18.2.0",
     "react-hook-form": "^7.48.2",
     "react-hot-toast": "^2.4.1",
@@ -29,7 +29,8 @@
     "react-query": "^3.39.3",
     "react-router-dom": "^6.20.1",
     "socket.io-client": "^4.7.4",
-    "tailwind-merge": "^2.0.0"
+    "tailwind-merge": "^2.0.0",
+    "xlsx": "^0.18.5"
   },
   "devDependencies": {
     "@types/react": "^18.2.37",
diff --git a/client/src/App.jsx b/client/src/App.jsx
index fda0a87..2b15ced 100644
--- a/client/src/App.jsx
+++ b/client/src/App.jsx
@@ -20,7 +20,6 @@ import NewAccounting from './pages/NewAccounting';
 import Cashbox from './pages/Cashbox';
 import PriceList from './pages/PriceList';
 import OrderHistory from './pages/OrderHistory';
-import Transactions from './pages/Transactions';
 import Settings from './pages/Settings';
 import Layout from './components/Layout';
 import ProtectedRoute from './components/ProtectedRoute';
@@ -179,8 +178,24 @@ const AppContent = () => {
   useEffect(() => {
     if (user && isAuthenticated) {
       console.log('≡ƒöî AppContent: User authenticated, initializing Socket.IO...');
+      // Resolve Socket.IO base URL similar to API logic
+      let socketBase = import.meta.env.VITE_API_URL;
+      try {
+        if (!socketBase && typeof window !== 'undefined') {
+          const hostname = window.location.hostname;
+          if (hostname === 'localhost' || hostname === '127.0.0.1') {
+            socketBase = 'http://localhost:5000';
+          } else if (hostname.includes('vercel.app')) {
+            socketBase = 'https://soufiam-erp-backend.onrender.com';
+          } else {
+            socketBase = 'https://soufiam-erp-backend.onrender.com';
+          }
+        }
+      } catch {}
+
       // Initialize Socket.IO connection
-      const newSocket = io(import.meta.env.VITE_API_URL || 'https://soufiam-erp-backend.onrender.com', {
+      const newSocket = io(socketBase, {
+        withCredentials: true,
         auth: {
           token: localStorage.getItem('token')
         }
@@ -338,16 +353,6 @@ const AppContent = () => {
                 ); 
               })()
             } />
-            <Route path="/transactions" element={
-              (() => { 
-                console.log('≡ƒÆ│ AppContent: Rendering transactions route'); 
-                return (
-                  <Layout>
-                    <Transactions />
-                  </Layout>
-                ); 
-              })()
-            } />
             <Route path="/settings" element={
               (() => { 
                 console.log('ΓÜÖ∩╕Å AppContent: Rendering settings route'); 
diff --git a/client/src/api/accounting.js b/client/src/api/accounting.js
index e471190..e794e4a 100644
--- a/client/src/api/accounting.js
+++ b/client/src/api/accounting.js
@@ -1,5 +1,20 @@
 import api from './index';
 
+export async function fetchEntities(params = {}) {
+  const { data } = await api.get('/accounting/entities', { params });
+  return data;
+}
+
+export async function fetchEntityOrders(type, id, params = {}) {
+  const { data } = await api.get(`/accounting/${type}/${id}/orders`, { params });
+  return data;
+}
+
+export async function cashoutOrder(orderId, mode) {
+  const { data } = await api.post('/accounting/cashout', { orderId, mode });
+  return data;
+}
+
 export const accountingApi = {
   // Get all transactions
   getTransactions: async (params = {}) => {
@@ -78,3 +93,9 @@ export const accountingApi = {
     return response.data;
   }
 };
+
+// Helper for price-list search used by Add Order flows when needed in accounting context
+export async function fetchPriceListSearch(q) {
+  const { data } = await api.get('/price-list/search', { params: { q } });
+  return data;
+}
diff --git a/client/src/api/index.js b/client/src/api/index.js
index bf06a99..3c172b4 100644
--- a/client/src/api/index.js
+++ b/client/src/api/index.js
@@ -49,6 +49,12 @@ api.interceptors.request.use(
     }
     
     console.log(`≡ƒîÉ API Request: ${config.method?.toUpperCase()} ${config.url}`);
+    try {
+      console.log('≡ƒº╛ API Request Headers:', { Authorization: config.headers?.Authorization, 'Content-Type': config.headers?.['Content-Type'] });
+      if (config.data) {
+        console.log('≡ƒôª API Request Body:', typeof config.data === 'string' ? config.data : JSON.stringify(config.data));
+      }
+    } catch {}
     return config;
   },
   (error) => {
@@ -392,7 +398,7 @@ export const apiHelpers = {
         currency: 'USD',
       }).format(amount);
     } else if (currency === 'LBP') {
-      return new Intl.NumberFormat('ar-LB', {
+      return new Intl.NumberFormat('en-US', {
         style: 'currency',
         currency: 'LBP',
       }).format(amount);
diff --git a/client/src/api/orders.js b/client/src/api/orders.js
index 22d36d9..a538459 100644
--- a/client/src/api/orders.js
+++ b/client/src/api/orders.js
@@ -67,6 +67,18 @@ export const ordersApi = {
     return response.data;
   },
 
+  // Batch create orders
+  batchCreate: async (orders) => {
+    const response = await api.post('/orders/batch', { orders });
+    return response.data;
+  },
+
+  // Bulk assign driver
+  bulkAssignDriver: async (orderIds, driverId) => {
+    const response = await api.patch('/orders/assign', { order_ids: orderIds, driver_id: driverId });
+    return response.data;
+  },
+
   // Get order statistics
   getOrderStats: async () => {
     const response = await api.get('/orders/stats');
diff --git a/client/src/api/priceList.js b/client/src/api/priceList.js
index 9173894..c64a171 100644
--- a/client/src/api/priceList.js
+++ b/client/src/api/priceList.js
@@ -72,5 +72,17 @@ export const priceListApi = {
   getPriceListStats: async () => {
     const response = await api.get('/price-list/stats');
     return response.data;
+  },
+
+  // Search price list for autocomplete
+  searchPriceList: async (query) => {
+    const response = await api.get('/price-list/search', { params: { q: query } });
+    return response.data;
+  },
+
+  // Toggle price list item status
+  togglePriceListStatus: async (id, isActive) => {
+    const response = await api.patch(`/price-list/${id}/toggle-status`, { is_active: isActive });
+    return response.data;
   }
 };
diff --git a/client/src/api/transactions.js b/client/src/api/transactions.js
deleted file mode 100644
index c930777..0000000
--- a/client/src/api/transactions.js
+++ /dev/null
@@ -1,74 +0,0 @@
-import api from './index';
-
-export const transactionsApi = {
-  // Get all transactions
-  getTransactions: async (params = {}) => {
-    const response = await api.get('/transactions', { params });
-    return response.data;
-  },
-
-  // Get transaction by ID
-  getTransaction: async (id) => {
-    const response = await api.get(`/transactions/${id}`);
-    return response.data;
-  },
-
-  // Create transaction
-  createTransaction: async (transactionData) => {
-    const response = await api.post('/transactions', transactionData);
-    return response.data;
-  },
-
-  // Update transaction
-  updateTransaction: async (id, transactionData) => {
-    const response = await api.put(`/transactions/${id}`, transactionData);
-    return response.data;
-  },
-
-  // Delete transaction
-  deleteTransaction: async (id) => {
-    const response = await api.delete(`/transactions/${id}`);
-    return response.data;
-  },
-
-  // Get transactions by actor type
-  getTransactionsByActor: async (actorType, actorId, params = {}) => {
-    const response = await api.get(`/transactions/actor/${actorType}/${actorId}`, { params });
-    return response.data;
-  },
-
-  // Get transactions by type
-  getTransactionsByType: async (txType, params = {}) => {
-    const response = await api.get(`/transactions/type/${txType}`, { params });
-    return response.data;
-  },
-
-  // Export transactions
-  exportTransactions: async (params = {}) => {
-    const response = await api.get('/transactions/export', { 
-      params,
-      responseType: 'blob'
-    });
-    return response.data;
-  },
-
-  // Print transaction receipt
-  printReceipt: async (transactionId) => {
-    const response = await api.get(`/transactions/${transactionId}/print`, {
-      responseType: 'blob'
-    });
-    return response.data;
-  },
-
-  // Get transaction statistics
-  getTransactionStats: async (params = {}) => {
-    const response = await api.get('/transactions/stats', { params });
-    return response.data;
-  },
-
-  // Bulk create transactions
-  bulkCreateTransactions: async (transactions) => {
-    const response = await api.post('/transactions/bulk', { transactions });
-    return response.data;
-  }
-};
diff --git a/client/src/components/Layout.jsx b/client/src/components/Layout.jsx
index ced8469..63e2d4b 100644
--- a/client/src/components/Layout.jsx
+++ b/client/src/components/Layout.jsx
@@ -26,9 +26,14 @@ import { useAuth } from '../contexts/AuthContext';
 import { useSocket } from '../contexts/SocketContext';
 import { apiHelpers } from '../api';
 import toast from 'react-hot-toast';
+import SidebarToggleButton from './SidebarToggleButton';
 
 const Layout = ({ children }) => {
   const [sidebarOpen, setSidebarOpen] = useState(false);
+  const [sidebarVisible, setSidebarVisible] = useState(() => {
+    const saved = localStorage.getItem('sidebarVisible');
+    return saved === null ? true : saved === 'true';
+  });
   const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
   const [language, setLanguage] = useState(localStorage.getItem('language') || 'en');
   const [notifications, setNotifications] = useState([]);
@@ -49,7 +54,6 @@ const Layout = ({ children }) => {
     { name: 'Cashbox', href: '/cashbox', icon: Wallet },
     { name: 'Price List', href: '/price-list', icon: DollarSign },
     { name: 'Order History', href: '/order-history', icon: History },
-    { name: 'Transactions', href: '/transactions', icon: Receipt },
     { name: 'Settings', href: '/settings', icon: Settings },
   ];
 
@@ -99,10 +103,14 @@ const Layout = ({ children }) => {
     return location.pathname === href;
   };
 
+  useEffect(() => {
+    localStorage.setItem('sidebarVisible', String(sidebarVisible));
+  }, [sidebarVisible]);
+
   return (
     <div className="h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-white font-inter flex">
       {/* Sidebar */}
-      <div className={`fixed inset-y-0 left-0 z-50 w-64 bg-sidebar-900 border-r border-sidebar-700 transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 ${
+      <div className={`${sidebarVisible ? '' : 'hidden'} fixed inset-y-0 left-0 z-50 w-64 bg-sidebar-900 border-r border-sidebar-700 transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 ${
         sidebarOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'
       }`} style={{ maxHeight: '100vh', overflowY: 'auto' }}>
         <div className="flex items-center justify-between h-16 px-6 border-b border-sidebar-700">
@@ -165,7 +173,7 @@ const Layout = ({ children }) => {
 
       {/* Mobile sidebar overlay */}
       <AnimatePresence>
-        {sidebarOpen && (
+        {sidebarOpen && sidebarVisible && (
           <motion.div
             initial={{ opacity: 0 }}
             animate={{ opacity: 1 }}
@@ -205,6 +213,10 @@ const Layout = ({ children }) => {
 
             {/* Right side actions */}
             <div className="flex items-center space-x-4">
+              <SidebarToggleButton
+                sidebarVisible={sidebarVisible}
+                onToggle={() => setSidebarVisible(v => !v)}
+              />
               {/* Connection status */}
               <div className="flex items-center space-x-2">
                 <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-accent-green' : 'bg-accent-red'}`} />
diff --git a/client/src/components/OrdersGrid.jsx b/client/src/components/OrdersGrid.jsx
index 956f6c3..1d46672 100644
--- a/client/src/components/OrdersGrid.jsx
+++ b/client/src/components/OrdersGrid.jsx
@@ -35,9 +35,10 @@ import toast from 'react-hot-toast';
 
 const OrdersGrid = () => {
   const [searchTerm, setSearchTerm] = useState('');
-  const [selectedStatus, setSelectedStatus] = useState('');
+  const [selectedStatus, setSelectedStatus] = useState('!cancelled');
   const [selectedBrand, setSelectedBrand] = useState('');
   const [selectedType, setSelectedType] = useState('');
+  const [selectedDeliveryMode, setSelectedDeliveryMode] = useState('');
   const [dateFrom, setDateFrom] = useState('');
   const [dateTo, setDateTo] = useState('');
   const [selectedRows, setSelectedRows] = useState(new Set());
@@ -46,13 +47,14 @@ const OrdersGrid = () => {
   const [clientSuggestions, setClientSuggestions] = useState([]);
   const [showClientSuggestions, setShowClientSuggestions] = useState(false);
   const [suggestionIndex, setSuggestionIndex] = useState(-1);
+  const [activeSuggestionField, setActiveSuggestionField] = useState('client');
 
   const queryClient = useQueryClient();
 
   // Fetch orders with search and filters
   const { data: orders, isLoading } = useQuery(
-    ['orders', searchTerm, selectedStatus, selectedBrand, selectedType, dateFrom, dateTo],
-    () => api.get(`/orders?search=${encodeURIComponent(searchTerm)}&status=${selectedStatus}&brand_name=${encodeURIComponent(selectedBrand)}&type=${selectedType}` + (dateFrom ? `&date_from=${dateFrom}` : '') + (dateTo ? `&date_to=${dateTo}` : '')), 
+    ['orders', searchTerm, selectedStatus, selectedBrand, selectedType, selectedDeliveryMode, dateFrom, dateTo],
+    () => api.get(`/orders?search=${encodeURIComponent(searchTerm)}&status=${encodeURIComponent(selectedStatus)}` + `&brand_name=${encodeURIComponent(selectedBrand)}&type=${selectedType}` + (selectedDeliveryMode ? `&delivery_mode=${selectedDeliveryMode}` : '') + (dateFrom ? `&date_from=${dateFrom}` : '') + (dateTo ? `&date_to=${dateTo}` : '')), 
     {
       keepPreviousData: true,
       select: (response) => response.data?.data || []
@@ -64,6 +66,35 @@ const OrdersGrid = () => {
     select: (response) => response.data?.data || []
   });
 
+  // Delete existing order
+  const deleteOrderMutation = useMutation(
+    (id) => api.delete(`/orders/${id}`),
+    {
+      onSuccess: () => {
+        queryClient.invalidateQueries('orders');
+        toast.success('Order deleted successfully!');
+      },
+      onError: (error) => {
+        toast.error(error.response?.data?.message || 'Failed to delete order');
+      }
+    }
+  );
+
+  // Update existing order (minimal editable fields)
+  const updateOrderMutation = useMutation(
+    ({ id, data }) => api.put(`/orders/${id}`, data),
+    {
+      onSuccess: () => {
+        queryClient.invalidateQueries('orders');
+        setEditingRow(null);
+        toast.success('Order updated');
+      },
+      onError: (error) => {
+        toast.error(error.response?.data?.message || 'Failed to update order');
+      }
+    }
+  );
+
   // Batch create orders mutation
   const batchCreateMutation = useMutation(
     (ordersData) => api.post('/orders/batch', { orders: ordersData }),
@@ -83,7 +114,7 @@ const OrdersGrid = () => {
 
   // Batch assign driver mutation
   const batchAssignMutation = useMutation(
-    ({ orderIds, driverId }) => api.patch('/orders/batch/assign', { order_ids: orderIds, driver_id: driverId }),
+    ({ orderIds, driverId }) => api.patch('/orders/assign', { order_ids: orderIds, driver_id: driverId }),
     {
       onSuccess: (response) => {
         queryClient.invalidateQueries('orders');
@@ -98,9 +129,9 @@ const OrdersGrid = () => {
     }
   );
 
-  // Client search mutation
+  // Client search mutation (unified /clients endpoint)
   const clientSearchMutation = useMutation(
-    (query) => api.get(`/orders/clients/search?q=${encodeURIComponent(query)}`),
+    (query) => api.get('/clients', { params: { search: query } }),
     {
       onSuccess: (response) => {
         setClientSuggestions(response.data.data || []);
@@ -117,22 +148,26 @@ const OrdersGrid = () => {
   const addNewRow = () => {
     const newRow = {
       id: `new-${Date.now()}`,
-      order_ref: '',
-      brand_name: '',
-      customer_name: '',
-      customer_phone: '',
-      location_text: '',
+      client: '',
+      phone: '',
+      customer: '',
+      address: '',
       google_maps_url: '',
       latitude: '',
       longitude: '',
       price_usd: '',
       price_lbp: '',
-      fee_usd: '',
-      fee_lbp: '',
-      delivery_type: 'direct',
-      delivery_mode: 'in_house',
+      delivery_fees_usd: '',
+      delivery_fees_lbp: '',
+      order_type: 'ecommerce',
+      delivery_mode: 'direct',
       third_party_id: '',
-      prepaid_status: 'unpaid',
+      third_party_fee_usd: '',
+      third_party_fee_lbp: '',
+      driver_id: '',
+      payment_status: 'unpaid',
+      order_status: 'new',
+      note: '',
       isNew: true
     };
     setNewRows(prev => [...prev, newRow]);
@@ -154,11 +189,25 @@ const OrdersGrid = () => {
 
   // Handle client name change with autocomplete
   const handleClientNameChange = (rowId, value) => {
-    updateRowData(rowId, 'customer_name', value);
+    updateRowData(rowId, 'client', value);
     
     if (value.length >= 2) {
       clientSearchMutation.mutate(value);
       setSuggestionIndex(rowId);
+      setActiveSuggestionField('client');
+    } else {
+      setShowClientSuggestions(false);
+    }
+  };
+
+  // Handle phone change with autocomplete
+  const handlePhoneChange = (rowId, value) => {
+    updateRowData(rowId, 'phone', value);
+    const digits = (value || '').replace(/\D+/g, '');
+    if (digits.length >= 5) {
+      clientSearchMutation.mutate(value);
+      setSuggestionIndex(rowId);
+      setActiveSuggestionField('phone');
     } else {
       setShowClientSuggestions(false);
     }
@@ -166,9 +215,27 @@ const OrdersGrid = () => {
 
   // Select client from suggestions
   const selectClient = (rowId, client) => {
-    updateRowData(rowId, 'customer_name', client.business_name);
-    updateRowData(rowId, 'customer_phone', client.phone);
-    updateRowData(rowId, 'location_text', client.address);
+    updateRowData(rowId, 'client', client.business_name || client.name || '');
+    updateRowData(rowId, 'phone', client.phone || '');
+    updateRowData(rowId, 'address', client.address || client.location || '');
+    if (client.default_delivery_fee_usd) updateRowData(rowId, 'delivery_fees_usd', String(client.default_delivery_fee_usd));
+    if (client.default_delivery_fee_lbp) updateRowData(rowId, 'delivery_fees_lbp', String(client.default_delivery_fee_lbp));
+    // Autofill google map link/coordinates if available
+    if (client.google_location) {
+      const loc = String(client.google_location);
+      if (/^https?:\/\//i.test(loc)) {
+        updateRowData(rowId, 'google_maps_url', loc);
+        const coords = parseGoogleMapsUrl(loc);
+        if (coords) {
+          updateRowData(rowId, 'latitude', coords.latitude.toString());
+          updateRowData(rowId, 'longitude', coords.longitude.toString());
+        }
+      } else if (/^-?\d+\.\d+\s*,\s*-?\d+\.\d+$/.test(loc)) {
+        const [lat, lng] = loc.split(',').map(s => s.trim());
+        updateRowData(rowId, 'latitude', lat);
+        updateRowData(rowId, 'longitude', lng);
+      }
+    }
     setShowClientSuggestions(false);
   };
 
@@ -196,8 +263,10 @@ const OrdersGrid = () => {
 
   // Submit new rows
   const submitNewRows = () => {
-    const validRows = newRows.filter(row => 
-      row.customer_name && (row.price_usd || row.price_lbp)
+    const targetRows = newRows.filter(r => selectedRows.has(r.id));
+    const rowsToSubmit = targetRows.length > 0 ? targetRows : newRows;
+    const validRows = rowsToSubmit.filter(row => 
+      row.client && row.customer && (row.price_usd || row.price_lbp)
     );
 
     if (validRows.length === 0) {
@@ -206,20 +275,25 @@ const OrdersGrid = () => {
     }
 
     const ordersData = validRows.map(row => ({
-      customer_name: row.customer_name,
-      customer_phone: row.customer_phone,
-      location_text: row.location_text,
+      brand_name: row.client,
+      customer_name: row.customer,
+      customer_phone: row.phone,
+      customer_address: row.address,
       latitude: row.latitude ? parseFloat(row.latitude) : null,
       longitude: row.longitude ? parseFloat(row.longitude) : null,
       total_usd: parseFloat(row.price_usd) || 0,
       total_lbp: parseInt(row.price_lbp) || 0,
-      delivery_fee_usd: parseFloat(row.fee_usd) || 0,
-      delivery_fee_lbp: parseInt(row.fee_lbp) || 0,
+      delivery_fee_usd: parseFloat(row.delivery_fees_usd) || 0,
+      delivery_fee_lbp: parseInt(row.delivery_fees_lbp) || 0,
+      type: row.order_type,
       delivery_mode: row.delivery_mode,
-      third_party_id: row.third_party_id || null,
-      prepaid_status: row.prepaid_status,
-      status: 'new',
-      payment_status: 'unpaid'
+      third_party_id: row.delivery_mode === 'third_party' ? (row.third_party_id || null) : null,
+      third_party_fee_usd: row.delivery_mode === 'third_party' ? (parseFloat(row.third_party_fee_usd) || 0) : 0,
+      third_party_fee_lbp: row.delivery_mode === 'third_party' ? (parseInt(row.third_party_fee_lbp) || 0) : 0,
+      driver_id: row.driver_id ? parseInt(row.driver_id) : null,
+      payment_status: row.payment_status,
+      status: row.order_status,
+      notes: row.note || ''
     }));
 
     batchCreateMutation.mutate(ordersData);
@@ -292,7 +366,7 @@ const OrdersGrid = () => {
   // Generate Google Maps link
   const generateGoogleMapsLink = (latitude, longitude) => {
     if (latitude && longitude) {
-      return `https://www.google.com/maps?q=${latitude},${longitude}`;
+      return `https://www.google.com/maps/search/?api=1&query=${latitude},${longitude}`;
     }
     return null;
   };
@@ -304,7 +378,7 @@ const OrdersGrid = () => {
         currency: 'USD',
       }).format(amount || 0);
     } else if (currency === 'LBP') {
-      return new Intl.NumberFormat('ar-LB', {
+      return new Intl.NumberFormat('en-US', {
         style: 'currency',
         currency: 'LBP',
       }).format(amount || 0);
@@ -346,60 +420,66 @@ const OrdersGrid = () => {
   const allRows = [...(orders || []), ...newRows];
 
   return (
-    <div className="container mx-auto px-4 py-8">
+    <div className="container mx-auto px-2 py-4">
       <div className="flex justify-between items-center mb-6">
-        <h1 className="text-3xl font-bold text-gray-900">Orders Grid</h1>
-        <div className="flex items-center space-x-3">
+        <h1 className="text-2xl font-bold text-gray-900">Orders Grid</h1>
+        <div className="flex items-center space-x-2">
           <button
             onClick={addNewRow}
-            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
+            className="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-md flex items-center gap-2 transition-colors text-sm"
           >
             <Plus className="w-5 h-5" />
             Add Row
           </button>
-          {selectedRows.size > 0 && (
-            <div className="flex items-center space-x-2">
-              <select
-                onChange={(e) => batchAssignDriver(e.target.value)}
-                className="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
-                defaultValue=""
-              >
-                <option value="">Assign Driver to Selected</option>
-                {drivers?.map(driver => (
-                  <option key={driver.id} value={driver.id}>
-                    {driver.full_name}
-                  </option>
-                ))}
-              </select>
-              <button
-                onClick={deselectAllRows}
-                className="text-gray-500 hover:text-gray-700"
-              >
-                <X className="w-4 h-4" />
-              </button>
-            </div>
-          )}
+          <div className="flex items-center space-x-2">
+            <select
+              onChange={(e) => e.target.value && batchAssignDriver(e.target.value)}
+              className="px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
+              defaultValue=""
+            >
+              <option value="">Assign driverΓÇª</option>
+              {drivers?.map(driver => (
+                <option key={driver.id} value={driver.id}>
+                  {driver.full_name}
+                </option>
+              ))}
+            </select>
+            <button
+              onClick={() => (selectedRows.size === allRows.length ? deselectAllRows() : selectAllRows())}
+              className="px-2 py-1 border border-gray-300 rounded-md text-sm"
+            >
+              {selectedRows.size === allRows.length ? 'Deselect All' : 'Select All'}
+            </button>
+            <button
+              onClick={submitNewRows}
+              disabled={batchCreateMutation.isLoading}
+              className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-sm disabled:opacity-50"
+            >
+              Submit Selected
+            </button>
+          </div>
         </div>
       </div>
 
       {/* Search and Filters */}
-      <div className="bg-white rounded-lg shadow-md p-6 mb-6">
-        <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
+      <div className="bg-white rounded-lg shadow-md p-3 mb-4">
+        <div className="grid grid-cols-1 md:grid-cols-7 gap-2">
           <div>
             <input
               type="text"
               placeholder="Search orders..."
               value={searchTerm}
               onChange={(e) => setSearchTerm(e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              className="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
             />
           </div>
           <div>
             <select
               value={selectedStatus}
               onChange={(e) => setSelectedStatus(e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              className="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
             >
+              <option value="!cancelled">All Except Cancelled</option>
               <option value="">All Statuses</option>
               <option value="new">New</option>
               <option value="assigned">Assigned</option>
@@ -414,7 +494,7 @@ const OrdersGrid = () => {
             <select
               value={selectedBrand}
               onChange={(e) => setSelectedBrand(e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              className="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
             >
               <option value="">All Brands</option>
               {/* Add brand options here */}
@@ -424,7 +504,7 @@ const OrdersGrid = () => {
             <select
               value={selectedType}
               onChange={(e) => setSelectedType(e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              className="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
             >
               <option value="">All Types</option>
               <option value="ecommerce">E-commerce</option>
@@ -432,12 +512,23 @@ const OrdersGrid = () => {
               <option value="go_to_market">Go to Market</option>
             </select>
           </div>
+          <div>
+            <select
+              value={selectedDeliveryMode}
+              onChange={(e) => setSelectedDeliveryMode(e.target.value)}
+              className="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
+            >
+              <option value="">All Delivery</option>
+              <option value="direct">In House</option>
+              <option value="third_party">Third Party</option>
+            </select>
+          </div>
           <div>
             <input
               type="date"
               value={dateFrom}
               onChange={(e) => setDateFrom(e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              className="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
             />
           </div>
           <div>
@@ -445,7 +536,7 @@ const OrdersGrid = () => {
               type="date"
               value={dateTo}
               onChange={(e) => setDateTo(e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              className="w-full px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
             />
           </div>
         </div>
@@ -457,7 +548,7 @@ const OrdersGrid = () => {
           <table className="min-w-full divide-y divide-gray-200">
             <thead className="bg-gray-50">
               <tr>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-8">
                   <button
                     onClick={selectedRows.size === allRows.length ? deselectAllRows : selectAllRows}
                     className="text-gray-400 hover:text-gray-600"
@@ -469,51 +560,30 @@ const OrdersGrid = () => {
                     )}
                   </button>
                 </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Brand
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Client
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Phone
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Location
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Google Maps
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Price USD
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Price LBP
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Fee USD
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Fee LBP
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Delivery
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Prepaid
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Status
-                </th>
-                <th className="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Actions
-                </th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price USD</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price LBP</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Delivery Fees USD</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Delivery Fees LBP</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Type</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Delivery Mode</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">3rd Party</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">3rd Fee USD</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">3rd Fee LBP</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Driver</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Note</th>
+                <th className="px-1 py-1.5 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
               </tr>
             </thead>
             <tbody className="bg-white divide-y divide-gray-200">
               {allRows.map((row) => (
                 <tr key={row.id} className={`hover:bg-gray-50 ${row.isNew ? 'bg-green-50' : ''}`}>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     <button
                       onClick={() => toggleRowSelection(row.id)}
                       className="text-gray-400 hover:text-gray-600"
@@ -525,38 +595,25 @@ const OrdersGrid = () => {
                       )}
                     </button>
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
-                    {row.isNew ? (
-                      <input
-                        type="text"
-                        value={row.brand_name}
-                        onChange={(e) => updateRowData(row.id, 'brand_name', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
-                        placeholder="Brand"
-                      />
-                    ) : (
-                      <div className="text-sm text-gray-900">{row.brand_name}</div>
-                    )}
-                  </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <div className="relative">
                         <input
                           type="text"
-                          value={row.customer_name}
+                          value={row.client}
                           onChange={(e) => handleClientNameChange(row.id, e.target.value)}
-                          className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
-                          placeholder="Client Name"
+                          className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          placeholder="Client"
                         />
-                        {showClientSuggestions && suggestionIndex === row.id && clientSuggestions.length > 0 && (
+                        {showClientSuggestions && suggestionIndex === row.id && activeSuggestionField === 'client' && clientSuggestions.length > 0 && (
                           <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
                             {clientSuggestions.map((client, index) => (
                               <div
                                 key={client.id}
                                 onClick={() => selectClient(row.id, client)}
-                                className="px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm"
+                                className="px-2 py-1 hover:bg-gray-100 cursor-pointer text-xs"
                               >
-                                <div className="font-medium">{client.business_name}</div>
+                                <div className="font-medium">{client.business_name || client.name}</div>
                                 <div className="text-gray-500">{client.phone}</div>
                               </div>
                             ))}
@@ -564,166 +621,350 @@ const OrdersGrid = () => {
                         )}
                       </div>
                     ) : (
-                      <div className="text-sm text-gray-900">{row.customer_name}</div>
+                      <div className="text-xs text-gray-900">{row.brand_name}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
-                      <input
-                        type="tel"
-                        value={row.customer_phone}
-                        onChange={(e) => updateRowData(row.id, 'customer_phone', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
-                        placeholder="Phone"
-                      />
+                      <div className="relative">
+                        <input
+                          type="tel"
+                          value={row.phone}
+                          onChange={(e) => handlePhoneChange(row.id, e.target.value)}
+                          className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          placeholder="Phone"
+                        />
+                        {showClientSuggestions && suggestionIndex === row.id && activeSuggestionField === 'phone' && clientSuggestions.length > 0 && (
+                          <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto">
+                            {clientSuggestions.map((client) => (
+                              <div
+                                key={client.id}
+                                onClick={() => selectClient(row.id, client)}
+                                className="px-2 py-1 hover:bg-gray-100 cursor-pointer text-xs"
+                              >
+                                <div className="font-medium">{client.phone}</div>
+                                <div className="text-gray-500">{client.business_name || client.name}</div>
+                              </div>
+                            ))}
+                          </div>
+                        )}
+                      </div>
                     ) : (
-                      <div className="text-sm text-gray-900">{row.customer_phone}</div>
+                      <div className="text-xs text-gray-900">{row.customer_phone}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <input
                         type="text"
-                        value={row.location_text}
-                        onChange={(e) => updateRowData(row.id, 'location_text', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
-                        placeholder="Location"
+                        value={row.customer}
+                        onChange={(e) => updateRowData(row.id, 'customer', e.target.value)}
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        placeholder="Customer full name"
                       />
                     ) : (
-                      <div className="text-sm text-gray-900">
-                        {row.location_text}
-                        {row.latitude && row.longitude && (
-                          <a
-                            href={generateGoogleMapsLink(row.latitude, row.longitude)}
-                            target="_blank"
-                            rel="noopener noreferrer"
-                            className="ml-2 text-blue-600 hover:text-blue-800"
-                          >
-                            <Map className="w-4 h-4 inline" />
-                          </a>
-                        )}
-                      </div>
+                      <div className="text-xs text-gray-900">{row.customer_name}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <input
-                        type="url"
-                        value={row.google_maps_url}
-                        onChange={(e) => handleGoogleMapsUrlChange(row.id, e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
-                        placeholder="Paste Google Maps URL"
+                        type="text"
+                        value={row.address}
+                        onChange={(e) => updateRowData(row.id, 'address', e.target.value)}
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        placeholder="Address"
                       />
                     ) : (
-                      <div className="text-sm text-gray-900">
-                        {row.latitude && row.longitude ? (
-                          <a
-                            href={generateGoogleMapsLink(row.latitude, row.longitude)}
-                            target="_blank"
-                            rel="noopener noreferrer"
-                            className="text-blue-600 hover:text-blue-800 flex items-center gap-1"
-                          >
-                            <Map className="w-4 h-4" />
-                            View Map
-                          </a>
-                        ) : (
-                          <span className="text-gray-400">No coordinates</span>
-                        )}
-                      </div>
+                      editingRow === row.id ? (
+                        <input
+                          type="text"
+                          defaultValue={row.customer_address}
+                          onBlur={(e) => updateOrderMutation.mutate({ id: row.id, data: { customer_address: e.target.value } })}
+                          className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        />
+                      ) : (
+                        <div className="text-xs text-gray-900">{row.customer_address}</div>
+                      )
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <input
                         type="number"
                         step="0.01"
                         value={row.price_usd}
                         onChange={(e) => updateRowData(row.id, 'price_usd', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                         placeholder="0.00"
                       />
                     ) : (
-                      <div className="text-sm text-gray-900">{formatCurrency(row.total_usd, 'USD')}</div>
+                      <div className="text-xs text-gray-900">{formatCurrency(row.total_usd, 'USD')}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <input
                         type="number"
                         value={row.price_lbp}
                         onChange={(e) => updateRowData(row.id, 'price_lbp', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                         placeholder="0"
                       />
                     ) : (
-                      <div className="text-sm text-gray-900">{formatCurrency(row.total_lbp, 'LBP')}</div>
+                      <div className="text-xs text-gray-900">{formatCurrency(row.total_lbp, 'LBP')}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <input
                         type="number"
                         step="0.01"
-                        value={row.fee_usd}
-                        onChange={(e) => updateRowData(row.id, 'fee_usd', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        value={row.delivery_fees_usd}
+                        onChange={(e) => updateRowData(row.id, 'delivery_fees_usd', e.target.value)}
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                         placeholder="0.00"
                       />
                     ) : (
-                      <div className="text-sm text-gray-900">{formatCurrency(row.delivery_fee_usd, 'USD')}</div>
+                      <div className="text-xs text-gray-900">{formatCurrency(row.delivery_fee_usd, 'USD')}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <input
                         type="number"
-                        value={row.fee_lbp}
-                        onChange={(e) => updateRowData(row.id, 'fee_lbp', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        value={row.delivery_fees_lbp}
+                        onChange={(e) => updateRowData(row.id, 'delivery_fees_lbp', e.target.value)}
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                         placeholder="0"
                       />
                     ) : (
-                      <div className="text-sm text-gray-900">{formatCurrency(row.delivery_fee_lbp, 'LBP')}</div>
+                      <div className="text-xs text-gray-900">{formatCurrency(row.delivery_fee_lbp, 'LBP')}</div>
+                    )}
+                  </td>
+                  <td className="px-1 py-1 whitespace-nowrap">
+                    {row.isNew ? (
+                      <select
+                        value={row.order_type}
+                        onChange={(e) => updateRowData(row.id, 'order_type', e.target.value)}
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                      >
+                        <option value="ecommerce">ecommerce</option>
+                        <option value="instant">instant</option>
+                        <option value="go_to_market">go_to_market</option>
+                      </select>
+                    ) : (
+                      <div className="text-xs text-gray-900">{row.type}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <select
                         value={row.delivery_mode}
                         onChange={(e) => updateRowData(row.id, 'delivery_mode', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                       >
-                        <option value="in_house">In House</option>
-                        <option value="third_party">Third Party</option>
+                        <option value="direct">direct</option>
+                        <option value="third_party">third_party</option>
                       </select>
                     ) : (
-                      <div className="text-sm text-gray-900">{row.delivery_mode}</div>
+                      <div className="text-xs text-gray-900">{row.delivery_mode}</div>
+                    )}
+                  </td>
+                  {/* Third party fields - conditionally visible */}
+                  <td className="px-1 py-1 whitespace-nowrap">
+                    {row.isNew ? (
+                      row.delivery_mode === 'third_party' ? (
+                        <input
+                          type="text"
+                          value={row.third_party_id}
+                          onChange={(e) => updateRowData(row.id, 'third_party_id', e.target.value)}
+                          className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          placeholder="3rd party id"
+                        />
+                      ) : (
+                        <div className="text-gray-400 text-xs">ΓÇö</div>
+                      )
+                    ) : (
+                      row.delivery_mode === 'third_party' ? (
+                        editingRow === row.id ? (
+                          <input
+                            type="text"
+                            defaultValue={row.third_party_id || ''}
+                            onBlur={(e) => updateOrderMutation.mutate({ id: row.id, data: { third_party_id: e.target.value } })}
+                            className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          />
+                        ) : (
+                          <div className="text-xs text-gray-900">{row.third_party_id || 'ΓÇö'}</div>
+                        )
+                      ) : (
+                        <div className="text-gray-400 text-xs">ΓÇö</div>
+                      )
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
+                    {row.isNew ? (
+                      row.delivery_mode === 'third_party' ? (
+                        <input
+                          type="number"
+                          step="0.01"
+                          value={row.third_party_fee_usd}
+                          onChange={(e) => updateRowData(row.id, 'third_party_fee_usd', e.target.value)}
+                          className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          placeholder="0.00"
+                        />
+                      ) : (
+                        <div className="text-gray-400 text-xs">ΓÇö</div>
+                      )
+                    ) : (
+                      row.delivery_mode === 'third_party' ? (
+                        editingRow === row.id ? (
+                          <input
+                            type="number"
+                            step="0.01"
+                            defaultValue={row.third_party_fee_usd || 0}
+                            onBlur={(e) => updateOrderMutation.mutate({ id: row.id, data: { third_party_fee_usd: parseFloat(e.target.value) || 0 } })}
+                            className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          />
+                        ) : (
+                          <div className="text-xs text-gray-900">{formatCurrency(row.third_party_fee_usd, 'USD')}</div>
+                        )
+                      ) : (
+                        <div className="text-gray-400 text-xs">ΓÇö</div>
+                      )
+                    )}
+                  </td>
+                  <td className="px-1 py-1 whitespace-nowrap">
+                    {row.isNew ? (
+                      row.delivery_mode === 'third_party' ? (
+                        <input
+                          type="number"
+                          value={row.third_party_fee_lbp}
+                          onChange={(e) => updateRowData(row.id, 'third_party_fee_lbp', e.target.value)}
+                          className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          placeholder="0"
+                        />
+                      ) : (
+                        <div className="text-gray-400 text-xs">ΓÇö</div>
+                      )
+                    ) : (
+                      row.delivery_mode === 'third_party' ? (
+                        editingRow === row.id ? (
+                          <input
+                            type="number"
+                            defaultValue={row.third_party_fee_lbp || 0}
+                            onBlur={(e) => updateOrderMutation.mutate({ id: row.id, data: { third_party_fee_lbp: parseInt(e.target.value) || 0 } })}
+                            className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          />
+                        ) : (
+                          <div className="text-xs text-gray-900">{formatCurrency(row.third_party_fee_lbp, 'LBP')}</div>
+                        )
+                      ) : (
+                        <div className="text-gray-400 text-xs">ΓÇö</div>
+                      )
+                    )}
+                  </td>
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
                       <select
-                        value={row.prepaid_status}
-                        onChange={(e) => updateRowData(row.id, 'prepaid_status', e.target.value)}
-                        className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        value={row.driver_id}
+                        onChange={(e) => updateRowData(row.id, 'driver_id', e.target.value)}
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
                       >
-                        <option value="unpaid">Unpaid</option>
-                        <option value="paid">Paid</option>
+                        <option value="">ΓÇö</option>
+                        {drivers?.map(driver => (
+                          <option key={driver.id} value={driver.id}>{driver.full_name}</option>
+                        ))}
                       </select>
                     ) : (
-                      <div className="text-sm text-gray-900">{row.prepaid_status}</div>
+                      <div className="text-xs text-gray-900">{row.driver_name || 'ΓÇö'}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap">
+                  <td className="px-1 py-1 whitespace-nowrap">
                     {row.isNew ? (
-                      <div className="text-sm text-green-600 font-medium">New</div>
+                      row.delivery_mode === 'third_party' ? (
+                        <select
+                          value={row.payment_status}
+                          onChange={(e) => updateRowData(row.id, 'payment_status', e.target.value)}
+                          className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        >
+                          <option value="prepaid">prepaid</option>
+                          <option value="paid">paid</option>
+                          <option value="unpaid">unpaid</option>
+                        </select>
+                      ) : (
+                        <div className="text-gray-400 text-xs">ΓÇö</div>
+                      )
+                    ) : (
+                      row.delivery_mode === 'third_party' ? (
+                        editingRow === row.id ? (
+                          <select
+                            defaultValue={row.payment_status}
+                            onBlur={(e) => updateOrderMutation.mutate({ id: row.id, data: { payment_status: e.target.value } })}
+                            className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                          >
+                            <option value="prepaid">prepaid</option>
+                            <option value="paid">paid</option>
+                            <option value="unpaid">unpaid</option>
+                          </select>
+                        ) : (
+                          <div className="text-xs text-gray-900">{row.payment_status}</div>
+                        )
+                      ) : (
+                        <div className="text-gray-400 text-xs">ΓÇö</div>
+                      )
+                    )}
+                  </td>
+                  <td className="px-1 py-1 whitespace-nowrap">
+                    {row.isNew ? (
+                      <select
+                        value={row.order_status}
+                        onChange={(e) => updateRowData(row.id, 'order_status', e.target.value)}
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                      >
+                        <option value="onshelf">onshelf</option>
+                        <option value="on_road">on_road</option>
+                        <option value="delivered">delivered</option>
+                        <option value="canceled">canceled</option>
+                        <option value="postponed">postponed</option>
+                        <option value="completed">completed</option>
+                      </select>
+                    ) : (
+                      editingRow === row.id ? (
+                        <select
+                          defaultValue={row.status}
+                          onBlur={(e) => updateOrderMutation.mutate({ id: row.id, data: { status: e.target.value } })}
+                          className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        >
+                          <option value="new">new</option>
+                          <option value="assigned">assigned</option>
+                          <option value="picked_up">picked_up</option>
+                          <option value="in_transit">in_transit</option>
+                          <option value="delivered">delivered</option>
+                          <option value="completed">completed</option>
+                          <option value="cancelled">cancelled</option>
+                        </select>
+                      ) : (
+                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(row.status)}`}>
+                          {row.status}
+                        </span>
+                      )
+                    )}
+                  </td>
+                  <td className="px-1 py-1 whitespace-nowrap">
+                    {row.isNew ? (
+                      <input
+                        type="text"
+                        value={row.note}
+                        onChange={(e) => updateRowData(row.id, 'note', e.target.value)}
+                        className="w-full px-2 py-0.5 text-xs border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500"
+                        placeholder="Note"
+                      />
                     ) : (
-                      <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(row.status)}`}>
-                        {row.status}
-                      </span>
+                      <div className="text-xs text-gray-900">{row.notes || ''}</div>
                     )}
                   </td>
-                  <td className="px-2 py-2 whitespace-nowrap text-sm font-medium">
+                  <td className="px-1 py-1 whitespace-nowrap text-xs font-medium">
                     {row.isNew ? (
                       <button
                         onClick={() => removeNewRow(row.id)}
@@ -734,13 +975,15 @@ const OrdersGrid = () => {
                     ) : (
                       <div className="flex space-x-2">
                         <button
-                          onClick={() => {/* Edit functionality */}}
+                          onClick={() => setEditingRow(editingRow === row.id ? null : row.id)}
                           className="text-indigo-600 hover:text-indigo-900"
                         >
                           <Edit className="w-4 h-4" />
                         </button>
                         <button
-                          onClick={() => {/* Delete functionality */}}
+                          onClick={() => {
+                            if (window.confirm('Delete this order?')) deleteOrderMutation.mutate(row.id);
+                          }}
                           className="text-red-600 hover:text-red-900"
                         >
                           <Trash2 className="w-4 h-4" />
@@ -757,16 +1000,16 @@ const OrdersGrid = () => {
 
       {/* Submit Button for New Rows */}
       {newRows.length > 0 && (
-        <div className="mt-6 flex justify-end">
+        <div className="mt-3 flex justify-end">
           <button
             onClick={submitNewRows}
             disabled={batchCreateMutation.isLoading}
-            className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50"
+            className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded-md flex items-center gap-2 transition-colors disabled:opacity-50 text-sm"
           >
             {batchCreateMutation.isLoading ? (
-              <Loader2 className="w-5 h-5 animate-spin" />
+              <Loader2 className="w-4 h-4 animate-spin" />
             ) : (
-              <Save className="w-5 h-5" />
+              <Save className="w-4 h-4" />
             )}
             Submit {newRows.length} New Orders
           </button>
@@ -776,4 +1019,4 @@ const OrdersGrid = () => {
   );
 };
 
-export default OrdersGrid;
+export default OrdersGrid;
\ No newline at end of file
diff --git a/client/src/contexts/AuthContext.jsx b/client/src/contexts/AuthContext.jsx
index ca283e8..1886fb0 100644
--- a/client/src/contexts/AuthContext.jsx
+++ b/client/src/contexts/AuthContext.jsx
@@ -202,12 +202,22 @@ export function AuthProvider({ children }) {
           throw new Error('Failed to load user data after login');
         }
       } else {
-        console.log('Γ¥î AuthContext: No token received, clearing state...');
-        // ensure state consistent
-        safeLocalRemove("token");
-        setToken(null);
-        setUser(null);
-        setIsAuthenticated(false);
+        // Support cookie-only auth: if server sets httpOnly cookie and returns user or allows /me
+        console.log('Γä╣∩╕Å AuthContext: No token received, attempting cookie-based auth...');
+        if (!newUser) {
+          newUser = await fetchMe(null);
+        }
+        if (newUser) {
+          console.log('Γ£à AuthContext: Cookie-based login succeeded');
+          setUser(newUser);
+          setIsAuthenticated(true);
+        } else {
+          console.log('Γ¥î AuthContext: Cookie-based login failed, clearing state...');
+          safeLocalRemove("token");
+          setToken(null);
+          setUser(null);
+          setIsAuthenticated(false);
+        }
       }
 
       const result = { token: newToken, user: newUser };
diff --git a/client/src/contexts/SocketContext.jsx b/client/src/contexts/SocketContext.jsx
index 6179042..7954f09 100644
--- a/client/src/contexts/SocketContext.jsx
+++ b/client/src/contexts/SocketContext.jsx
@@ -31,9 +31,9 @@ export const SocketProvider = ({ children, socket }) => {
       }
     };
 
-    const handleDisconnect = () => {
+    const handleDisconnect = (reason) => {
       setIsConnected(false);
-      console.log('Socket disconnected');
+      console.warn('Socket disconnected:', reason);
     };
 
     const handleOrderUpdate = (data) => {
@@ -69,6 +69,9 @@ export const SocketProvider = ({ children, socket }) => {
     socket.on('driver-update', handleDriverUpdate);
     socket.on('transaction-update', handleTransactionUpdate);
     socket.on('error', handleError);
+    socket.on('connect_error', (err) => {
+      console.error('Socket connect_error:', err?.message || err);
+    });
 
     // Cleanup
     return () => {
diff --git a/client/src/pages/Accounting.jsx b/client/src/pages/Accounting.jsx
index 5d8c110..3093ab9 100644
--- a/client/src/pages/Accounting.jsx
+++ b/client/src/pages/Accounting.jsx
@@ -37,6 +37,9 @@ const Accounting = () => {
   const [isTransactionModalOpen, setIsTransactionModalOpen] = useState(false);
   const [isReceiptModalOpen, setIsReceiptModalOpen] = useState(false);
   const [selectedTransaction, setSelectedTransaction] = useState(null);
+  const [entityStatus, setEntityStatus] = useState('');
+  const [showCashoutModal, setShowCashoutModal] = useState(false);
+  const [cashoutData, setCashoutData] = useState({ amount_usd: 0, amount_lbp: 0, description: '' });
 
   const queryClient = useQueryClient();
 
@@ -53,7 +56,8 @@ const Accounting = () => {
         return res.data?.data || [];
       }
       if (selectedView === 'third_parties') {
-        const res = await api.get('/accounting/thirdparties', { params: { from_date: dateRange.from, to_date: dateRange.to, search: searchTerm } });
+        // Backend route is singular: /accounting/thirdparty
+        const res = await api.get('/accounting/thirdparty', { params: { from_date: dateRange.from, to_date: dateRange.to, search: searchTerm } });
         return res.data?.data || [];
       }
       // Fallback to overview endpoint already available
@@ -64,20 +68,21 @@ const Accounting = () => {
   );
 
   // Fetch entity details when selected
-  const { data: entityDetails } = useQuery(
-    ['accounting-entity', selectedView, selectedEntity?.id || selectedEntity?.name, dateRange],
+  const { data: entityDetails, refetch: refetchEntity } = useQuery(
+    ['accounting-entity', selectedView, selectedEntity?.id || selectedEntity?.name, dateRange, entityStatus],
     async () => {
       if (!selectedEntity) return null;
       if (selectedView === 'clients') {
-        const res = await api.get(`/accounting/clients/${selectedEntity.id}`, { params: { from_date: dateRange.from, to_date: dateRange.to } });
+        const res = await api.get(`/accounting/clients/${selectedEntity.id}`, { params: { from_date: dateRange.from, to_date: dateRange.to, status: entityStatus } });
         return res.data?.data;
       }
       if (selectedView === 'drivers') {
-        const res = await api.get(`/accounting/drivers/${selectedEntity.id}`, { params: { from_date: dateRange.from, to_date: dateRange.to } });
+        const res = await api.get(`/accounting/drivers/${selectedEntity.id}`, { params: { from_date: dateRange.from, to_date: dateRange.to, status: entityStatus } });
         return res.data?.data;
       }
       if (selectedView === 'third_parties') {
-        const res = await api.get(`/accounting/thirdparties/${selectedEntity.name}`, { params: { from_date: dateRange.from, to_date: dateRange.to } });
+        // Backend route is singular: /accounting/thirdparty/:name
+        const res = await api.get(`/accounting/thirdparty/${selectedEntity.name}`, { params: { from_date: dateRange.from, to_date: dateRange.to, status: entityStatus } });
         return res.data?.data;
       }
       return null;
@@ -121,16 +126,8 @@ const Accounting = () => {
 
   const downloadStatement = async (actorType, actorId, format = 'csv') => {
     try {
-      let endpoint = '';
-      if (actorType === 'client') {
-        endpoint = `/accounting/clients/${actorId}/export/${format}`;
-      } else if (actorType === 'driver') {
-        endpoint = `/accounting/drivers/${actorId}/export/${format}`;
-      } else if (actorType === 'third_party') {
-        endpoint = `/accounting/thirdparties/${actorId}/export/${format}`;
-      }
-      
-      const response = await api.get(endpoint, {
+      // Use centralized export endpoint already implemented server-side
+      const response = await api.get('/accounting/export', {
         params: { from_date: dateRange.from, to_date: dateRange.to },
         responseType: 'blob'
       });
@@ -162,6 +159,31 @@ const Accounting = () => {
     }
   };
 
+  // Calculate cashout amounts based on entity type and orders
+  const calculateCashoutAmounts = (entityType, orders) => {
+    if (!orders || !Array.isArray(orders)) return { amount_usd: 0, amount_lbp: 0 };
+
+    return orders.reduce((totals, order) => {
+      const calculatedTotals = calculateDisplayedTotals(order);
+      
+      if (entityType === 'clients') {
+        // For clients: full displayed amount goes to cashbox
+        totals.amount_usd += calculatedTotals.displayedTotalUSD;
+        totals.amount_lbp += calculatedTotals.displayedTotalLBP;
+      } else if (entityType === 'drivers') {
+        // For drivers: only driver fee goes to cashbox
+        totals.amount_usd += parseFloat(order.driver_fee_usd || 0);
+        totals.amount_lbp += parseInt(order.driver_fee_lbp || 0);
+      } else if (entityType === 'third_parties') {
+        // For third parties: only driver fee goes to cashbox (your driver fee)
+        totals.amount_usd += parseFloat(order.driver_fee_usd || 0);
+        totals.amount_lbp += parseInt(order.driver_fee_lbp || 0);
+      }
+      
+      return totals;
+    }, { amount_usd: 0, amount_lbp: 0 });
+  };
+
   // Cashout actions
   const cashoutMutation = useMutation(
     async ({ scope, idOrName, amount_usd = 0, amount_lbp = 0, description }) => {
@@ -170,13 +192,18 @@ const Accounting = () => {
       } else if (scope === 'drivers') {
         return api.post(`/accounting/drivers/${idOrName}/cashout`, { amount_usd, amount_lbp, description });
       } else if (scope === 'third_parties') {
-        return api.post(`/accounting/thirdparties/${idOrName}/cashout`, { amount_usd, amount_lbp, description });
+        return api.post(`/accounting/thirdparty/${idOrName}/cashout`, { amount_usd, amount_lbp, description });
       }
     },
     {
-      onSuccess: () => {
-        toast.success('Cashout completed');
+      onSuccess: (_resp, variables) => {
+        toast.success('Cashout completed and moved to Order History');
+        setShowCashoutModal(false);
+        setCashoutData({ amount_usd: 0, amount_lbp: 0, description: '' });
         refetch();
+        queryClient.invalidateQueries(['accounting']);
+        queryClient.invalidateQueries(['orderHistory']);
+        // Optionally refetch OrderHistory related queries if used elsewhere
       },
       onError: (e) => toast.error(e.response?.data?.message || 'Cashout failed')
     }
@@ -230,12 +257,76 @@ const Accounting = () => {
     return Array.isArray(listData) ? listData : [];
   };
 
+  // Calculate displayed totals based on business logic
+  const calculateDisplayedTotals = (order) => {
+    const {
+      total_usd = 0,
+      total_lbp = 0,
+      delivery_fees_usd = 0,
+      delivery_fees_lbp = 0,
+      third_party_fee_usd = 0,
+      third_party_fee_lbp = 0,
+      driver_fee_usd = 0,
+      driver_fee_lbp = 0,
+      deliver_method,
+      order_type
+    } = order;
+
+    let displayedTotalUSD = 0;
+    let displayedTotalLBP = 0;
+    let deliveryFeesDisplayUSD = 0;
+    let deliveryFeesDisplayLBP = 0;
+
+    if (deliver_method === 'in_house') {
+      if (order_type === 'ecommerce' || order_type === 'go-to-market') {
+        // Display order total = base totals
+        displayedTotalUSD = parseFloat(total_usd);
+        displayedTotalLBP = parseInt(total_lbp);
+        // Display delivery fees = only delivery fees (no third party)
+        deliveryFeesDisplayUSD = parseFloat(delivery_fees_usd);
+        deliveryFeesDisplayLBP = parseInt(delivery_fees_lbp);
+      } else if (order_type === 'instant') {
+        // Display order total = total + driver fee
+        displayedTotalUSD = parseFloat(total_usd) + parseFloat(driver_fee_usd);
+        displayedTotalLBP = parseInt(total_lbp) + parseInt(driver_fee_lbp);
+        // Hide delivery fees column for instant orders
+        deliveryFeesDisplayUSD = 0;
+        deliveryFeesDisplayLBP = 0;
+      }
+    } else if (deliver_method === 'third_party') {
+      if (order_type === 'ecommerce' || order_type === 'go-to-market') {
+        // Display order total = total + delivery fees + third party fees
+        displayedTotalUSD = parseFloat(total_usd) + parseFloat(delivery_fees_usd) + parseFloat(third_party_fee_usd);
+        displayedTotalLBP = parseInt(total_lbp) + parseInt(delivery_fees_lbp) + parseInt(third_party_fee_lbp);
+        // Display delivery fees = delivery fees + third party fees
+        deliveryFeesDisplayUSD = parseFloat(delivery_fees_usd) + parseFloat(third_party_fee_usd);
+        deliveryFeesDisplayLBP = parseInt(delivery_fees_lbp) + parseInt(third_party_fee_lbp);
+      } else if (order_type === 'instant') {
+        // Display order total = total + driver fee + third party fees
+        displayedTotalUSD = parseFloat(total_usd) + parseFloat(driver_fee_usd) + parseFloat(third_party_fee_usd);
+        displayedTotalLBP = parseInt(total_lbp) + parseInt(driver_fee_lbp) + parseInt(third_party_fee_lbp);
+        // Hide delivery fees column for instant orders
+        deliveryFeesDisplayUSD = 0;
+        deliveryFeesDisplayLBP = 0;
+      }
+    }
+
+    return {
+      displayedTotalUSD,
+      displayedTotalLBP,
+      deliveryFeesDisplayUSD,
+      deliveryFeesDisplayLBP,
+      showDeliveryFees: order_type !== 'instant'
+    };
+  };
+
   const getTotalAmounts = (items) => {
     // Ensure items is an array before using reduce
     const itemsArray = Array.isArray(items) ? items : [];
     return itemsArray.reduce((acc, item) => {
-      acc.usd += parseFloat(item.total_usd || 0);
-      acc.lbp += parseInt(item.total_lbp || 0);
+      const totals = calculateDisplayedTotals(item);
+      acc.usd += totals.displayedTotalUSD;
+      acc.lbp += totals.displayedTotalLBP;
       return acc;
     }, { usd: 0, lbp: 0 });
   };
@@ -375,8 +466,12 @@ const Accounting = () => {
               entityDetails={entityDetails}
               onViewReceipt={handleViewReceipt}
               onDownloadStatement={downloadStatement}
-              onCashout={(payload) => cashoutMutation.mutate(payload)}
+              onCashout={() => setShowCashoutModal(true)}
               onExportImage={exportSectionAsImage}
+              entityStatus={entityStatus}
+              onChangeEntityStatus={(status) => setEntityStatus(status)}
+              calculateCashoutAmounts={calculateCashoutAmounts}
+              setCashoutData={setCashoutData}
             />
           )}
         </div>
@@ -637,6 +732,92 @@ const Accounting = () => {
           </motion.div>
         )}
       </AnimatePresence>
+
+      {/* Cashout Modal */}
+      <AnimatePresence>
+        {showCashoutModal && selectedEntity && (
+          <motion.div
+            initial={{ opacity: 0 }}
+            animate={{ opacity: 1 }}
+            exit={{ opacity: 0 }}
+            className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
+          >
+            <motion.div
+              initial={{ scale: 0.95, opacity: 0 }}
+              animate={{ scale: 1, opacity: 1 }}
+              exit={{ scale: 0.95, opacity: 0 }}
+              className="bg-white rounded-lg shadow-xl max-w-md w-full"
+            >
+              <div className="p-6">
+                <div className="flex justify-between items-center mb-4">
+                  <h3 className="text-lg font-semibold text-gray-900">Cash Out</h3>
+                  <button onClick={() => setShowCashoutModal(false)} className="text-gray-400 hover:text-gray-600">Γ£ò</button>
+                </div>
+                <div className="space-y-4">
+                  <div>
+                    <label className="block text-sm font-medium text-gray-700 mb-1">Amount (USD)</label>
+                    <input
+                      type="number"
+                      step="0.01"
+                      value={cashoutData.amount_usd}
+                      onChange={(e) => setCashoutData({ ...cashoutData, amount_usd: parseFloat(e.target.value) || 0 })}
+                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
+                      placeholder="0.00"
+                    />
+                  </div>
+                  <div>
+                    <label className="block text-sm font-medium text-gray-700 mb-1">Amount (LBP)</label>
+                    <input
+                      type="number"
+                      value={cashoutData.amount_lbp}
+                      onChange={(e) => setCashoutData({ ...cashoutData, amount_lbp: parseInt(e.target.value) || 0 })}
+                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
+                      placeholder="0"
+                    />
+                  </div>
+                  <div>
+                    <label className="block text-sm font-medium text-gray-700 mb-1">Description</label>
+                    <textarea
+                      rows={3}
+                      value={cashoutData.description}
+                      onChange={(e) => setCashoutData({ ...cashoutData, description: e.target.value })}
+                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
+                      placeholder="Cashout description..."
+                    />
+                  </div>
+                  <div className="flex gap-3 pt-2">
+                    <button
+                      type="button"
+                      onClick={() => setShowCashoutModal(false)}
+                      className="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors"
+                    >
+                      Cancel
+                    </button>
+                    <button
+                      type="button"
+                      onClick={() => {
+                        const idOrName = selectedView === 'third_parties' ? (selectedEntity?.name || '') : (selectedEntity?.id || '');
+                        if (!idOrName) return;
+                        cashoutMutation.mutate({
+                          scope: selectedView,
+                          idOrName,
+                          amount_usd: cashoutData.amount_usd,
+                          amount_lbp: cashoutData.amount_lbp,
+                          description: cashoutData.description,
+                        });
+                      }}
+                      disabled={cashoutMutation.isLoading}
+                      className="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 transition-colors"
+                    >
+                      {cashoutMutation.isLoading ? 'Processing...' : 'Cash Out'}
+                    </button>
+                  </div>
+                </div>
+              </div>
+            </motion.div>
+          </motion.div>
+        )}
+      </AnimatePresence>
     </div>
   );
 };
@@ -745,7 +926,7 @@ const OverviewView = ({ data, totalAmounts }) => {
 };
 
 // Entity List Component
-const EntityListView = ({ data, viewType, onEntitySelect, selectedEntity, entityDetails, onViewReceipt, onDownloadStatement, onCashout, onExportImage }) => {
+const EntityListView = ({ data, viewType, onEntitySelect, selectedEntity, entityDetails, onViewReceipt, onDownloadStatement, onCashout, onExportImage, entityStatus, onChangeEntityStatus, calculateCashoutAmounts, setCashoutData }) => {
   const getEntityIcon = (type) => {
     switch (type) {
       case 'clients': return Users;
@@ -770,12 +951,20 @@ const EntityListView = ({ data, viewType, onEntitySelect, selectedEntity, entity
   const sectionRef = useRef(null);
 
   const handleCashout = () => {
-    if (!selectedEntity) return;
-    const amount_usd = parseFloat(prompt('Enter cashout amount in USD (0 if none):', '0')) || 0;
-    const amount_lbp = parseInt(prompt('Enter cashout amount in LBP (0 if none):', '0')) || 0;
-    const description = prompt('Optional description:', 'Cashout');
-    const idOrName = viewType === 'third_parties' ? selectedEntity.name : selectedEntity.id;
-    onCashout({ scope: viewType, idOrName, amount_usd, amount_lbp, description });
+    if (!selectedEntity || !entityDetails?.orders) return;
+    
+    // Calculate cashout amounts based on entity type and orders
+    const calculatedAmounts = calculateCashoutAmounts(viewType, entityDetails.orders);
+    
+    // Pre-fill the cashout modal with calculated amounts
+    setCashoutData({
+      amount_usd: calculatedAmounts.amount_usd,
+      amount_lbp: calculatedAmounts.amount_lbp,
+      description: `Cashout for ${selectedEntity.name || selectedEntity.business_name}`
+    });
+    
+    // Show the cashout modal
+    onCashout();
   };
 
   return (
@@ -783,48 +972,62 @@ const EntityListView = ({ data, viewType, onEntitySelect, selectedEntity, entity
       {/* Entity List */}
       <div className="lg:col-span-1">
         <h3 className="text-lg font-semibold mb-4">{entityTitle}s</h3>
-        <div className="space-y-2 max-h-96 overflow-y-auto">
-          {data.map((entity) => (
-            <motion.button
-              key={entity.id}
-              onClick={() => onEntitySelect(entity)}
-              className={`w-full p-4 text-left rounded-lg border transition-colors ${
-                selectedEntity?.id === entity.id
-                  ? 'border-blue-500 bg-blue-50'
-                  : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
-              }`}
-            >
-              <div className="flex items-center gap-3">
-                <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
-                  <Icon className="w-5 h-5 text-blue-600" />
-                </div>
-                <div className="flex-1 min-w-0">
-                  <p className="font-medium text-gray-900 truncate">
-                    {entity.business_name || entity.full_name || entity.name}
-                  </p>
-                  <p className="text-sm text-gray-500 truncate">
-                    {entity.contact_person || entity.phone || entity.address}
-                  </p>
-                </div>
-              </div>
-              <div className="mt-2 text-right">
-                <p className="text-sm font-medium text-gray-900">
-                  {formatCurrency(entity.total_usd || 0, 'USD')}
-                </p>
-                <p className="text-xs text-gray-500">
-                  {formatCurrency(entity.total_lbp || 0, 'LBP')}
-                </p>
-              </div>
-            </motion.button>
-          ))}
+        <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
+          <div className="overflow-x-auto">
+            <table className="min-w-full divide-y divide-gray-200">
+              <thead className="bg-gray-50">
+                <tr>
+                  <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
+                  <th className="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
+                  <th className="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Orders</th>
+                </tr>
+              </thead>
+              <tbody className="bg-white divide-y divide-gray-200">
+                {data.map((entity) => (
+                  <tr
+                    key={entity.id || entity.name}
+                    className={`cursor-pointer hover:bg-gray-50 ${selectedEntity?.id === entity.id || selectedEntity?.name === entity.name ? 'bg-blue-50' : ''}`}
+                    onClick={() => onEntitySelect(entity)}
+                  >
+                    <td className="px-3 py-2 text-sm text-gray-900">
+                      {entity.business_name || entity.full_name || entity.name}
+                    </td>
+                    <td className="px-3 py-2 text-xs text-gray-500">
+                      {entity.contact_person || entity.phone || entity.address || 'ΓÇö'}
+                    </td>
+                    <td className="px-3 py-2 text-sm text-gray-900 text-right">
+                      {entity.total_orders || entity.orders_count || 0}
+                    </td>
+                  </tr>
+                ))}
+              </tbody>
+            </table>
+          </div>
         </div>
       </div>
 
       {/* Transactions */}
       <div className="lg:col-span-2" ref={sectionRef}>
-        <h3 className="text-lg font-semibold mb-4">
-          {selectedEntity ? `${entityTitle} Transactions` : 'All Transactions'}
-        </h3>
+        <div className="flex items-center justify-between mb-3">
+          <h3 className="text-lg font-semibold">
+            {selectedEntity ? `${entityTitle} Transactions` : 'All Transactions'}
+          </h3>
+          <div className="flex items-center gap-2">
+            <select
+              value={entityStatus}
+              onChange={(e) => onChangeEntityStatus(e.target.value)}
+              className="px-2 py-1 border border-gray-300 rounded text-sm"
+            >
+              <option value="">All Status</option>
+              <option value="onshelf">On Shelf</option>
+              <option value="on_road">On Road</option>
+              <option value="delivered">Delivered</option>
+              <option value="postponed">Postponed</option>
+              <option value="canceled">Canceled</option>
+              <option value="completed">Completed</option>
+            </select>
+          </div>
+        </div>
         {selectedEntity ? (
           <div className="space-y-3">
             <div className="flex justify-end gap-2 mb-2">
diff --git a/client/src/pages/CRM.jsx b/client/src/pages/CRM.jsx
index 873a0b4..e811153 100644
--- a/client/src/pages/CRM.jsx
+++ b/client/src/pages/CRM.jsx
@@ -15,7 +15,8 @@ import {
   User,
   X,
   Save,
-  Loader2
+  Loader2,
+  Map
 } from 'lucide-react';
 import api from '../api';
 import toast from 'react-hot-toast';
@@ -32,10 +33,10 @@ const CRM = () => {
     address: '',
     instagram: '',
     website: '',
-    google_location_lat: '',
-    google_location_lng: '',
+    google_map_link: '',
     category: ''
   });
+  const [customCategory, setCustomCategory] = useState('');
 
   const queryClient = useQueryClient();
 
@@ -49,6 +50,17 @@ const CRM = () => {
     }
   );
 
+  // Search clients for autocomplete (used by Orders page)
+  const searchClients = async (query) => {
+    try {
+      const response = await api.get(`/clients/search/${encodeURIComponent(query)}`);
+      return response.data?.data || [];
+    } catch (error) {
+      console.error('Error searching clients:', error);
+      return [];
+    }
+  };
+
   // Add new client mutation
   const addClientMutation = useMutation(
     (newClient) => api.post('/clients', newClient),
@@ -109,8 +121,7 @@ const CRM = () => {
       address: '',
       instagram: '',
       website: '',
-      google_location_lat: '',
-      google_location_lng: '',
+      google_map_link: '',
       category: ''
     });
   };
@@ -118,10 +129,21 @@ const CRM = () => {
   const handleSubmit = (e) => {
     e.preventDefault();
     
+    const payload = {
+      business_name: formData.business_name,
+      contact_person: formData.contact_person,
+      phone: formData.phone,
+      address: formData.address,
+      instagram: formData.instagram,
+      website: formData.website,
+      google_location: formData.google_map_link || '',
+      category: formData.category
+    };
+
     if (editingClient) {
-      updateClientMutation.mutate({ id: editingClient.id, clientData: formData });
+      updateClientMutation.mutate({ id: editingClient.id, clientData: payload });
     } else {
-      addClientMutation.mutate(formData);
+      addClientMutation.mutate(payload);
     }
   };
 
@@ -134,8 +156,7 @@ const CRM = () => {
       address: client.address || '',
       instagram: client.instagram || '',
       website: client.website || '',
-      google_location_lat: client.google_location_lat || '',
-      google_location_lng: client.google_location_lng || '',
+      google_map_link: client.google_location || '',
       category: client.category || ''
     });
     setShowAddModal(true);
@@ -192,22 +213,22 @@ const CRM = () => {
       </div>
 
       {/* Search and Filters */}
-      <div className="bg-white rounded-lg shadow-md p-6 mb-6">
-        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
+      <div className="bg-white rounded-lg shadow-md p-4 mb-4">
+        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
           <div>
             <input
               type="text"
               placeholder="Search clients..."
               value={searchTerm}
               onChange={(e) => setSearchTerm(e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
             />
           </div>
           <div>
             <select
               value={selectedCategory}
               onChange={(e) => setSelectedCategory(e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
             >
               <option value="">All Categories</option>
               <option value="ecommerce">E-commerce</option>
@@ -215,8 +236,20 @@ const CRM = () => {
               <option value="wholesale">Wholesale</option>
               <option value="service">Service</option>
               <option value="manufacturing">Manufacturing</option>
+              <option value="other">Other</option>
             </select>
           </div>
+          {selectedCategory === 'other' && (
+            <div>
+              <input
+                type="text"
+                placeholder="Type custom category..."
+                value={customCategory}
+                onChange={(e) => setCustomCategory(e.target.value)}
+                className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
+              />
+            </div>
+          )}
         </div>
       </div>
 
@@ -227,15 +260,15 @@ const CRM = () => {
             key={client.id}
             initial={{ opacity: 0, y: 20 }}
             animate={{ opacity: 1, y: 0 }}
-            className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow"
+            className="bg-white rounded-lg shadow-md p-4 hover:shadow-lg transition-shadow"
           >
             <div className="flex justify-between items-start mb-4">
               <div className="flex-1">
-                <h3 className="text-lg font-semibold text-gray-900 mb-2">
+                <h3 className="text-base font-semibold text-gray-900 mb-1">
                   {client.business_name}
                 </h3>
                 {client.category && (
-                  <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getCategoryColor(client.category)}`}>
+                  <span className={`inline-flex px-2 py-0.5 text-[10px] font-semibold rounded-full ${getCategoryColor(client.category)}`}>
                     {client.category}
                   </span>
                 )}
@@ -255,49 +288,57 @@ const CRM = () => {
                 </button>
               </div>
             </div>
-
-            <div className="space-y-3">
+            <div className="grid grid-cols-2 gap-2">
               {client.contact_person && (
-                <div className="flex items-center text-sm text-gray-600">
-                  <User className="w-4 h-4 mr-2" />
-                  {client.contact_person}
+                <div className="flex items-center text-xs text-gray-600">
+                  <User className="w-4 h-4 mr-1" />
+                  <span className="truncate">{client.contact_person}</span>
                 </div>
               )}
-              
               {client.phone && (
-                <div className="flex items-center text-sm text-gray-600">
-                  <Phone className="w-4 h-4 mr-2" />
-                  {client.phone}
+                <div className="flex items-center text-xs text-gray-600">
+                  <Phone className="w-4 h-4 mr-1" />
+                  <span className="truncate">{client.phone}</span>
                 </div>
               )}
-              
               {client.address && (
-                <div className="flex items-center text-sm text-gray-600">
-                  <MapPin className="w-4 h-4 mr-2" />
-                  {client.address}
+                <div className="flex items-center text-xs text-gray-600 col-span-2">
+                  <MapPin className="w-4 h-4 mr-1" />
+                  <span className="truncate">{client.address}</span>
                 </div>
               )}
-              
               {client.instagram && (
-                <div className="flex items-center text-sm text-gray-600">
-                  <Instagram className="w-4 h-4 mr-2" />
-                  {client.instagram}
+                <div className="flex items-center text-xs text-gray-600">
+                  <Instagram className="w-4 h-4 mr-1" />
+                  <span className="truncate">{client.instagram}</span>
                 </div>
               )}
-              
               {client.website && (
-                <div className="flex items-center text-sm text-gray-600">
-                  <Globe className="w-4 h-4 mr-2" />
+                <div className="flex items-center text-xs text-gray-600">
+                  <Globe className="w-4 h-4 mr-1" />
                   <a 
                     href={client.website.startsWith('http') ? client.website : `https://${client.website}`}
                     target="_blank"
                     rel="noopener noreferrer"
-                    className="text-blue-600 hover:text-blue-800"
+                    className="text-blue-600 hover:text-blue-800 truncate"
                   >
                     {client.website}
                   </a>
                 </div>
               )}
+              {client.google_location && (
+                <div className="flex items-center text-xs text-gray-600 col-span-2">
+                  <Map className="w-4 h-4 mr-1" />
+                  <a
+                    href={String(client.google_location).startsWith('http') ? client.google_location : `https://www.google.com/maps/search/?api=1&query=${client.google_location}`}
+                    target="_blank"
+                    rel="noopener noreferrer"
+                    className="text-blue-600 hover:text-blue-800 truncate"
+                  >
+                    Open in Google Maps
+                  </a>
+                </div>
+              )}
             </div>
           </motion.div>
         ))}
@@ -311,15 +352,17 @@ const CRM = () => {
             animate={{ opacity: 1 }}
             exit={{ opacity: 0 }}
             className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
+            onClick={() => setShowAddModal(false)}
           >
             <motion.div
               initial={{ scale: 0.9, opacity: 0 }}
               animate={{ scale: 1, opacity: 1 }}
               exit={{ scale: 0.9, opacity: 0 }}
-              className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"
+              className="bg-white rounded-lg p-4 w-full max-w-xl max-h-[90vh] overflow-y-auto"
+              onClick={(e) => e.stopPropagation()}
             >
               <div className="flex justify-between items-center mb-6">
-                <h2 className="text-2xl font-bold">
+                <h2 className="text-xl font-bold">
                   {editingClient ? 'Edit Client' : 'Add New Client'}
                 </h2>
                 <button
@@ -330,10 +373,10 @@ const CRM = () => {
                 </button>
               </div>
 
-              <form onSubmit={handleSubmit} className="space-y-6">
-                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
+              <form onSubmit={handleSubmit} className="space-y-4">
+                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                   {/* Business Name */}
-                  <div className="md:col-span-2">
+                  <div className="md:col-span-3">
                     <label className="block text-sm font-medium text-gray-700 mb-2">
                       Business Name *
                     </label>
@@ -342,7 +385,7 @@ const CRM = () => {
                       name="business_name"
                       value={formData.business_name}
                       onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                      className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                       required
                     />
                   </div>
@@ -357,7 +400,7 @@ const CRM = () => {
                       name="contact_person"
                       value={formData.contact_person}
                       onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                      className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                     />
                   </div>
 
@@ -371,12 +414,12 @@ const CRM = () => {
                       name="phone"
                       value={formData.phone}
                       onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                      className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                     />
                   </div>
 
                   {/* Address */}
-                  <div className="md:col-span-2">
+                  <div className="md:col-span-3">
                     <label className="block text-sm font-medium text-gray-700 mb-2">
                       Address
                     </label>
@@ -385,7 +428,7 @@ const CRM = () => {
                       name="address"
                       value={formData.address}
                       onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                      className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                     />
                   </div>
 
@@ -399,7 +442,7 @@ const CRM = () => {
                       name="instagram"
                       value={formData.instagram}
                       onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                      className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                       placeholder="@username"
                     />
                   </div>
@@ -414,45 +457,28 @@ const CRM = () => {
                       name="website"
                       value={formData.website}
                       onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                      className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                       placeholder="https://example.com"
                     />
                   </div>
 
-                  {/* Google Location Lat */}
-                  <div>
-                    <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Latitude
-                    </label>
-                    <input
-                      type="number"
-                      step="any"
-                      name="google_location_lat"
-                      value={formData.google_location_lat}
-                      onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
-                      placeholder="33.8935"
-                    />
-                  </div>
-
-                  {/* Google Location Lng */}
-                  <div>
+                  {/* Google Map Link */}
+                  <div className="md:col-span-3">
                     <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Longitude
+                      Google Map Link
                     </label>
                     <input
-                      type="number"
-                      step="any"
-                      name="google_location_lng"
-                      value={formData.google_location_lng}
+                      type="url"
+                      name="google_map_link"
+                      value={formData.google_map_link}
                       onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
-                      placeholder="35.5018"
+                      className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
+                      placeholder="https://maps.google.com/..."
                     />
                   </div>
 
                   {/* Category */}
-                  <div className="md:col-span-2">
+                  <div>
                     <label className="block text-sm font-medium text-gray-700 mb-2">
                       Category
                     </label>
@@ -460,7 +486,7 @@ const CRM = () => {
                       name="category"
                       value={formData.category}
                       onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                      className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                     >
                       <option value="">Select Category</option>
                       <option value="ecommerce">E-commerce</option>
@@ -468,22 +494,35 @@ const CRM = () => {
                       <option value="wholesale">Wholesale</option>
                       <option value="service">Service</option>
                       <option value="manufacturing">Manufacturing</option>
+                      <option value="other">Other</option>
                     </select>
                   </div>
+                  {formData.category === 'other' && (
+                    <div className="md:col-span-2">
+                      <label className="block text-sm font-medium text-gray-700 mb-2">Custom Category</label>
+                      <input
+                        type="text"
+                        value={customCategory}
+                        onChange={(e) => setCustomCategory(e.target.value)}
+                        className="w-full px-2 py-1.5 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
+                        placeholder="Type category"
+                      />
+                    </div>
+                  )}
                 </div>
 
                 <div className="flex justify-end space-x-3">
                   <button
                     type="button"
                     onClick={() => setShowAddModal(false)}
-                    className="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors"
+                    className="px-3 py-1.5 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors text-sm"
                   >
                     Cancel
                   </button>
                   <button
                     type="submit"
                     disabled={addClientMutation.isLoading || updateClientMutation.isLoading}
-                    className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 transition-colors flex items-center gap-2"
+                    className="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50 transition-colors flex items-center gap-2 text-sm"
                   >
                     {(addClientMutation.isLoading || updateClientMutation.isLoading) ? (
                       <Loader2 className="w-4 h-4 animate-spin" />
diff --git a/client/src/pages/Cashbox.jsx b/client/src/pages/Cashbox.jsx
index f180430..c64d1ae 100644
--- a/client/src/pages/Cashbox.jsx
+++ b/client/src/pages/Cashbox.jsx
@@ -25,6 +25,7 @@ import api from '../api';
 const Cashbox = () => {
   const [showIncomeModal, setShowIncomeModal] = useState(false);
   const [showExpenseModal, setShowExpenseModal] = useState(false);
+  const [expenseCategory, setExpenseCategory] = useState('');
 
   const queryClient = useQueryClient();
 
@@ -238,12 +239,14 @@ const Cashbox = () => {
             animate={{ opacity: 1 }}
             exit={{ opacity: 0 }}
             className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
+            onClick={() => setShowExpenseModal(false)}
           >
             <motion.div
               initial={{ scale: 0.9, opacity: 0 }}
               animate={{ scale: 1, opacity: 1 }}
               exit={{ scale: 0.9, opacity: 0 }}
               className="bg-white rounded-lg p-6 w-full max-w-md"
+              onClick={(e) => e.stopPropagation()}
             >
               <div className="flex justify-between items-center mb-6">
                 <h2 className="text-2xl font-bold">Add Expense</h2>
@@ -365,13 +368,20 @@ const ExpenseForm = ({ onSubmit, onCancel }) => {
   const [formData, setFormData] = useState({
     amount_usd: '',
     amount_lbp: '',
+    category_title: '',
+    category_item: '',
     description: '',
     notes: ''
   });
 
   const handleSubmit = (e) => {
     e.preventDefault();
-    onSubmit(formData);
+    const description = formData.description || `${formData.category_title} - ${formData.category_item}`;
+    onSubmit({
+      amount_usd: formData.amount_usd,
+      amount_lbp: formData.amount_lbp,
+      description
+    });
   };
 
   const handleChange = (e) => {
@@ -411,6 +421,94 @@ const ExpenseForm = ({ onSubmit, onCancel }) => {
         </div>
       </div>
 
+      {/* Expense Categories */}
+      <div className="grid grid-cols-2 gap-4">
+        <div>
+          <label className="block text-sm font-medium text-gray-700 mb-2">Category</label>
+          <select
+            value={formData.category_title}
+            onChange={(e) => setFormData(prev => ({ ...prev, category_title: e.target.value, category_item: '' }))}
+            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
+          >
+            <option value="">Select Category</option>
+            <option value="Operations / Fleet">Operations / Fleet</option>
+            <option value="Staff & HR">Staff & HR</option>
+            <option value="Office & Admin">Office & Admin</option>
+            <option value="Marketing & Sales">Marketing & Sales</option>
+            <option value="Operations Support">Operations Support</option>
+            <option value="Technology & Systems">Technology & Systems</option>
+            <option value="Financial & Other">Financial & Other</option>
+          </select>
+        </div>
+        <div>
+          <label className="block text-sm font-medium text-gray-700 mb-2">Item</label>
+          <select
+            value={formData.category_item}
+            onChange={(e) => setFormData(prev => ({ ...prev, category_item: e.target.value }))}
+            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500"
+          >
+            <option value="">Select Item</option>
+            {formData.category_title === 'Operations / Fleet' && (
+              <>
+                <option>Driver Salaries & Wages</option>
+                <option>Driver Overtime</option>
+                <option>Delivery Fees Paid to Subcontractors</option>
+                <option>Fuel Expense</option>
+                <option>Vehicle Maintenance & Repairs</option>
+                <option>Vehicle Insurance</option>
+                <option>Vehicle Registration & Licensing</option>
+                <option>Bike/Car Rental</option>
+              </>
+            )}
+            {formData.category_title === 'Staff & HR' && (
+              <>
+                <option>Staff Salaries & Wages</option>
+                <option>Employee Benefits</option>
+                <option>Training & Recruitment</option>
+              </>
+            )}
+            {formData.category_title === 'Office & Admin' && (
+              <>
+                <option>Rent</option>
+                <option>Utilities</option>
+                <option>Office Supplies</option>
+                <option>Software Subscriptions</option>
+                <option>Phone & Communication</option>
+                <option>Bank Fees & Charges</option>
+                <option>Professional Fees</option>
+              </>
+            )}
+            {formData.category_title === 'Marketing & Sales' && (
+              <>
+                <option>Advertising & Promotions</option>
+                <option>Branding & Design</option>
+                <option>Sponsorships / Community Events</option>
+              </>
+            )}
+            {formData.category_title === 'Operations Support' && (
+              <>
+                <option>Packaging Materials</option>
+                <option>Uniforms</option>
+              </>
+            )}
+            {formData.category_title === 'Technology & Systems' && (
+              <>
+                <option>Website & Hosting</option>
+                <option>App Development & Maintenance</option>
+                <option>IT Support & Repairs</option>
+              </>
+            )}
+            {formData.category_title === 'Financial & Other' && (
+              <>
+                <option>Depreciation</option>
+                <option>Currency Exchange / Transfer Fees</option>
+                <option>Miscellaneous Expenses</option>
+              </>
+            )}
+          </select>
+        </div>
+      </div>
+
       <div>
         <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
         <input
diff --git a/client/src/pages/Drivers.jsx b/client/src/pages/Drivers.jsx
index 769e50b..d2f2c06 100644
--- a/client/src/pages/Drivers.jsx
+++ b/client/src/pages/Drivers.jsx
@@ -37,8 +37,6 @@ const Drivers = () => {
     phone: '',
     address: '',
     notes: '',
-    default_fee_lbp: '',
-    default_fee_usd: '',
     active: true
   });
 
@@ -123,8 +121,6 @@ const Drivers = () => {
       phone: '',
       address: '',
       notes: '',
-      default_fee_lbp: '',
-      default_fee_usd: '',
       active: true
     });
   };
@@ -136,8 +132,6 @@ const Drivers = () => {
       phone: driver.phone,
       address: driver.address,
       notes: driver.notes,
-      default_fee_lbp: driver.default_fee_lbp || '',
-      default_fee_usd: driver.default_fee_usd || '',
       active: driver.active
     });
     setIsEditModalOpen(true);
@@ -333,16 +327,6 @@ const Drivers = () => {
                   )}
                 </div>
 
-                <div className="mt-4 pt-4 border-t border-gray-200">
-                  <div className="flex justify-between text-sm">
-                    <span className="text-gray-500">Default Fee (LBP):</span>
-                    <span className="font-medium">{driver.default_fee_lbp?.toLocaleString() || '0'}</span>
-                  </div>
-                  <div className="flex justify-between text-sm">
-                    <span className="text-gray-500">Default Fee (USD):</span>
-                    <span className="font-medium">${driver.default_fee_usd || '0'}</span>
-                  </div>
-                </div>
               </div>
             </motion.div>
           ))}
@@ -365,16 +349,18 @@ const Drivers = () => {
             animate={{ opacity: 1 }}
             exit={{ opacity: 0 }}
             className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
+            onClick={() => { setIsAddModalOpen(false); resetForm(); }}
           >
             <motion.div
               initial={{ scale: 0.95, opacity: 0 }}
               animate={{ scale: 1, opacity: 1 }}
               exit={{ scale: 0.95, opacity: 0 }}
-              className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto"
+              className="bg-white rounded-lg shadow-xl max-w-sm w-full max-h-[80vh] overflow-y-auto"
+              onClick={(e) => e.stopPropagation()}
             >
-              <div className="p-6">
-                <h2 className="text-xl font-semibold mb-4">Add New Driver</h2>
-                <form onSubmit={handleSubmit} className="space-y-4">
+              <div className="p-4">
+                <h2 className="text-lg font-semibold mb-3">Add New Driver</h2>
+                <form onSubmit={handleSubmit} className="space-y-3">
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-1">
                       Full Name *
@@ -420,31 +406,7 @@ const Drivers = () => {
                       className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     />
                   </div>
-                  <div className="grid grid-cols-2 gap-4">
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Default Fee (LBP)
-                      </label>
-                      <input
-                        type="number"
-                        value={formData.default_fee_lbp}
-                        onChange={(e) => setFormData({ ...formData, default_fee_lbp: e.target.value })}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
-                      />
-                    </div>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Default Fee (USD)
-                      </label>
-                      <input
-                        type="number"
-                        step="0.01"
-                        value={formData.default_fee_usd}
-                        onChange={(e) => setFormData({ ...formData, default_fee_usd: e.target.value })}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
-                      />
-                    </div>
-                  </div>
+                  {/* Default fees removed by requirement */}
                   <div className="flex items-center">
                     <input
                       type="checkbox"
@@ -491,16 +453,18 @@ const Drivers = () => {
             animate={{ opacity: 1 }}
             exit={{ opacity: 0 }}
             className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
+            onClick={() => { setIsEditModalOpen(false); setSelectedDriver(null); }}
           >
             <motion.div
               initial={{ scale: 0.95, opacity: 0 }}
               animate={{ scale: 1, opacity: 1 }}
               exit={{ scale: 0.95, opacity: 0 }}
-              className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto"
+              className="bg-white rounded-lg shadow-xl max-w-sm w-full max-h-[80vh] overflow-y-auto"
+              onClick={(e) => e.stopPropagation()}
             >
-              <div className="p-6">
-                <h2 className="text-xl font-semibold mb-4">Edit Driver</h2>
-                <form onSubmit={handleSubmit} className="space-y-4">
+              <div className="p-4">
+                <h2 className="text-lg font-semibold mb-3">Edit Driver</h2>
+                <form onSubmit={handleSubmit} className="space-y-3">
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-1">
                       Full Name *
@@ -546,31 +510,7 @@ const Drivers = () => {
                       className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                     />
                   </div>
-                  <div className="grid grid-cols-2 gap-4">
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Default Fee (LBP)
-                      </label>
-                      <input
-                        type="number"
-                        value={formData.default_fee_lbp}
-                        onChange={(e) => setFormData({ ...formData, default_fee_lbp: e.target.value })}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
-                      />
-                    </div>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Default Fee (USD)
-                      </label>
-                      <input
-                        type="number"
-                        step="0.01"
-                        value={formData.default_fee_usd}
-                        onChange={(e) => setFormData({ ...formData, default_fee_usd: e.target.value })}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
-                      />
-                    </div>
-                  </div>
+                  {/* Default fees removed by requirement */}
                   <div className="flex items-center">
                     <input
                       type="checkbox"
@@ -666,14 +606,14 @@ const Drivers = () => {
               initial={{ scale: 0.95, opacity: 0 }}
               animate={{ scale: 1, opacity: 1 }}
               exit={{ scale: 0.95, opacity: 0 }}
-              className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto"
+              className="bg-white rounded-lg shadow-xl max-w-sm w-full max-h-[80vh] overflow-y-auto"
             >
-              <div className="p-6">
-                <h2 className="text-xl font-semibold mb-4">Add Driver Fees</h2>
-                <p className="text-gray-600 mb-4">
+              <div className="p-4">
+                <h2 className="text-lg font-semibold mb-3">Add Driver Fees</h2>
+                <p className="text-gray-600 mb-3 text-sm">
                   Adding fees for driver: <strong>{selectedDriver?.full_name}</strong>
                 </p>
-                <form onSubmit={handleAddFeesSubmit} className="space-y-4">
+                <form onSubmit={handleAddFeesSubmit} className="space-y-3">
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-1">
                       Fee Type *
diff --git a/client/src/pages/OrderHistory.jsx b/client/src/pages/OrderHistory.jsx
index b037ffb..e4d99eb 100644
--- a/client/src/pages/OrderHistory.jsx
+++ b/client/src/pages/OrderHistory.jsx
@@ -7,7 +7,8 @@ import { toast } from 'react-hot-toast';
 import api from '../api';
 
 const OrderHistory = () => {
-  const [activeTab, setActiveTab] = useState('orders'); // 'orders' or 'clients'
+  const [activeTab, setActiveTab] = useState('orders');
+  const [activeGroup, setActiveGroup] = useState('client'); // 'client' | 'driver' | 'third_party'
   const [filters, setFilters] = useState({
     from_date: '',
     to_date: '',
@@ -18,13 +19,13 @@ const OrderHistory = () => {
   const [selectedOrder, setSelectedOrder] = useState(null);
   const [showOrderModal, setShowOrderModal] = useState(false);
 
-  const { data: orders, isLoading: ordersLoading, error: ordersError, refetch: refetchOrders } = useQuery(
+  const { data: grouped, isLoading: ordersLoading, error: ordersError, refetch: refetchOrders } = useQuery(
     ['orderHistory', filters],
-    () => api.get('/orders/history', { params: filters }),
+    () => api.get('/order-history', { params: { ...filters } }),
     {
       refetchOnWindowFocus: false,
       retry: 1,
-      select: (response) => response.data?.data || []
+      select: (response) => response.data?.data || { client: [], driver: [], third_party: [] }
     }
   );
 
@@ -148,7 +149,7 @@ const OrderHistory = () => {
         </div>
         <div className="flex items-center space-x-3">
           <span className="text-sm text-gray-500">
-            Total: {activeTab === 'orders' ? (orders?.length || 0) : (clients?.length || 0)} {activeTab === 'orders' ? 'orders' : 'clients'}
+            Total: {activeTab === 'orders' ? ((grouped?.[activeGroup] || []).length) : ((clients || []).length)} {activeTab === 'orders' ? 'orders' : 'clients'}
           </span>
         </div>
       </motion.div>
@@ -161,7 +162,8 @@ const OrderHistory = () => {
         className="bg-white rounded-lg shadow-sm border border-gray-200"
       >
         <div className="border-b border-gray-200">
-          <nav className="flex space-x-8 px-6">
+          <nav className="flex items-center justify-between px-6">
+            <div className="flex space-x-8">
             <button
               onClick={() => setActiveTab('orders')}
               className={`py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2 ${
@@ -184,6 +186,14 @@ const OrderHistory = () => {
               <Users className="w-4 h-4" />
               Clients History
             </button>
+            </div>
+            {activeTab === 'orders' && (
+              <div className="flex items-center space-x-2 py-2">
+                <button onClick={() => setActiveGroup('client')} className={`px-3 py-1 rounded text-xs ${activeGroup==='client'?'bg-blue-100 text-blue-700':'text-gray-600 hover:bg-gray-100'}`}>Client</button>
+                <button onClick={() => setActiveGroup('driver')} className={`px-3 py-1 rounded text-xs ${activeGroup==='driver'?'bg-blue-100 text-blue-700':'text-gray-600 hover:bg-gray-100'}`}>Drivers</button>
+                <button onClick={() => setActiveGroup('third_party')} className={`px-3 py-1 rounded text-xs ${activeGroup==='third_party'?'bg-blue-100 text-blue-700':'text-gray-600 hover:bg-gray-100'}`}>Third Parties</button>
+              </div>
+            )}
           </nav>
         </div>
       </motion.div>
@@ -298,7 +308,7 @@ const OrderHistory = () => {
       >
         {activeTab === 'orders' ? (
           <OrdersTable 
-            orders={orders} 
+            orders={grouped?.[activeGroup] || []} 
             drivers={drivers}
             onViewOrder={viewOrderDetails}
             onExportPDF={exportToPDF}
diff --git a/client/src/pages/Orders.jsx b/client/src/pages/Orders.jsx
index 843c229..2cb6a5a 100644
--- a/client/src/pages/Orders.jsx
+++ b/client/src/pages/Orders.jsx
@@ -32,11 +32,14 @@ import api from '../api';
 import toast from 'react-hot-toast';
 import ExcelOrderForm from '../components/ExcelOrderForm';
 import OrdersGrid from '../components/OrdersGrid';
+import { searchClients, formatClientForAutocomplete } from '../utils/clientSearch';
+import { priceListApi } from '../api/priceList';
 
 const Orders = () => {
   const [searchTerm, setSearchTerm] = useState('');
-  const [selectedStatus, setSelectedStatus] = useState('');
+  const [selectedStatus, setSelectedStatus] = useState('!cancelled');
   const [selectedBrand, setSelectedBrand] = useState('');
+  const [selectedClientCategory, setSelectedClientCategory] = useState('');
   const [selectedType, setSelectedType] = useState('');
   const [dateFrom, setDateFrom] = useState('');
   const [dateTo, setDateTo] = useState('');
@@ -45,9 +48,17 @@ const Orders = () => {
   const [editingOrder, setEditingOrder] = useState(null);
   const [selectedDriver, setSelectedDriver] = useState('');
   const [viewMode, setViewMode] = useState('grid'); // 'table' or 'grid'
+  const [deliveryModeFilter, setDeliveryModeFilter] = useState('');
+  
+  // Autocomplete states
+  const [clientSuggestions, setClientSuggestions] = useState([]);
+  const [addressSuggestions, setAddressSuggestions] = useState([]);
+  const [showClientSuggestions, setShowClientSuggestions] = useState(false);
+  const [showAddressSuggestions, setShowAddressSuggestions] = useState(false);
+  const [selectedClient, setSelectedClient] = useState(null);
+  const [selectedAddress, setSelectedAddress] = useState(null);
   const [formData, setFormData] = useState({
     order_ref: '',
-    voucher_code: '',
     brand_name: '',
     customer_name: '',
     customer_phone: '',
@@ -60,6 +71,8 @@ const Orders = () => {
     notes: '',
     total_usd: '',
     total_lbp: '',
+    delivery_fees_usd: '',
+    delivery_fees_lbp: '',
     third_party_fee_usd: '',
     third_party_fee_lbp: '',
     driver_fee_usd: '',
@@ -70,8 +83,8 @@ const Orders = () => {
 
   // Fetch orders with search and filters
   const { data: orders, isLoading } = useQuery(
-    ['orders', searchTerm, selectedStatus, selectedBrand, selectedType, dateFrom, dateTo],
-    () => api.get(`/orders?search=${encodeURIComponent(searchTerm)}&status=${selectedStatus}&brand_name=${encodeURIComponent(selectedBrand)}&type=${selectedType}` + (dateFrom ? `&date_from=${dateFrom}` : '') + (dateTo ? `&date_to=${dateTo}` : '')), 
+    ['orders', searchTerm, selectedStatus, selectedBrand, selectedType, deliveryModeFilter, dateFrom, dateTo],
+    () => api.get(`/orders?search=${encodeURIComponent(searchTerm)}&status=${encodeURIComponent(selectedStatus)}&brand_name=${encodeURIComponent(selectedBrand)}&type=${selectedType}` + (deliveryModeFilter ? `&delivery_mode=${deliveryModeFilter}` : '') + (dateFrom ? `&date_from=${dateFrom}` : '') + (dateTo ? `&date_to=${dateTo}` : '')), 
     {
       keepPreviousData: true,
       select: (response) => response.data?.data || []
@@ -88,6 +101,11 @@ const Orders = () => {
     select: (response) => response.data?.data || []
   });
 
+  const clientCategories = Array.from(new Set((clients || []).map(c => c.category).filter(Boolean)));
+  const filteredClientsByCategory = selectedClientCategory
+    ? (clients || []).filter(c => c.category === selectedClientCategory)
+    : (clients || []);
+
   // Add new order mutation
   const addOrderMutation = useMutation(
     (newOrder) => api.post('/orders', newOrder),
@@ -144,9 +162,16 @@ const Orders = () => {
   const updateStatusMutation = useMutation(
     ({ id, status, payment_status }) => api.put(`/orders/${id}`, { status, payment_status }),
     {
-      onSuccess: () => {
+      onSuccess: (_resp, variables) => {
         queryClient.invalidateQueries('orders');
-        toast.success('Order status updated successfully!');
+        queryClient.invalidateQueries('accounting-list');
+        queryClient.invalidateQueries('accounting-entity');
+        queryClient.invalidateQueries('dashboard');
+        if (variables?.payment_status === 'paid') {
+          toast.success('Payment marked as paid. Accounting and dashboard refreshed.');
+        } else {
+          toast.success('Order status updated successfully!');
+        }
       },
       onError: (error) => {
         toast.error(error.response?.data?.message || 'Failed to update order status');
@@ -174,7 +199,6 @@ const Orders = () => {
   const resetForm = () => {
     setFormData({
       order_ref: '',
-      voucher_code: '',
       brand_name: '',
       customer_name: '',
       customer_phone: '',
@@ -187,11 +211,108 @@ const Orders = () => {
       notes: '',
       total_usd: '',
       total_lbp: '',
+      delivery_fees_usd: '',
+      delivery_fees_lbp: '',
       third_party_fee_usd: '',
       third_party_fee_lbp: '',
       driver_fee_usd: '',
       driver_fee_lbp: ''
     });
+    setSelectedClient(null);
+    setSelectedAddress(null);
+    setClientSuggestions([]);
+    setAddressSuggestions([]);
+    setShowClientSuggestions(false);
+    setShowAddressSuggestions(false);
+  };
+
+  // Client search autocomplete
+  const handleClientSearch = async (query) => {
+    if (query.length < 2) {
+      setClientSuggestions([]);
+      setShowClientSuggestions(false);
+      return;
+    }
+
+    try {
+      const results = await searchClients(query);
+      const formattedResults = results.map(formatClientForAutocomplete);
+      setClientSuggestions(formattedResults);
+      setShowClientSuggestions(true);
+    } catch (error) {
+      console.error('Error searching clients:', error);
+      setClientSuggestions([]);
+      setShowClientSuggestions(false);
+    }
+  };
+
+  // Address search autocomplete
+  const handleAddressSearch = async (query) => {
+    if (query.length < 2) {
+      setAddressSuggestions([]);
+      setShowAddressSuggestions(false);
+      return;
+    }
+
+    try {
+      const response = await priceListApi.searchPriceList(query);
+      setAddressSuggestions(response.data || []);
+      setShowAddressSuggestions(true);
+    } catch (error) {
+      console.error('Error searching addresses:', error);
+      setAddressSuggestions([]);
+      setShowAddressSuggestions(false);
+    }
+  };
+
+  // Handle client selection
+  const handleClientSelect = (client) => {
+    setSelectedClient(client);
+    setFormData(prev => ({
+      ...prev,
+      customer_name: client.business_name,
+      customer_phone: client.phone || '',
+      customer_address: client.address || ''
+    }));
+    setShowClientSuggestions(false);
+  };
+
+  // Handle address selection and price lookup
+  const handleAddressSelect = (address) => {
+    setSelectedAddress(address);
+    setFormData(prev => ({
+      ...prev,
+      customer_address: `${address.area}, ${address.country}`
+    }));
+    setShowAddressSuggestions(false);
+    
+    // Auto-fill delivery fees based on delivery method
+    updateDeliveryFees(address);
+  };
+
+  // Update delivery fees based on selected address and delivery method
+  const updateDeliveryFees = (address) => {
+    if (!address) return;
+
+    const { deliver_method } = formData;
+    
+    if (deliver_method === 'in_house') {
+      setFormData(prev => ({
+        ...prev,
+        delivery_fees_usd: address.fee_usd || 0,
+        delivery_fees_lbp: address.fee_lbp || 0,
+        third_party_fee_usd: 0,
+        third_party_fee_lbp: 0
+      }));
+    } else if (deliver_method === 'third_party') {
+      setFormData(prev => ({
+        ...prev,
+        delivery_fees_usd: address.fee_usd || 0,
+        delivery_fees_lbp: address.fee_lbp || 0,
+        third_party_fee_usd: address.third_party_fee_usd || 0,
+        third_party_fee_lbp: address.third_party_fee_lbp || 0
+      }));
+    }
   };
 
   const generateOrderRef = () => {
@@ -211,8 +332,9 @@ const Orders = () => {
       customer_phone: formData.customer_phone || '',
       customer_address: formData.customer_address || '',
       brand_name: formData.brand_name || '',
-      voucher_code: formData.voucher_code || '',
       deliver_method: formData.deliver_method || 'in_house',
+      // Align with backend: explicitly set delivery_mode for third-party vs direct
+      delivery_mode: (formData.deliver_method === 'third_party') ? 'third_party' : 'direct',
       driver_id: formData.driver_id || null,
       notes: formData.notes || '',
       total_usd: parseFloat(formData.total_usd) || 0,
@@ -236,7 +358,6 @@ const Orders = () => {
     setEditingOrder(order);
     setFormData({
       order_ref: order.order_ref || '',
-      voucher_code: order.voucher_code || '',
       brand_name: order.brand_name || '',
       customer_name: order.customer_name || '',
       customer_phone: order.customer_phone || '',
@@ -292,6 +413,21 @@ const Orders = () => {
       ...prev,
       [name]: value
     }));
+
+    // Handle client name search
+    if (name === 'customer_name' && value) {
+      handleClientSearch(value);
+    }
+
+    // Handle address search
+    if (name === 'customer_address' && value) {
+      handleAddressSearch(value);
+    }
+
+    // Handle delivery method change - update fees if address is selected
+    if (name === 'deliver_method' && selectedAddress) {
+      updateDeliveryFees(selectedAddress);
+    }
   };
 
   const getStatusColor = (status) => {
@@ -324,7 +460,7 @@ const Orders = () => {
         currency: 'USD',
       }).format(amount || 0);
     } else if (currency === 'LBP') {
-      return new Intl.NumberFormat('ar-LB', {
+      return new Intl.NumberFormat('en-US', {
         style: 'currency',
         currency: 'LBP',
       }).format(amount || 0);
@@ -422,7 +558,7 @@ const Orders = () => {
         <>
           {/* Search and Filters */}
           <div className="bg-white rounded-lg shadow-md p-6 mb-6">
-            <div className="grid grid-cols-1 md:grid-cols-6 gap-4">
+          <div className="grid grid-cols-1 md:grid-cols-8 gap-4">
               <div>
                 <input
                   type="text"
@@ -432,12 +568,24 @@ const Orders = () => {
                   className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                 />
               </div>
+            <div>
+              <select
+                value={deliveryModeFilter}
+                onChange={(e) => setDeliveryModeFilter(e.target.value)}
+                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              >
+                <option value="">All Delivery</option>
+                <option value="direct">In House</option>
+                <option value="third_party">Third Party</option>
+              </select>
+            </div>
               <div>
                 <select
                   value={selectedStatus}
                   onChange={(e) => setSelectedStatus(e.target.value)}
                   className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                 >
+                  <option value="!cancelled">All Except Cancelled</option>
                   <option value="">All Statuses</option>
                   <option value="new">New</option>
                   <option value="assigned">Assigned</option>
@@ -448,6 +596,18 @@ const Orders = () => {
                   <option value="cancelled">Cancelled</option>
                 </select>
               </div>
+            <div>
+              <select
+                value={selectedClientCategory}
+                onChange={(e) => setSelectedClientCategory(e.target.value)}
+                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+              >
+                <option value="">All Client Categories</option>
+                {clientCategories.map(cat => (
+                  <option key={cat} value={cat}>{cat}</option>
+                ))}
+              </select>
+            </div>
               <div>
                 <select
                   value={selectedBrand}
@@ -455,7 +615,7 @@ const Orders = () => {
                   className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                 >
                   <option value="">All Brands</option>
-                  {clients?.map(client => (
+                {filteredClientsByCategory?.map(client => (
                     <option key={client.id} value={client.business_name}>
                       {client.business_name}
                     </option>
@@ -499,6 +659,7 @@ const Orders = () => {
                   if (selectedStatus) params.set('status', selectedStatus);
                   if (selectedBrand) params.set('brand_name', selectedBrand);
                   if (selectedType) params.set('type', selectedType);
+                  if (deliveryModeFilter) params.set('delivery_mode', deliveryModeFilter);
                   if (dateFrom) params.set('date_from', dateFrom);
                   if (dateTo) params.set('date_to', dateTo);
                   const token = localStorage.getItem('token');
@@ -631,12 +792,14 @@ const Orders = () => {
             animate={{ opacity: 1 }}
             exit={{ opacity: 0 }}
             className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
+            onClick={() => setShowAddModal(false)}
           >
             <motion.div
               initial={{ scale: 0.9, opacity: 0 }}
               animate={{ scale: 1, opacity: 1 }}
               exit={{ scale: 0.9, opacity: 0 }}
-              className="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto"
+              className="bg-white rounded-lg p-4 w-full max-w-4xl max-h-[90vh] overflow-y-auto"
+              onClick={(e) => e.stopPropagation()}
             >
               <div className="flex justify-between items-center mb-6">
                 <h2 className="text-2xl font-bold">
@@ -650,8 +813,8 @@ const Orders = () => {
                 </button>
               </div>
 
-              <form onSubmit={handleSubmit} className="space-y-6">
-                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
+              <form onSubmit={handleSubmit} className="space-y-4">
+                <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                   {/* Order Reference */}
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-2">
@@ -667,10 +830,10 @@ const Orders = () => {
                     />
                   </div>
 
-                  {/* Brand Name */}
+                  {/* Client */}
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Brand Name
+                      Client
                     </label>
                     <select
                       name="brand_name"
@@ -678,7 +841,7 @@ const Orders = () => {
                       onChange={handleInputChange}
                       className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                     >
-                      <option value="">Select Brand</option>
+                      <option value="">Select Client</option>
                       {clients?.map(client => (
                         <option key={client.id} value={client.business_name}>
                           {client.business_name}
@@ -717,7 +880,7 @@ const Orders = () => {
                   </div>
 
                   {/* Customer Address */}
-                  <div className="md:col-span-2">
+                  <div className="md:col-span-3">
                     <label className="block text-sm font-medium text-gray-700 mb-2">
                       Customer Address
                     </label>
@@ -783,24 +946,12 @@ const Orders = () => {
                     </select>
                   </div>
 
-                  {/* Voucher Code */}
-                  <div>
-                    <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Voucher Code
-                    </label>
-                    <input
-                      type="text"
-                      name="voucher_code"
-                      value={formData.voucher_code}
-                      onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
-                    />
-                  </div>
+                  {/* Voucher Code hidden per requirements */}
 
-                  {/* Total USD */}
+                  {/* Total Amount USD */}
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Total USD
+                      Total Amount USD
                     </label>
                     <input
                       type="number"
@@ -812,10 +963,10 @@ const Orders = () => {
                     />
                   </div>
 
-                  {/* Total LBP */}
+                  {/* Total Amount LBP */}
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Total LBP
+                      Total Amount LBP
                     </label>
                     <input
                       type="number"
@@ -826,39 +977,10 @@ const Orders = () => {
                     />
                   </div>
 
-                  {/* Third Party Fee USD */}
+                  {/* Delivery Fee USD */}
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Third Party Fee USD
-                    </label>
-                    <input
-                      type="number"
-                      step="0.01"
-                      name="third_party_fee_usd"
-                      value={formData.third_party_fee_usd}
-                      onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
-                    />
-                  </div>
-
-                  {/* Third Party Fee LBP */}
-                  <div>
-                    <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Third Party Fee LBP
-                    </label>
-                    <input
-                      type="number"
-                      name="third_party_fee_lbp"
-                      value={formData.third_party_fee_lbp}
-                      onChange={handleInputChange}
-                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
-                    />
-                  </div>
-
-                  {/* Driver Fee USD */}
-                  <div>
-                    <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Driver Fee USD
+                      Delivery Fee USD
                     </label>
                     <input
                       type="number"
@@ -870,10 +992,10 @@ const Orders = () => {
                     />
                   </div>
 
-                  {/* Driver Fee LBP */}
+                  {/* Delivery Fee LBP */}
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-2">
-                      Driver Fee LBP
+                      Delivery Fee LBP
                     </label>
                     <input
                       type="number"
@@ -884,6 +1006,59 @@ const Orders = () => {
                     />
                   </div>
 
+                  {/* Third Party specific section - visible only when third party */}
+                  {formData.deliver_method === 'third_party' && (
+                    <>
+                      <div>
+                        <label className="block text-sm font-medium text-gray-700 mb-2">Third Party Fee USD</label>
+                        <input
+                          type="number"
+                          step="0.01"
+                          name="third_party_fee_usd"
+                          value={formData.third_party_fee_usd}
+                          onChange={handleInputChange}
+                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                        />
+                      </div>
+                      <div>
+                        <label className="block text-sm font-medium text-gray-700 mb-2">Third Party Fee LBP</label>
+                        <input
+                          type="number"
+                          name="third_party_fee_lbp"
+                          value={formData.third_party_fee_lbp}
+                          onChange={handleInputChange}
+                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                        />
+                      </div>
+                      <div>
+                        <label className="block text-sm font-medium text-gray-700 mb-2">Third Party Payment</label>
+                        <select
+                          name="payment_status"
+                          value={formData.payment_status}
+                          onChange={handleInputChange}
+                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                        >
+                          <option value="prepaid">Prepaid</option>
+                          <option value="unpaid">Unpaid</option>
+                          <option value="canceled">Canceled</option>
+                        </select>
+                      </div>
+                      <div>
+                        <label className="block text-sm font-medium text-gray-700 mb-2">Third Party Order Status</label>
+                        <select
+                          name="status"
+                          value={formData.status}
+                          onChange={handleInputChange}
+                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
+                        >
+                          <option value="on_road">Onroad</option>
+                          <option value="delivered">Delivered</option>
+                          <option value="canceled">Canceled</option>
+                        </select>
+                      </div>
+                    </>
+                  )}
+
                   {/* Status */}
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-2">
diff --git a/client/src/pages/PriceList.jsx b/client/src/pages/PriceList.jsx
index 8ae386a..bad38b5 100644
--- a/client/src/pages/PriceList.jsx
+++ b/client/src/pages/PriceList.jsx
@@ -16,6 +16,8 @@ const PriceList = () => {
     area: '',
     fee_usd: '',
     fee_lbp: '',
+    third_party_fee_usd: '',
+    third_party_fee_lbp: '',
     is_active: true
   });
 
@@ -42,6 +44,8 @@ const PriceList = () => {
           area: '',
           fee_usd: '',
           fee_lbp: '',
+          third_party_fee_usd: '',
+          third_party_fee_lbp: '',
           is_active: true
         });
         queryClient.invalidateQueries(['prices']);
@@ -130,7 +134,8 @@ const PriceList = () => {
     setShowEditModal(true);
   };
 
-  const filteredPrices = prices?.data?.filter(price => {
+  // prices is already the array due to select above
+  const filteredPrices = (prices || []).filter(price => {
     const matchesSearch = price.country.toLowerCase().includes(searchTerm.toLowerCase()) ||
                          price.area.toLowerCase().includes(searchTerm.toLowerCase());
     const matchesCountry = !filterCountry || price.country === filterCountry;
@@ -258,7 +263,10 @@ const PriceList = () => {
                   Location
                 </th>
                 <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
-                  Fees
+                  In-House Fees
+                </th>
+                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
+                  Third-Party Fees
                 </th>
                 <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                   Status
@@ -315,6 +323,25 @@ const PriceList = () => {
                         )}
                       </div>
                     </td>
+                    <td className="px-4 py-3 whitespace-nowrap">
+                      <div className="space-y-1">
+                        {price.third_party_fee_usd > 0 && (
+                          <div className="flex items-center space-x-2">
+                            <DollarSign className="h-4 w-4 text-green-600" />
+                            <span className="text-sm font-medium text-gray-900">
+                              ${price.third_party_fee_usd.toFixed(2)}
+                            </span>
+                          </div>
+                        )}
+                        {price.third_party_fee_lbp > 0 && (
+                          <div className="flex items-center space-x-2">
+                            <span className="text-sm font-medium text-gray-900">
+                              {price.third_party_fee_lbp.toLocaleString()} LBP
+                            </span>
+                          </div>
+                        )}
+                      </div>
+                    </td>
                     
                     <td className="px-4 py-3 whitespace-nowrap">
                       <button
@@ -415,7 +442,7 @@ const PriceList = () => {
                 <div className="grid grid-cols-2 gap-4">
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-1">
-                      Fee USD
+                      In-House Fee USD
                     </label>
                     <input
                       type="number"
@@ -429,7 +456,7 @@ const PriceList = () => {
                   
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-1">
-                      Fee LBP
+                      In-House Fee LBP
                     </label>
                     <input
                       type="number"
@@ -441,6 +468,35 @@ const PriceList = () => {
                   </div>
                 </div>
                 
+                <div className="grid grid-cols-2 gap-4">
+                  <div>
+                    <label className="block text-sm font-medium text-gray-700 mb-1">
+                      Third-Party Fee USD
+                    </label>
+                    <input
+                      type="number"
+                      step="0.01"
+                      placeholder="0.00"
+                      value={newPrice.third_party_fee_usd}
+                      onChange={(e) => setNewPrice(prev => ({ ...prev, third_party_fee_usd: e.target.value }))}
+                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
+                    />
+                  </div>
+                  
+                  <div>
+                    <label className="block text-sm font-medium text-gray-700 mb-1">
+                      Third-Party Fee LBP
+                    </label>
+                    <input
+                      type="number"
+                      placeholder="0"
+                      value={newPrice.third_party_fee_lbp}
+                      onChange={(e) => setNewPrice(prev => ({ ...prev, third_party_fee_lbp: e.target.value }))}
+                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
+                    />
+                  </div>
+                </div>
+                
                 <div className="flex items-center">
                   <input
                     type="checkbox"
@@ -526,7 +582,7 @@ const PriceList = () => {
                 <div className="grid grid-cols-2 gap-4">
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-1">
-                      Fee USD
+                      In-House Fee USD
                     </label>
                     <input
                       type="number"
@@ -539,7 +595,7 @@ const PriceList = () => {
                   
                   <div>
                     <label className="block text-sm font-medium text-gray-700 mb-1">
-                      Fee LBP
+                      In-House Fee LBP
                     </label>
                     <input
                       type="number"
@@ -550,6 +606,33 @@ const PriceList = () => {
                   </div>
                 </div>
                 
+                <div className="grid grid-cols-2 gap-4">
+                  <div>
+                    <label className="block text-sm font-medium text-gray-700 mb-1">
+                      Third-Party Fee USD
+                    </label>
+                    <input
+                      type="number"
+                      step="0.01"
+                      value={selectedPrice.third_party_fee_usd}
+                      onChange={(e) => setSelectedPrice(prev => ({ ...prev, third_party_fee_usd: e.target.value }))}
+                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
+                    />
+                  </div>
+                  
+                  <div>
+                    <label className="block text-sm font-medium text-gray-700 mb-1">
+                      Third-Party Fee LBP
+                    </label>
+                    <input
+                      type="number"
+                      value={selectedPrice.third_party_fee_lbp}
+                      onChange={(e) => setSelectedPrice(prev => ({ ...prev, third_party_fee_lbp: e.target.value }))}
+                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
+                    />
+                  </div>
+                </div>
+                
                 <div className="flex items-center">
                   <input
                     type="checkbox"
diff --git a/client/src/pages/Transactions.jsx b/client/src/pages/Transactions.jsx
deleted file mode 100644
index 9152c07..0000000
--- a/client/src/pages/Transactions.jsx
+++ /dev/null
@@ -1,918 +0,0 @@
-import React, { useState, useEffect } from 'react';
-import { useQuery, useMutation, useQueryClient } from 'react-query';
-import { motion, AnimatePresence } from 'framer-motion';
-import { Filter, Plus, DollarSign, TrendingUp, TrendingDown, Calendar, User, FileText, Download, Eye, Users, Truck, Building } from 'lucide-react';
-import { format } from 'date-fns';
-import { toast } from 'react-hot-toast';
-import api from '../api';
-
-const Transactions = () => {
-  const [filters, setFilters] = useState({
-    actor_type: '',
-    actor_id: '',
-    tx_type: '',
-    from_date: '',
-    to_date: '',
-    group_by: 'date' // 'date', 'person', 'type'
-  });
-  const [showAddModal, setShowAddModal] = useState(false);
-  const [selectedTransaction, setSelectedTransaction] = useState(null);
-  const [showDetailsModal, setShowDetailsModal] = useState(false);
-  const [selectedActor, setSelectedActor] = useState(null);
-  const [newTransaction, setNewTransaction] = useState({
-    tx_type: '',
-    amount_usd: '',
-    amount_lbp: '',
-    debit_account: '',
-    credit_account: '',
-    actor_type: '',
-    actor_id: '',
-    details: {},
-    // Structured form fields
-    order_id: '',
-    driver_id: '',
-    client_id: '',
-    fuel_amount: '',
-    delivery_fee: '',
-    third_party_fee: '',
-    description: ''
-  });
-
-  const queryClient = useQueryClient();
-
-  const { data: transactions, isLoading, error, refetch } = useQuery(
-    ['transactions', filters],
-    () => api.get('/transactions', { params: filters }),
-    {
-      refetchOnWindowFocus: false,
-      retry: 1
-    }
-  );
-
-  const { data: drivers } = useQuery(
-    ['drivers'],
-    () => api.get('/drivers'),
-    { 
-      refetchOnWindowFocus: false,
-      select: (response) => response.data?.data || []
-    }
-  );
-
-  const { data: clients } = useQuery(
-    ['clients'],
-    () => api.get('/clients'),
-    { 
-      refetchOnWindowFocus: false,
-      select: (response) => response.data?.data || []
-    }
-  );
-
-  const { data: orders } = useQuery(
-    ['orders'],
-    () => api.get('/orders'),
-    { 
-      refetchOnWindowFocus: false,
-      select: (response) => response.data?.data || []
-    }
-  );
-
-  const addTransactionMutation = useMutation(
-    (data) => api.post('/transactions', data),
-    {
-      onSuccess: () => {
-        toast.success('Transaction added successfully!');
-        setShowAddModal(false);
-        setNewTransaction({
-          tx_type: '',
-          amount_usd: '',
-          amount_lbp: '',
-          debit_account: '',
-          credit_account: '',
-          actor_type: '',
-          actor_id: '',
-          details: {},
-          order_id: '',
-          driver_id: '',
-          client_id: '',
-          fuel_amount: '',
-          delivery_fee: '',
-          third_party_fee: '',
-          description: ''
-        });
-        queryClient.invalidateQueries(['transactions']);
-      },
-      onError: (error) => {
-        toast.error(error.response?.data?.message || 'Failed to add transaction');
-      }
-    }
-  );
-
-  const handleFilterChange = (key, value) => {
-    setFilters(prev => ({ ...prev, [key]: value }));
-  };
-
-  const clearFilters = () => {
-    setFilters({
-      actor_type: '',
-      actor_id: '',
-      tx_type: '',
-      from_date: '',
-      to_date: '',
-      group_by: 'date'
-    });
-  };
-
-  const handleAddTransaction = () => {
-    if (!newTransaction.tx_type) {
-      toast.error('Please select a transaction type');
-      return;
-    }
-
-    // Build transaction data based on type
-    let transactionData = {
-      tx_type: newTransaction.tx_type,
-      actor_type: newTransaction.actor_type,
-      actor_id: newTransaction.actor_id,
-      details: {
-        description: newTransaction.description
-      }
-    };
-
-    // Handle different transaction types
-    switch (newTransaction.tx_type) {
-      case 'driver_fuel':
-        transactionData.amount_lbp = newTransaction.fuel_amount;
-        transactionData.actor_type = 'driver';
-        transactionData.actor_id = newTransaction.driver_id;
-        transactionData.details.description = `Driver ${getActorName({ actor_type: 'driver', actor_id: newTransaction.driver_id })} paid ${newTransaction.fuel_amount} LBP for gasoline`;
-        break;
-      
-      case 'order_payment':
-        transactionData.amount_usd = newTransaction.amount_usd;
-        transactionData.amount_lbp = newTransaction.delivery_fee;
-        transactionData.actor_type = 'client';
-        transactionData.actor_id = newTransaction.client_id;
-        transactionData.details.description = `Bought $${newTransaction.amount_usd} order for ${getActorName({ actor_type: 'client', actor_id: newTransaction.client_id })}, with ${newTransaction.delivery_fee} LBP delivery fee`;
-        break;
-      
-      case 'order_delivered':
-        transactionData.amount_usd = newTransaction.amount_usd;
-        transactionData.amount_lbp = newTransaction.delivery_fee;
-        transactionData.actor_type = 'client';
-        transactionData.actor_id = newTransaction.client_id;
-        transactionData.details.description = `Delivered $${newTransaction.amount_usd} order, customer paid ${newTransaction.delivery_fee} LBP delivery fee`;
-        break;
-      
-      case 'third_party_delivery':
-        transactionData.amount_usd = newTransaction.amount_usd;
-        transactionData.third_party_fee = newTransaction.third_party_fee;
-        transactionData.actor_type = 'third_party';
-        transactionData.details.description = `Third-party delivered $${newTransaction.amount_usd} order, took $${newTransaction.third_party_fee || 0} for their delivery and $${newTransaction.amount_usd - (newTransaction.third_party_fee || 0)} for ours`;
-        break;
-      
-      default:
-        transactionData.amount_usd = newTransaction.amount_usd;
-        transactionData.amount_lbp = newTransaction.amount_lbp;
-        transactionData.debit_account = newTransaction.debit_account;
-        transactionData.credit_account = newTransaction.credit_account;
-    }
-
-    addTransactionMutation.mutate(transactionData);
-  };
-
-  const exportToPDF = async (transaction) => {
-    try {
-      const response = await api.get(`/transactions/${transaction.id}/print`, {
-        responseType: 'blob'
-      });
-      
-      const url = window.URL.createObjectURL(new Blob([response.data]));
-      const link = document.createElement('a');
-      link.href = url;
-      link.setAttribute('download', `transaction-${transaction.id}.pdf`);
-      document.body.appendChild(link);
-      link.click();
-      link.remove();
-      
-      toast.success('Transaction exported successfully!');
-    } catch (error) {
-      toast.error('Failed to export transaction');
-    }
-  };
-
-  const viewTransactionDetails = (transaction) => {
-    setSelectedTransaction(transaction);
-    setShowDetailsModal(true);
-  };
-
-  const getTransactionTypeIcon = (txType) => {
-    switch (txType) {
-      case 'order':
-      case 'order_payment':
-      case 'order_delivered':
-        return <FileText className="h-4 w-4" />;
-      case 'driver_payment':
-      case 'driver_fuel':
-        return <Truck className="h-4 w-4" />;
-      case 'cash_in':
-        return <TrendingUp className="h-4 w-4" />;
-      case 'cash_out':
-        return <TrendingDown className="h-4 w-4" />;
-      case 'third_party_fee':
-      case 'third_party_delivery':
-        return <Building className="h-4 w-4" />;
-      default:
-        return <FileText className="h-4 w-4" />;
-    }
-  };
-
-  const getTransactionTypeColor = (txType) => {
-    switch (txType) {
-      case 'order':
-      case 'order_payment':
-      case 'order_delivered':
-        return 'bg-blue-100 text-blue-800';
-      case 'driver_payment':
-      case 'driver_fuel':
-        return 'bg-green-100 text-green-800';
-      case 'cash_in':
-        return 'bg-emerald-100 text-emerald-800';
-      case 'cash_out':
-        return 'bg-red-100 text-red-800';
-      case 'third_party_fee':
-      case 'third_party_delivery':
-        return 'bg-purple-100 text-purple-800';
-      default:
-        return 'bg-gray-100 text-gray-800';
-    }
-  };
-
-  const getActorName = (transaction) => {
-    if (transaction.actor_type === 'driver') {
-      const driver = Array.isArray(drivers) ? drivers.find(d => d.id === transaction.actor_id) : undefined;
-      return driver?.full_name || 'Unknown Driver';
-    } else if (transaction.actor_type === 'client') {
-      const client = Array.isArray(clients) ? clients.find(c => c.id === transaction.actor_id) : undefined;
-      return client?.business_name || 'Unknown Client';
-    }
-    return transaction.actor_type || 'System';
-  };
-
-  const getStructuredDescription = (transaction) => {
-    if (transaction.details?.description) {
-      return transaction.details.description;
-    }
-
-    const actorName = getActorName(transaction);
-    const amount = transaction.amount_usd > 0 ? `$${transaction.amount_usd}` : `${transaction.amount_lbp} LBP`;
-    
-    switch (transaction.tx_type) {
-      case 'driver_fuel':
-        return `Driver ${actorName} paid ${transaction.amount_lbp} LBP for gasoline`;
-      case 'order_payment':
-        return `Bought ${amount} order for ${actorName}, unpaid, with ${transaction.amount_lbp} LBP delivery fee`;
-      case 'order_delivered':
-        return `Delivered ${amount} order, customer paid ${transaction.amount_lbp} LBP delivery fee`;
-      case 'third_party_delivery':
-        return `Third-party delivered ${amount} order, took $${transaction.third_party_fee || 0} for their delivery and $${transaction.amount_usd - (transaction.third_party_fee || 0)} for ours`;
-      default:
-        return `${transaction.tx_type.replace('_', ' ')} - ${amount}`;
-    }
-  };
-
-  const groupTransactions = (transactions) => {
-    if (!transactions?.data || !Array.isArray(transactions.data)) {
-      console.log('ΓÜá∩╕Å Transactions data is not an array:', transactions);
-      return [];
-    }
-
-    switch (filters.group_by) {
-      case 'person':
-        const groupedByPerson = {};
-        transactions.data.forEach(tx => {
-          const key = `${tx.actor_type}_${tx.actor_id}`;
-          if (!groupedByPerson[key]) {
-            groupedByPerson[key] = {
-              actor: { type: tx.actor_type, id: tx.actor_id, name: getActorName(tx) },
-              transactions: []
-            };
-          }
-          groupedByPerson[key].transactions.push(tx);
-        });
-        return Object.values(groupedByPerson);
-
-      case 'type':
-        const groupedByType = {};
-        transactions.data.forEach(tx => {
-          if (!groupedByType[tx.tx_type]) {
-            groupedByType[tx.tx_type] = {
-              type: tx.tx_type,
-              transactions: []
-            };
-          }
-          groupedByType[tx.tx_type].transactions.push(tx);
-        });
-        return Object.values(groupedByType);
-
-      default: // date
-        const groupedByDate = {};
-        transactions.data.forEach(tx => {
-          const date = format(new Date(tx.created_at), 'yyyy-MM-dd');
-          if (!groupedByDate[date]) {
-            groupedByDate[date] = {
-              date,
-              transactions: []
-            };
-          }
-          groupedByDate[date].transactions.push(tx);
-        });
-        return Object.values(groupedByDate).sort((a, b) => new Date(b.date) - new Date(a.date));
-    }
-  };
-
-  if (isLoading) {
-    return (
-      <div className="flex items-center justify-center h-64">
-        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
-      </div>
-    );
-  }
-
-  if (error) {
-    return (
-      <div className="text-center py-8">
-        <p className="text-red-600">Error loading transactions</p>
-        <button 
-          onClick={() => refetch()}
-          className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
-        >
-          Retry
-        </button>
-      </div>
-    );
-  }
-
-  const groupedTransactions = groupTransactions(transactions);
-
-  return (
-    <div className="space-y-6">
-      {/* Header */}
-      <motion.div
-        initial={{ opacity: 0, y: -20 }}
-        animate={{ opacity: 1, y: 0 }}
-        className="flex items-center justify-between"
-      >
-        <div>
-          <h1 className="text-3xl font-bold text-gray-900">Transactions</h1>
-          <p className="text-gray-600 mt-2">Track all financial transactions with detailed structured forms</p>
-        </div>
-        <div className="flex items-center space-x-3">
-          <button
-            onClick={async () => {
-              const params = new URLSearchParams();
-              Object.entries(filters).forEach(([k, v]) => { if (v) params.set(k, v); });
-              const token = localStorage.getItem('token');
-              const apiBase = import.meta.env.VITE_API_URL || 'https://soufiam-erp-backend.onrender.com';
-              const resp = await fetch(`${apiBase}/api/transactions/export/csv?${params.toString()}`, {
-                headers: { Authorization: `Bearer ${token}` }
-              });
-              const blob = await resp.blob();
-              const url = URL.createObjectURL(blob);
-              const a = document.createElement('a');
-              a.href = url;
-              a.download = 'transactions_export.csv';
-              document.body.appendChild(a);
-              a.click();
-              a.remove();
-              URL.revokeObjectURL(url);
-            }}
-            className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
-          >
-            <Download className="h-4 w-4" />
-            <span>Export CSV</span>
-          </button>
-          <button
-            onClick={() => setShowAddModal(true)}
-            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2"
-          >
-            <Plus className="h-4 w-4" />
-            <span>Add Transaction</span>
-          </button>
-        </div>
-      </motion.div>
-
-      {/* Filters */}
-      <motion.div
-        initial={{ opacity: 0, y: -20 }}
-        animate={{ opacity: 1, y: 0 }}
-        transition={{ delay: 0.1 }}
-        className="bg-white rounded-lg shadow-sm border border-gray-200 p-6"
-      >
-        <div className="flex items-center space-x-2 mb-4">
-          <Filter className="h-5 w-5 text-gray-500" />
-          <h3 className="text-lg font-semibold text-gray-900">Filters</h3>
-        </div>
-        
-        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4">
-          <div>
-            <label className="block text-sm font-medium text-gray-700 mb-1">
-              Transaction Type
-            </label>
-            <select
-              value={filters.tx_type}
-              onChange={(e) => handleFilterChange('tx_type', e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-            >
-              <option value="">All Types</option>
-              <option value="driver_fuel">Driver Fuel</option>
-              <option value="order_payment">Order Payment</option>
-              <option value="order_delivered">Order Delivered</option>
-              <option value="third_party_delivery">Third Party Delivery</option>
-              <option value="cash_in">Cash In</option>
-              <option value="cash_out">Cash Out</option>
-            </select>
-          </div>
-          
-          <div>
-            <label className="block text-sm font-medium text-gray-700 mb-1">
-              Group By
-            </label>
-            <select
-              value={filters.group_by}
-              onChange={(e) => handleFilterChange('group_by', e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-            >
-              <option value="date">Date</option>
-              <option value="person">Person</option>
-              <option value="type">Type</option>
-            </select>
-          </div>
-          
-          <div>
-            <label className="block text-sm font-medium text-gray-700 mb-1">
-              From Date
-            </label>
-            <input
-              type="date"
-              value={filters.from_date}
-              onChange={(e) => handleFilterChange('from_date', e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-            />
-          </div>
-          
-          <div>
-            <label className="block text-sm font-medium text-gray-700 mb-1">
-              To Date
-            </label>
-            <input
-              type="date"
-              value={filters.to_date}
-              onChange={(e) => handleFilterChange('to_date', e.target.value)}
-              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-            />
-          </div>
-          
-          <div className="flex items-end">
-            <button
-              onClick={() => refetch()}
-              className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
-            >
-              Apply
-            </button>
-          </div>
-          
-          <div className="flex items-end">
-            <button
-              onClick={clearFilters}
-              className="w-full px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
-            >
-              Clear
-            </button>
-          </div>
-        </div>
-      </motion.div>
-
-      {/* Grouped Transactions */}
-      <motion.div
-        initial={{ opacity: 0, y: -20 }}
-        animate={{ opacity: 1, y: 0 }}
-        transition={{ delay: 0.2 }}
-        className="space-y-6"
-      >
-        {(groupedTransactions || []).map((group, groupIndex) => (
-          <motion.div
-            key={groupIndex}
-            initial={{ opacity: 0, y: 20 }}
-            animate={{ opacity: 1, y: 0 }}
-            transition={{ delay: groupIndex * 0.1 }}
-            className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
-          >
-            {/* Group Header */}
-            <div className="bg-gray-50 px-4 py-3 border-b border-gray-200">
-              <div className="flex items-center justify-between">
-                <div className="flex items-center space-x-3">
-                  {filters.group_by === 'person' && (
-                    <>
-                      <Users className="h-5 w-5 text-gray-500" />
-                      <div>
-                        <h3 className="text-lg font-semibold text-gray-900">{group.actor.name}</h3>
-                        <p className="text-sm text-gray-500 capitalize">{group.actor.type}</p>
-                      </div>
-                    </>
-                  )}
-                  {filters.group_by === 'type' && (
-                    <>
-                      {getTransactionTypeIcon(group.type)}
-                      <h3 className="text-lg font-semibold text-gray-900 capitalize">
-                        {group.type.replace('_', ' ')}
-                      </h3>
-                    </>
-                  )}
-                  {filters.group_by === 'date' && (
-                    <>
-                      <Calendar className="h-5 w-5 text-gray-500" />
-                      <h3 className="text-lg font-semibold text-gray-900">
-                        {format(new Date(group.date), 'EEEE, MMMM dd, yyyy')}
-                      </h3>
-                    </>
-                  )}
-                </div>
-                <div className="text-sm text-gray-500">
-                  {group.transactions.length} transaction{group.transactions.length !== 1 ? 's' : ''}
-                </div>
-              </div>
-            </div>
-
-            {/* Transactions in Group */}
-            <div className="divide-y divide-gray-200">
-              {(group.transactions || []).map((transaction) => (
-                <div key={transaction.id} className="p-6">
-                  <div className="flex items-center justify-between">
-                    <div className="flex items-center space-x-4">
-                      <div className={`p-2 rounded-lg ${getTransactionTypeColor(transaction.tx_type)}`}>
-                        {getTransactionTypeIcon(transaction.tx_type)}
-                      </div>
-                      
-                      <div className="space-y-1">
-                        <div className="flex items-center space-x-2">
-                          <span className="text-lg font-semibold text-gray-900">
-                            {transaction.tx_type.replace('_', ' ').toUpperCase()}
-                          </span>
-                          <span className="text-sm text-gray-500">
-                            #{transaction.id}
-                          </span>
-                        </div>
-                        
-                        <div className="text-sm text-gray-600">
-                          {getStructuredDescription(transaction)}
-                        </div>
-                        
-                        <div className="text-xs text-gray-500">
-                          {format(new Date(transaction.created_at), 'MMM dd, yyyy HH:mm')}
-                        </div>
-                      </div>
-                    </div>
-                    
-                    <div className="text-right space-y-1">
-                      {transaction.amount_usd > 0 && (
-                        <div className="text-lg font-semibold text-gray-900">
-                          ${transaction.amount_usd.toFixed(2)}
-                        </div>
-                      )}
-                      {transaction.amount_lbp > 0 && (
-                        <div className="text-lg font-semibold text-gray-900">
-                          {transaction.amount_lbp.toLocaleString()} LBP
-                        </div>
-                      )}
-                    </div>
-                    
-                    <div className="flex items-center space-x-2">
-                      <button
-                        onClick={() => viewTransactionDetails(transaction)}
-                        className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
-                        title="View Details"
-                      >
-                        <Eye className="h-4 w-4" />
-                      </button>
-                      <button
-                        onClick={() => exportToPDF(transaction)}
-                        className="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors"
-                        title="Export PDF"
-                      >
-                        <Download className="h-4 w-4" />
-                      </button>
-                    </div>
-                  </div>
-                </div>
-              ))}
-            </div>
-          </motion.div>
-        ))}
-        
-        {groupedTransactions.length === 0 && (
-          <div className="text-center py-12">
-            <FileText className="h-12 w-12 text-gray-400 mx-auto mb-4" />
-            <p className="text-gray-500 text-lg">No transactions found</p>
-            <p className="text-gray-400 text-sm">Try adjusting your filters or add a new transaction</p>
-          </div>
-        )}
-      </motion.div>
-
-      {/* Add Transaction Modal */}
-      {showAddModal && (
-        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
-          <motion.div
-            initial={{ opacity: 0, scale: 0.9 }}
-            animate={{ opacity: 1, scale: 1 }}
-            exit={{ opacity: 0, scale: 0.9 }}
-            className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
-          >
-            <div className="p-6">
-              <div className="flex items-center justify-between mb-6">
-                <h3 className="text-xl font-semibold text-gray-900">
-                  Add New Transaction
-                </h3>
-                <button
-                  onClick={() => setShowAddModal(false)}
-                  className="text-gray-400 hover:text-gray-600"
-                >
-                  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
-                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
-                  </svg>
-                </button>
-              </div>
-              
-              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
-                <div>
-                  <label className="block text-sm font-medium text-gray-700 mb-1">
-                    Transaction Type *
-                  </label>
-                  <select
-                    value={newTransaction.tx_type}
-                    onChange={(e) => setNewTransaction(prev => ({ ...prev, tx_type: e.target.value }))}
-                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                  >
-                    <option value="">Select Type</option>
-                    <option value="driver_fuel">Driver Fuel Payment</option>
-                    <option value="order_payment">Order Payment</option>
-                    <option value="order_delivered">Order Delivered</option>
-                    <option value="third_party_delivery">Third Party Delivery</option>
-                    <option value="cash_in">Cash In</option>
-                    <option value="cash_out">Cash Out</option>
-                  </select>
-                </div>
-
-                {/* Dynamic form fields based on transaction type */}
-                {newTransaction.tx_type === 'driver_fuel' && (
-                  <>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Driver *
-                      </label>
-                      <select
-                        value={newTransaction.driver_id}
-                        onChange={(e) => setNewTransaction(prev => ({ ...prev, driver_id: e.target.value }))}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                      >
-                        <option value="">Select Driver</option>
-                        {drivers?.map(driver => (
-                          <option key={driver.id} value={driver.id}>{driver.full_name}</option>
-                        ))}
-                      </select>
-                    </div>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Fuel Amount (LBP) *
-                      </label>
-                      <input
-                        type="number"
-                        placeholder="150000"
-                        value={newTransaction.fuel_amount}
-                        onChange={(e) => setNewTransaction(prev => ({ ...prev, fuel_amount: e.target.value }))}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                      />
-                    </div>
-                  </>
-                )}
-
-                {newTransaction.tx_type === 'order_payment' && (
-                  <>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Client *
-                      </label>
-                      <select
-                        value={newTransaction.client_id}
-                        onChange={(e) => setNewTransaction(prev => ({ ...prev, client_id: e.target.value }))}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                      >
-                        <option value="">Select Client</option>
-                        {clients?.map(client => (
-                          <option key={client.id} value={client.id}>{client.business_name}</option>
-                        ))}
-                      </select>
-                    </div>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Order Amount (USD) *
-                      </label>
-                      <input
-                        type="number"
-                        step="0.01"
-                        placeholder="20.00"
-                        value={newTransaction.amount_usd}
-                        onChange={(e) => setNewTransaction(prev => ({ ...prev, amount_usd: e.target.value }))}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                      />
-                    </div>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Delivery Fee (LBP) *
-                      </label>
-                      <input
-                        type="number"
-                        placeholder="200000"
-                        value={newTransaction.delivery_fee}
-                        onChange={(e) => setNewTransaction(prev => ({ ...prev, delivery_fee: e.target.value }))}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                      />
-                    </div>
-                  </>
-                )}
-
-                {newTransaction.tx_type === 'third_party_delivery' && (
-                  <>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Order Amount (USD) *
-                      </label>
-                      <input
-                        type="number"
-                        step="0.01"
-                        placeholder="50.00"
-                        value={newTransaction.amount_usd}
-                        onChange={(e) => setNewTransaction(prev => ({ ...prev, amount_usd: e.target.value }))}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                      />
-                    </div>
-                    <div>
-                      <label className="block text-sm font-medium text-gray-700 mb-1">
-                        Third Party Fee (USD) *
-                      </label>
-                      <input
-                        type="number"
-                        step="0.01"
-                        placeholder="3.00"
-                        value={newTransaction.third_party_fee}
-                        onChange={(e) => setNewTransaction(prev => ({ ...prev, third_party_fee: e.target.value }))}
-                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                      />
-                    </div>
-                  </>
-                )}
-
-                <div className="md:col-span-2">
-                  <label className="block text-sm font-medium text-gray-700 mb-1">
-                    Description
-                  </label>
-                  <textarea
-                    placeholder="Additional transaction details..."
-                    value={newTransaction.description}
-                    onChange={(e) => setNewTransaction(prev => ({ ...prev, description: e.target.value }))}
-                    rows={3}
-                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
-                  />
-                </div>
-              </div>
-              
-              <div className="flex items-center justify-end space-x-3 mt-6 pt-6 border-t border-gray-200">
-                <button
-                  onClick={() => setShowAddModal(false)}
-                  className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
-                >
-                  Cancel
-                </button>
-                <button
-                  onClick={handleAddTransaction}
-                  disabled={addTransactionMutation.isLoading}
-                  className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50"
-                >
-                  {addTransactionMutation.isLoading ? 'Adding...' : 'Add Transaction'}
-                </button>
-              </div>
-            </div>
-          </motion.div>
-        </div>
-      )}
-
-      {/* Transaction Details Modal */}
-      {showDetailsModal && selectedTransaction && (
-        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
-          <motion.div
-            initial={{ opacity: 0, scale: 0.9 }}
-            animate={{ opacity: 1, scale: 1 }}
-            exit={{ opacity: 0, scale: 0.9 }}
-            className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
-          >
-            <div className="p-6">
-              <div className="flex items-center justify-between mb-6">
-                <h3 className="text-xl font-semibold text-gray-900">
-                  Transaction Details - #{selectedTransaction.id}
-                </h3>
-                <button
-                  onClick={() => setShowDetailsModal(false)}
-                  className="text-gray-400 hover:text-gray-600"
-                >
-                  <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
-                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
-                  </svg>
-                </button>
-              </div>
-              
-              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
-                <div className="space-y-4">
-                  <div>
-                    <h4 className="font-medium text-gray-900 mb-2">Transaction Information</h4>
-                    <div className="space-y-2 text-sm">
-                      <div className="flex justify-between">
-                        <span className="text-gray-600">Type:</span>
-                        <span className="font-medium">{selectedTransaction.tx_type}</span>
-                      </div>
-                      <div className="flex justify-between">
-                        <span className="text-gray-600">Actor Type:</span>
-                        <span className="font-medium">{selectedTransaction.actor_type || 'N/A'}</span>
-                      </div>
-                      <div className="flex justify-between">
-                        <span className="text-gray-600">Actor Name:</span>
-                        <span className="font-medium">{getActorName(selectedTransaction)}</span>
-                      </div>
-                    </div>
-                  </div>
-                  
-                  <div>
-                    <h4 className="font-medium text-gray-900 mb-2">Financial Details</h4>
-                    <div className="space-y-2 text-sm">
-                      {selectedTransaction.amount_usd > 0 && (
-                        <div className="flex justify-between">
-                          <span className="text-gray-600">Amount USD:</span>
-                          <span className="font-medium">${selectedTransaction.amount_usd.toFixed(2)}</span>
-                        </div>
-                      )}
-                      {selectedTransaction.amount_lbp > 0 && (
-                        <div className="flex justify-between">
-                          <span className="text-gray-600">Amount LBP:</span>
-                          <span className="font-medium">{selectedTransaction.amount_lbp.toLocaleString()} LBP</span>
-                        </div>
-                      )}
-                    </div>
-                  </div>
-                </div>
-                
-                <div className="space-y-4">
-                  <div>
-                    <h4 className="font-medium text-gray-900 mb-2">Description</h4>
-                    <div className="bg-gray-50 p-4 rounded-lg">
-                      <p className="text-sm text-gray-600">
-                        {getStructuredDescription(selectedTransaction)}
-                      </p>
-                    </div>
-                  </div>
-                  
-                  <div>
-                    <h4 className="font-medium text-gray-900 mb-2">Timeline</h4>
-                    <div className="space-y-2 text-sm">
-                      <div className="flex justify-between">
-                        <span className="text-gray-600">Created:</span>
-                        <span className="font-medium">
-                          {format(new Date(selectedTransaction.created_at), 'MMM dd, yyyy HH:mm')}
-                        </span>
-                      </div>
-                    </div>
-                  </div>
-                </div>
-              </div>
-              
-              <div className="flex items-center justify-end space-x-3 mt-6 pt-6 border-t border-gray-200">
-                <button
-                  onClick={() => exportToPDF(selectedTransaction)}
-                  className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center space-x-2"
-                >
-                  <Download className="h-4 w-4" />
-                  <span>Export PDF</span>
-                </button>
-                <button
-                  onClick={() => setShowDetailsModal(false)}
-                  className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
-                >
-                  Close
-                </button>
-              </div>
-            </div>
-          </motion.div>
-        </div>
-      )}
-    </div>
-  );
-};
-
-export default Transactions;
diff --git a/client/src/utils/formatters.js b/client/src/utils/formatters.js
index a2fd8b8..2648e79 100644
--- a/client/src/utils/formatters.js
+++ b/client/src/utils/formatters.js
@@ -10,7 +10,7 @@ export const formatCurrency = (amount, currency = 'USD') => {
       maximumFractionDigits: 2,
     }).format(amount);
   } else if (currency === 'LBP') {
-    return new Intl.NumberFormat('ar-LB', {
+    return new Intl.NumberFormat('en-US', {
       style: 'currency',
       currency: 'LBP',
       minimumFractionDigits: 0,
diff --git a/server/config/database.js b/server/config/database.js
index 2fe6b9a..2f6b619 100644
--- a/server/config/database.js
+++ b/server/config/database.js
@@ -44,6 +44,11 @@ async function initializeDatabase() {
       const sslConfig = shouldEnableSsl ? { rejectUnauthorized: false } : undefined;
       const channelBinding = (new URL(rawUrl)).searchParams.get('channel_binding') || process.env.PG_CHANNEL_BINDING || 'require';
       console.log('≡ƒöÉ SSL enabled:', shouldEnableSsl, '| channel_binding:', channelBinding);
+      if (!/require/i.test(String(channelBinding || ''))) {
+        console.warn('ΓÜá∩╕Å channel_binding is not set to require. Neon may mandate this. Ensure your DATABASE_URL ends with channel_binding=require');
+      }
+
+      const slowMsThreshold = Number(process.env.PG_SLOW_MS || 200);
 
       const pool = new Pool({
         connectionString: rawUrl,
@@ -79,7 +84,12 @@ async function initializeDatabase() {
         try {
           const result = await pool.query(text, values);
           const duration = Date.now() - start;
-          console.log(`≡ƒôè Query executed in ${duration}ms: ${text.substring(0, 60)}...`);
+          const summary = text.replace(/\s+/g, ' ').trim().substring(0, 120);
+          if (duration > slowMsThreshold) {
+            console.warn(`≡ƒÉó Slow query (${duration}ms > ${slowMsThreshold}ms): ${summary}`);
+          } else {
+            console.log(`≡ƒôè Query executed in ${duration}ms: ${summary}...`);
+          }
           return result.rows || [];
         } catch (err) {
           console.error('Γ¥î Query error:', err.message);
@@ -99,7 +109,12 @@ async function initializeDatabase() {
         try {
           const result = await pool.query(pgText, values);
           const duration = Date.now() - start;
-          console.log(`≡ƒôè Run executed in ${duration}ms: ${pgText.substring(0, 60)}...`);
+          const summary = pgText.replace(/\s+/g, ' ').trim().substring(0, 120);
+          if (duration > slowMsThreshold) {
+            console.warn(`≡ƒÉó Slow run (${duration}ms > ${slowMsThreshold}ms): ${summary}`);
+          } else {
+            console.log(`≡ƒôè Run executed in ${duration}ms: ${summary}...`);
+          }
           if (/^insert\s+/i.test(pgText)) {
             const id = result.rows?.[0]?.id;
             return { id, changes: result.rowCount };
diff --git a/server/index.js b/server/index.js
index 974d4fc..8f2284c 100644
--- a/server/index.js
+++ b/server/index.js
@@ -53,16 +53,35 @@ const allowedOrigins = [
   ...parseEnvOrigins(),
   "http://localhost:5173",
   "http://localhost:5175",
+  "http://localhost:5176",
   "http://127.0.0.1:5173",
   "http://127.0.0.1:5175",
+  "http://127.0.0.1:5176",
   "https://runners-lb.vercel.app"
 ];
 
+function isDevLocalhost(origin) {
+  try {
+    const url = new URL(origin);
+    const isLocalHost = url.hostname === 'localhost' || url.hostname === '127.0.0.1';
+    return process.env.NODE_ENV !== 'production' && isLocalHost;
+  } catch {
+    return false;
+  }
+}
+
 console.log('≡ƒîÉ CORS allowed origins:', allowedOrigins);
 
+// Socket.IO with strict CORS: exact-match of requesting Origin
 const io = socketIo(server, {
   cors: {
-    origin: allowedOrigins,
+    origin: (origin, callback) => {
+      if (!origin) return callback(null, true);
+      const normalized = origin.replace(/\/$/, '');
+      const isAllowed = allowedOrigins.some(o => o.replace(/\/$/, '') === normalized) || isDevLocalhost(origin);
+      if (isAllowed) return callback(null, true);
+      return callback(new Error('Not allowed by CORS'));
+    },
     methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
     credentials: true,
     allowedHeaders: ["Content-Type", "Authorization", "X-Requested-With"]
@@ -81,23 +100,12 @@ app.use(compression());
 app.use(limiter);
 app.use(cors({
   origin: function (origin, callback) {
-    // Allow requests with no origin (like mobile apps or curl requests)
     if (!origin) return callback(null, true);
-
-    // Normalize origin (strip trailing slash)
     const normalized = origin.replace(/\/$/, '');
-
-    // Check if origin is in allowed list
-    if (allowedOrigins.some(o => o.replace(/\/$/, '') === normalized)) {
-      return callback(null, true);
-    }
-
-    // Allow localhost variations
-    if (origin.includes('localhost') || origin.includes('127.0.0.1')) {
+    if (allowedOrigins.some(o => o.replace(/\/$/, '') === normalized) || isDevLocalhost(origin)) {
       return callback(null, true);
     }
-
-    callback(new Error('Not allowed by CORS'));
+    return callback(new Error('Not allowed by CORS'));
   },
   credentials: true,
   methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
@@ -107,7 +115,14 @@ app.use(cors({
 
 // Ensure preflight requests are handled for all routes
 app.options('*', cors({
-  origin: allowedOrigins,
+  origin: function (origin, callback) {
+    if (!origin) return callback(null, true);
+    const normalized = origin.replace(/\/$/, '');
+    if (allowedOrigins.some(o => o.replace(/\/$/, '') === normalized) || isDevLocalhost(origin)) {
+      return callback(null, true);
+    }
+    return callback(new Error('Not allowed by CORS'));
+  },
   credentials: true,
   methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
   allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With'],
diff --git a/server/routes/accounting.js b/server/routes/accounting.js
index e6e1231..b1d2846 100644
--- a/server/routes/accounting.js
+++ b/server/routes/accounting.js
@@ -2,6 +2,7 @@ const express = require('express');
 const { query, run } = require('../config/database');
 const { authenticateToken } = require('../middleware/auth');
 const router = express.Router();
+const { getEntities, getEntityOrders, cashout } = require('../controllers/accountingController');
 
 // Get comprehensive accounting data
 router.get('/', authenticateToken, async (req, res) => {
@@ -1795,3 +1796,8 @@ router.get('/statement', authenticateToken, async (req, res) => {
 });
 
 module.exports = router;
+
+// New unified accounting endpoints
+router.get('/entities', authenticateToken, (req, res) => getEntities(req, res));
+router.get('/:type/:id/orders', authenticateToken, (req, res) => getEntityOrders(req, res));
+router.post('/cashout', authenticateToken, (req, res) => cashout(req, res));
diff --git a/server/routes/accountingEnhanced.js b/server/routes/accountingEnhanced.js
index 7536419..866afbc 100644
--- a/server/routes/accountingEnhanced.js
+++ b/server/routes/accountingEnhanced.js
@@ -29,7 +29,31 @@ router.get('/clients', authenticateToken, async (req, res) => {
       params.push(`%${search}%`, `%${search}%`);
     }
     
+    // Orders aggregates per client
     const clientsQuery = `
+      WITH orders_agg AS (
+        SELECT 
+          o.brand_name,
+          COUNT(o.id) AS orders_count,
+          COALESCE(SUM(o.total_usd),0) AS orders_total_usd,
+          COALESCE(SUM(o.total_lbp),0) AS orders_total_lbp,
+          COALESCE(SUM(o.delivery_fee_usd),0) AS fees_total_usd,
+          COALESCE(SUM(o.delivery_fee_lbp),0) AS fees_total_lbp
+        FROM orders o
+        ${whereClause}
+        GROUP BY o.brand_name
+      ),
+      payments_agg AS (
+        SELECT 
+          c.business_name,
+          COALESCE(SUM(CASE WHEN t.direction = 'credit' THEN t.amount_usd ELSE 0 END),0) AS payments_total_usd,
+          COALESCE(SUM(CASE WHEN t.direction = 'credit' THEN t.amount_lbp ELSE 0 END),0) AS payments_total_lbp,
+          COALESCE(SUM(CASE WHEN t.direction = 'debit' THEN t.amount_usd ELSE 0 END),0) AS debits_total_usd,
+          COALESCE(SUM(CASE WHEN t.direction = 'debit' THEN t.amount_lbp ELSE 0 END),0) AS debits_total_lbp
+        FROM clients c
+        LEFT JOIN transactions t ON t.actor_type = 'client' AND t.actor_id = c.id
+        GROUP BY c.business_name
+      )
       SELECT 
         c.id,
         c.business_name,
@@ -37,19 +61,24 @@ router.get('/clients', authenticateToken, async (req, res) => {
         c.phone,
         c.email,
         c.address,
-        COALESCE(SUM(o.total_usd), 0) as total_usd,
-        COALESCE(SUM(o.total_lbp), 0) as total_lbp,
-        COUNT(o.id) as order_count,
-        COALESCE(SUM(CASE WHEN o.payment_status = 'paid' THEN o.total_usd ELSE 0 END), 0) as paid_usd,
-        COALESCE(SUM(CASE WHEN o.payment_status = 'paid' THEN o.total_lbp ELSE 0 END), 0) as paid_lbp,
-        COALESCE(SUM(CASE WHEN o.payment_status = 'unpaid' THEN o.total_usd ELSE 0 END), 0) as unpaid_usd,
-        COALESCE(SUM(CASE WHEN o.payment_status = 'unpaid' THEN o.total_lbp ELSE 0 END), 0) as unpaid_lbp
+        COALESCE(oa.orders_count,0) AS orders_count,
+        COALESCE(oa.orders_total_usd,0) AS orders_total_usd,
+        COALESCE(oa.orders_total_lbp,0) AS orders_total_lbp,
+        COALESCE(oa.fees_total_usd,0) AS fees_total_usd,
+        COALESCE(oa.fees_total_lbp,0) AS fees_total_lbp,
+        COALESCE(pa.payments_total_usd,0) AS payments_total_usd,
+        COALESCE(pa.payments_total_lbp,0) AS payments_total_lbp,
+        COALESCE(pa.debits_total_usd,0) AS debits_total_usd,
+        COALESCE(pa.debits_total_lbp,0) AS debits_total_lbp,
+        0::numeric AS old_balance_usd,
+        0::bigint AS old_balance_lbp,
+        (COALESCE(oa.orders_total_usd,0) - COALESCE(pa.payments_total_usd,0) + COALESCE(pa.debits_total_usd,0)) AS new_balance_usd,
+        (COALESCE(oa.orders_total_lbp,0) - COALESCE(pa.payments_total_lbp,0) + COALESCE(pa.debits_total_lbp,0)) AS new_balance_lbp
       FROM clients c
-      LEFT JOIN orders o ON c.business_name = o.brand_name ${whereClause.replace('WHERE 1=1', '')}
-      GROUP BY c.id, c.business_name, c.contact_person, c.phone, c.email, c.address
+      LEFT JOIN orders_agg oa ON oa.brand_name = c.business_name
+      LEFT JOIN payments_agg pa ON pa.business_name = c.business_name
       ORDER BY c.business_name
     `;
-    
     const clients = await query(clientsQuery, params);
     
     res.json({
@@ -110,29 +139,50 @@ router.get('/clients/:id', authenticateToken, async (req, res) => {
     
     const orders = await query(ordersQuery, params);
     
-    // Calculate totals
+    // Totals and statement
     const totals = orders.reduce((acc, order) => {
-      acc.total_revenue_usd += parseFloat(order.total_usd || 0);
-      acc.total_revenue_lbp += parseInt(order.total_lbp || 0);
-      acc.total_expenses_usd += parseFloat(order.driver_fee_usd || 0) + parseFloat(order.third_party_fee_usd || 0);
-      acc.total_expenses_lbp += parseInt(order.driver_fee_lbp || 0) + parseInt(order.third_party_fee_lbp || 0);
+      acc.orders_total_usd += parseFloat(order.total_usd || 0);
+      acc.orders_total_lbp += parseInt(order.total_lbp || 0);
+      acc.fees_total_usd += parseFloat(order.delivery_fee_usd || 0);
+      acc.fees_total_lbp += parseInt(order.delivery_fee_lbp || 0);
       return acc;
-    }, {
-      total_revenue_usd: 0,
-      total_revenue_lbp: 0,
-      total_expenses_usd: 0,
-      total_expenses_lbp: 0
-    });
-    
-    totals.net_balance_usd = totals.total_revenue_usd - totals.total_expenses_usd;
-    totals.net_balance_lbp = totals.total_revenue_lbp - totals.total_expenses_lbp;
+    }, { orders_total_usd: 0, orders_total_lbp: 0, fees_total_usd: 0, fees_total_lbp: 0 });
+
+    // Payments and adjustments from transactions
+    const txWhere = ['t.actor_type = ?','t.actor_id = ?'];
+    const txParams = ['client', id];
+    if (from_date) { txWhere.push('t.created_at >= ?'); txParams.push(from_date); }
+    if (to_date) { txWhere.push('t.created_at <= ?'); txParams.push(to_date + ' 23:59:59'); }
+    const txSql = `
+      SELECT t.* FROM transactions t WHERE ${txWhere.join(' AND ')} ORDER BY t.created_at ASC
+    `;
+    const transactions = await query(txSql, txParams);
+    const payments_total_usd = transactions.reduce((s,t)=> s + (t.direction==='credit'? parseFloat(t.amount_usd||0):0), 0);
+    const payments_total_lbp = transactions.reduce((s,t)=> s + (t.direction==='credit'? parseInt(t.amount_lbp||0):0), 0);
+    const debits_total_usd = transactions.reduce((s,t)=> s + (t.direction==='debit'? parseFloat(t.amount_usd||0):0), 0);
+    const debits_total_lbp = transactions.reduce((s,t)=> s + (t.direction==='debit'? parseInt(t.amount_lbp||0):0), 0);
+
+    const old_balance_usd = 0;
+    const old_balance_lbp = 0;
+    const new_balance_usd = old_balance_usd + totals.orders_total_usd - payments_total_usd + debits_total_usd;
+    const new_balance_lbp = old_balance_lbp + totals.orders_total_lbp - payments_total_lbp + debits_total_lbp;
     
     res.json({
       success: true,
       data: {
         client,
         orders,
-        ...totals
+        transactions,
+        orders_total_usd: totals.orders_total_usd,
+        orders_total_lbp: totals.orders_total_lbp,
+        fees_total_usd: totals.fees_total_usd,
+        fees_total_lbp: totals.fees_total_lbp,
+        payments_total_usd,
+        payments_total_lbp,
+        old_balance_usd,
+        old_balance_lbp,
+        new_balance_usd,
+        new_balance_lbp
       }
     });
   } catch (error) {
diff --git a/server/routes/auth.js b/server/routes/auth.js
index 6af016e..143840d 100644
--- a/server/routes/auth.js
+++ b/server/routes/auth.js
@@ -52,11 +52,12 @@ router.post('/signup', async (req, res) => {
       { expiresIn: process.env.JWT_EXPIRES_IN || '24h' }
     );
 
-    // Set secure HTTP-only cookie with the token
+    // Set secure HTTP-only cookie with environment-aware SameSite/Secure
+    const isProd = process.env.NODE_ENV === 'production';
     res.cookie('authToken', token, {
       httpOnly: true,
-      secure: process.env.NODE_ENV === 'production',
-      sameSite: 'strict',
+      secure: isProd, // true only in production (requires HTTPS)
+      sameSite: isProd ? 'none' : 'lax', // allow cross-site XHR in prod, workable in dev
       maxAge: 24 * 60 * 60 * 1000, // 24 hours
       path: '/'
     });
@@ -127,11 +128,12 @@ router.post('/login', async (req, res) => {
     // Remove password from response
     const { password: _, ...userWithoutPassword } = user;
 
-    // Set secure HTTP-only cookie with the token
+    // Set secure HTTP-only cookie with environment-aware SameSite/Secure
+    const isProd = process.env.NODE_ENV === 'production';
     res.cookie('authToken', token, {
       httpOnly: true,
-      secure: process.env.NODE_ENV === 'production', // true in production (HTTPS)
-      sameSite: 'strict',
+      secure: isProd, // true only in production (requires HTTPS)
+      sameSite: isProd ? 'none' : 'lax',
       maxAge: 24 * 60 * 60 * 1000, // 24 hours
       path: '/'
     });
@@ -211,10 +213,11 @@ router.get('/me', async (req, res) => {
 // Logout user (clear both cookie and client-side token)
 router.post('/logout', (req, res) => {
   // Clear the HTTP-only cookie
+  const isProd = process.env.NODE_ENV === 'production';
   res.clearCookie('authToken', {
     httpOnly: true,
-    secure: process.env.NODE_ENV === 'production',
-    sameSite: 'strict',
+    secure: isProd,
+    sameSite: isProd ? 'none' : 'lax',
     path: '/'
   });
   
diff --git a/server/routes/cashbox.js b/server/routes/cashbox.js
index efa2d9a..37687e6 100644
--- a/server/routes/cashbox.js
+++ b/server/routes/cashbox.js
@@ -1,5 +1,5 @@
 const express = require('express');
-const { query, run } = require('../config/database');
+const { query, run, usdToLbp, lbpToUsd } = require('../config/database');
 const mcp = require('../mcp');
 const { authenticateToken, requireAnyRole } = require('../middleware/auth');
 const router = express.Router();
@@ -286,18 +286,24 @@ router.post('/income', authenticateToken, async (req, res) => {
       });
     }
 
+    // Compute missing currency
+    let incUsd = Number(amount_usd || 0);
+    let incLbp = Number(amount_lbp || 0);
+    if (incUsd > 0 && (!incLbp || incLbp === 0)) incLbp = await usdToLbp(incUsd);
+    if (incLbp > 0 && (!incUsd || incUsd === 0)) incUsd = await lbpToUsd(incLbp);
+
     // Get current balance
     const currentBalance = await getCashboxBalance();
     
     // Calculate new balance
-    const newBalanceUsd = currentBalance.balance_usd + (amount_usd || 0);
-    const newBalanceLbp = currentBalance.balance_lbp + (amount_lbp || 0);
+    const newBalanceUsd = currentBalance.balance_usd + incUsd;
+    const newBalanceLbp = currentBalance.balance_lbp + incLbp;
 
     // Create transaction record
     const transactionData = {
       tx_type: 'income',
-      amount_usd: amount_usd || 0,
-      amount_lbp: amount_lbp || 0,
+      amount_usd: incUsd,
+      amount_lbp: incLbp,
       description: description,
       category: 'income',
       direction: 'credit',
diff --git a/server/routes/dashboard.js b/server/routes/dashboard.js
index ffd1509..85c6a91 100644
--- a/server/routes/dashboard.js
+++ b/server/routes/dashboard.js
@@ -329,7 +329,6 @@ router.get('/process-timeline', authenticateToken, async (req, res) => {
         c.amount_lbp,
         c.description,
         c.created_at,
-        c.updated_at,
         u.full_name as created_by_name,
         d.full_name as driver_name
       FROM cashbox_entries c
diff --git a/server/routes/orderHistory.js b/server/routes/orderHistory.js
index 6ca11d6..8d36bc6 100644
--- a/server/routes/orderHistory.js
+++ b/server/routes/orderHistory.js
@@ -70,7 +70,12 @@ router.get('/', authenticateToken, async (req, res) => {
         d.phone as driver_phone,
         u.full_name as created_by_name,
         c.business_name as client_name,
-        c.contact_person as client_contact
+        c.contact_person as client_contact,
+        CASE 
+          WHEN o.third_party_name IS NOT NULL AND o.third_party_name <> '' THEN 'third_party'
+          WHEN o.driver_id IS NOT NULL THEN 'driver'
+          ELSE 'client'
+        END as account_type
       FROM orders o
       LEFT JOIN drivers d ON o.driver_id = d.id
       LEFT JOIN users u ON o.created_by = u.id
@@ -83,9 +88,16 @@ router.get('/', authenticateToken, async (req, res) => {
     filterParams.push(limit, offset);
     const ordersResult = await query(ordersQuery, filterParams);
 
+    // Group by account_type for UI tabs
+    const grouped = { client: [], driver: [], third_party: [] };
+    for (const row of ordersResult) {
+      const key = row.account_type || 'client';
+      if (grouped[key]) grouped[key].push(row);
+    }
+
     res.json({
       success: true,
-      data: ordersResult || [],
+      data: grouped,
       pagination: {
         page: parseInt(page),
         limit: parseInt(limit),
diff --git a/server/routes/orders.js b/server/routes/orders.js
index 1b7d8dd..3db35c4 100644
--- a/server/routes/orders.js
+++ b/server/routes/orders.js
@@ -117,9 +117,14 @@ router.get('/', authenticateToken, async (req, res) => {
 });
 
 // Get single order
-router.get('/:id', authenticateToken, async (req, res) => {
+// Constrain :id to digits to avoid conflicts with nested routes like /history
+router.get('/:id(\\d+)', authenticateToken, async (req, res) => {
   try {
     const { id } = req.params;
+    const numericId = Number(id);
+    if (!Number.isInteger(numericId) || numericId <= 0) {
+      return res.status(400).json({ success: false, message: 'Invalid order id' });
+    }
     
     const orderQuery = `
       SELECT 
@@ -133,7 +138,7 @@ router.get('/:id', authenticateToken, async (req, res) => {
       WHERE o.id = ?
     `;
     
-    const result = await query(orderQuery, [id]);
+    const result = await query(orderQuery, [numericId]);
     
     if (result.length === 0) {
       return res.status(404).json({ 
@@ -169,6 +174,8 @@ router.post('/', authenticateToken, async (req, res) => {
       customer_address,
       deliver_to, // Frontend field name
       brand_name,
+      client,
+      client_name,
       voucher_code,
       voucher, // Frontend field name
       deliver_method = 'in_house',
@@ -211,6 +218,7 @@ router.post('/', authenticateToken, async (req, res) => {
     
     // Map frontend fields to backend fields
     const finalCustomerName = customer_name || deliver_to || '';
+    const finalBrandOrClient = client || client_name || brand_name || '';
     const finalVoucherCode = voucher_code || voucher || '';
     const finalNotes = notes || order_note || '';
     const finalTotalUsd = total_usd || fees_usd || 0;
@@ -228,11 +236,11 @@ router.post('/', authenticateToken, async (req, res) => {
 
     if (delivery_region) {
       try {
-        const priceQuery = `
+        let priceQuery = `
           SELECT * FROM delivery_prices 
           WHERE country = ? AND region = ? AND is_active = 1
         `;
-        let priceParams = [delivery_country, delivery_region];
+        const priceParams = [delivery_country, delivery_region];
 
         if (delivery_sub_region) {
           priceQuery += ` AND sub_region = ?`;
@@ -250,26 +258,23 @@ router.post('/', authenticateToken, async (req, res) => {
           deliveryPriceId = deliveryPrice.id;
           deliveryFeeLbp = deliveryPrice.price_lbp;
           deliveryFeeUsd = deliveryPrice.price_usd;
-        } else {
+        } else if (delivery_sub_region) {
           // Try without sub_region if no exact match found
-          if (delivery_sub_region) {
-            const fallbackQuery = `
-              SELECT * FROM delivery_prices 
-              WHERE country = ? AND region = ? AND sub_region IS NULL AND is_active = 1
-              ORDER BY created_at DESC LIMIT 1
-            `;
-            const fallbackResult = await query(fallbackQuery, [delivery_country, delivery_region]);
-            
-            if (fallbackResult.length > 0) {
-              const deliveryPrice = fallbackResult[0];
-              deliveryPriceId = deliveryPrice.id;
-              deliveryFeeLbp = deliveryPrice.price_lbp;
-              deliveryFeeUsd = deliveryPrice.price_usd;
-            }
+          const fallbackQuery = `
+            SELECT * FROM delivery_prices 
+            WHERE country = ? AND region = ? AND sub_region IS NULL AND is_active = 1
+            ORDER BY created_at DESC LIMIT 1
+          `;
+          const fallbackResult = await query(fallbackQuery, [delivery_country, delivery_region]);
+          if (fallbackResult.length > 0) {
+            const deliveryPrice = fallbackResult[0];
+            deliveryPriceId = deliveryPrice.id;
+            deliveryFeeLbp = deliveryPrice.price_lbp;
+            deliveryFeeUsd = deliveryPrice.price_usd;
           }
         }
       } catch (error) {
-        console.warn('Error looking up delivery price:', error.message);
+        console.error('Error looking up delivery price:', error.stack || error);
         // Continue with manual fees if lookup fails
       }
     }
@@ -282,7 +287,7 @@ router.post('/', authenticateToken, async (req, res) => {
       customer_phone: customer_phone || '',
       customer_name: finalCustomerName,
       customer_address: customer_address || '',
-      brand_name: brand_name || '',
+      brand_name: finalBrandOrClient,
       voucher_code: finalVoucherCode,
       deliver_method: deliver_method,
       delivery_mode: finalDeliveryMode,
@@ -306,7 +311,7 @@ router.post('/', authenticateToken, async (req, res) => {
       delivery_price_id: deliveryPriceId,
       status: status,
       payment_status: payment_status,
-      prepaid_status: prepaid_status,
+      prepaid_status: prepaid_status === true || prepaid_status === 'prepaid' ? 1 : 0,
       latitude: latitude || null,
       longitude: longitude || null,
       location_text: location_text || '',
@@ -316,6 +321,44 @@ router.post('/', authenticateToken, async (req, res) => {
 
     const result = await mcp.create('orders', orderData);
 
+    // Compute and persist displayed totals on the newly created order
+    try {
+      const { computeDisplayedAmounts } = require('../utils/computeDisplayedAmounts');
+      const computed = computeDisplayedAmounts({
+        total_usd: orderData.total_usd,
+        total_lbp: orderData.total_lbp,
+        delivery_fee_usd: orderData.delivery_fee_usd,
+        delivery_fee_lbp: orderData.delivery_fee_lbp,
+        third_party_fee_usd: orderData.third_party_fee_usd,
+        third_party_fee_lbp: orderData.third_party_fee_lbp,
+        driver_fee_usd: orderData.driver_fee_usd,
+        driver_fee_lbp: orderData.driver_fee_lbp,
+        deliver_method: orderData.deliver_method,
+        type: orderData.type,
+        order_type: orderData.type,
+        delivery_mode: orderData.delivery_mode
+      });
+      await mcp.update('orders', result.id, {
+        computed_total_usd: computed.computedTotalUSD,
+        computed_total_lbp: computed.computedTotalLBP
+      });
+    } catch (e) {
+      console.warn('computeDisplayedAmounts failed:', e.message);
+    }
+
+    // Create cashbox reservation for go-to-market orders
+    try {
+      if (finalType === 'go_to_market') {
+        await mcp.create('cashbox_reservations', {
+          order_id: result.id,
+          amount_usd: orderData.total_usd || 0,
+          amount_lbp: orderData.total_lbp || 0
+        });
+      }
+    } catch (e) {
+      console.warn('cashbox reservation create failed:', e.message);
+    }
+
     // Fetch the created order with joins
     const orderQuery = `
       SELECT 
@@ -349,10 +392,13 @@ router.post('/', authenticateToken, async (req, res) => {
       data: orderResult[0]
     });
   } catch (error) {
-    console.error('Error creating order:', error);
+    console.error('Error creating order:', error.stack || error);
+    const friendly = (/(does not exist|no such column|foreign key|constraint)/i).test(error.message || '')
+      ? 'Database constraint or missing column. Check schema and payload.'
+      : 'Failed to create order';
     res.status(500).json({ 
       success: false, 
-      message: 'Failed to create order',
+      message: friendly,
       error: error.message 
     });
   }
@@ -420,7 +466,7 @@ router.put('/:id', authenticateToken, async (req, res) => {
 router.patch('/:id', authenticateToken, async (req, res) => {
   try {
     const { id } = req.params;
-    const { status, payment_status } = req.body;
+    const { status, payment_status, driver_id, fee_usd, fee_lbp, delivery_fee_usd, delivery_fee_lbp, notes } = req.body;
 
     // Validate input
     if (!status && !payment_status) {
@@ -440,6 +486,12 @@ router.patch('/:id', authenticateToken, async (req, res) => {
     const updateData = {};
     if (status) updateData.status = status;
     if (payment_status) updateData.payment_status = payment_status;
+    if (driver_id !== undefined) updateData.driver_id = driver_id;
+    if (notes !== undefined) updateData.notes = notes;
+    if (fee_usd !== undefined) updateData.fee_usd = Number(fee_usd) || 0;
+    if (fee_lbp !== undefined) updateData.fee_lbp = Number(fee_lbp) || 0;
+    if (delivery_fee_usd !== undefined) updateData.delivery_fee_usd = Number(delivery_fee_usd) || 0;
+    if (delivery_fee_lbp !== undefined) updateData.delivery_fee_lbp = Number(delivery_fee_lbp) || 0;
     
     // Set completed_at if status becomes delivered or completed
     if (status === 'delivered' || status === 'completed') {
@@ -475,13 +527,13 @@ router.patch('/:id', authenticateToken, async (req, res) => {
         }
 
         // Create transaction for third-party payout if any
-        if ((order.third_party_fee_usd || 0) > 0 || (order.third_party_fee_lbp || 0) > 0) {
+        if (order.delivery_mode === 'third_party' && ((order.third_party_fee_usd || 0) > 0 || (order.third_party_fee_lbp || 0) > 0)) {
           await mcp.create('transactions', {
             tx_type: 'third_party_payout',
             amount_usd: order.third_party_fee_usd || 0,
             amount_lbp: order.third_party_fee_lbp || 0,
             actor_type: 'third_party',
-            actor_id: null,
+            actor_id: order.third_party_id || null,
             description: 'Third-party payout',
             order_id: id,
             category: 'payout',
@@ -612,6 +664,7 @@ router.post('/:id/complete', authenticateToken, async (req, res) => {
       return res.status(404).json({ success: false, message: 'Order not found' });
     }
 
+    // Start atomic section: ensure cashbox + transactions + order update are consistent
     // Update status, payment_status, and completed_at
     await mcp.update('orders', id, {
       status: status,
@@ -651,14 +704,14 @@ router.post('/:id/complete', authenticateToken, async (req, res) => {
       });
     }
 
-    // Ledger: third-party payout if any
-    if ((order.third_party_fee_lbp || 0) > 0) {
+    // Ledger: third-party payout if any for third_party mode
+    if (order.delivery_mode === 'third_party' && ((order.third_party_fee_usd || 0) > 0 || (order.third_party_fee_lbp || 0) > 0)) {
       await mcp.create('transactions', {
         tx_type: 'third_party_payout',
         amount_usd: order.third_party_fee_usd || 0,
         amount_lbp: order.third_party_fee_lbp || 0,
         actor_type: 'third_party',
-        actor_id: null,
+        actor_id: order.third_party_id || null,
         description: 'Third-party payout',
         order_id: id,
         category: 'payout',
@@ -683,6 +736,16 @@ router.post('/:id/complete', authenticateToken, async (req, res) => {
       });
     }
 
+    // Append order history
+    try {
+      await mcp.create('order_history', {
+        order_id: id,
+        action: 'complete',
+        actor: req.user?.id ? String(req.user.id) : 'system',
+        details: { status, payment_status }
+      });
+    } catch {}
+
     // Emit update event
     try {
       const io = req.app.get('io');
diff --git a/server/routes/ordersBatch.js b/server/routes/ordersBatch.js
index c50a9c2..15714fb 100644
--- a/server/routes/ordersBatch.js
+++ b/server/routes/ordersBatch.js
@@ -1,5 +1,5 @@
 const express = require('express');
-const { query, run } = require('../config/database');
+const { query, run, usdToLbp, lbpToUsd } = require('../config/database');
 const { authenticateToken } = require('../middleware/auth');
 const router = express.Router();
 
@@ -26,9 +26,11 @@ router.post('/', authenticateToken, async (req, res) => {
       const orderData = orders[i];
       
       try {
-        // Validate required fields
-        if (!orderData.brand_name && !orderData.customer_name) {
-          errors.push(`Order ${i + 1}: brand_name or customer_name is required`);
+        // Adapter mappings and validations
+        const clientName = orderData.client_name || orderData.client || orderData.brand_name || '';
+        const customerName = orderData.customer || orderData.customer_name || '';
+        if (!clientName && !customerName) {
+          errors.push(`Order ${i + 1}: client/brand_name or customer_name is required`);
           continue;
         }
 
@@ -41,9 +43,9 @@ router.post('/', authenticateToken, async (req, res) => {
           type: orderData.type || 'ecommerce',
           is_purchase: orderData.is_purchase ? 1 : 0,
           customer_phone: orderData.customer_phone || '',
-          customer_name: orderData.customer_name || '',
+          customer_name: customerName,
           customer_address: orderData.customer_address || '',
-          brand_name: orderData.brand_name || '',
+          brand_name: clientName,
           voucher_code: orderData.voucher_code || '',
           deliver_method: orderData.deliver_method || 'in_house',
           delivery_mode: orderData.delivery_mode || 'direct',
@@ -55,36 +57,65 @@ router.post('/', authenticateToken, async (req, res) => {
           driver_fee_lbp: parseInt(orderData.driver_fee_lbp) || 0,
           instant: orderData.instant ? 1 : 0,
           notes: orderData.notes || '',
-          total_usd: parseFloat(orderData.total_usd) || 0,
-          total_lbp: parseInt(orderData.total_lbp) || 0,
-          delivery_fee_usd: parseFloat(orderData.delivery_fee_usd) || 0,
-          delivery_fee_lbp: parseInt(orderData.delivery_fee_lbp) || 0,
+          total_usd: 0,
+          total_lbp: 0,
+          delivery_fee_usd: 0,
+          delivery_fee_lbp: 0,
           status: orderData.status || 'new',
           payment_status: orderData.payment_status || 'unpaid',
-          prepaid_status: orderData.prepaid_status || 'unpaid',
+          prepaid_status: Boolean(orderData.prepaid_status) || false,
           latitude: orderData.latitude || null,
           longitude: orderData.longitude || null,
           location_text: orderData.location_text || '',
           created_by: req.user.id
         };
 
+        // Map potential driver_fees to delivery fees if frontend sends wrong key
+        const deliveryFeeUsdInput = orderData.delivery_fee_usd ?? orderData.fee_usd ?? orderData.fees_usd ?? orderData.driver_fees_usd ?? orderData.driver_fee_usd ?? 0;
+        const deliveryFeeLbpInput = orderData.delivery_fee_lbp ?? orderData.fee_lbp ?? orderData.fees_lbp ?? orderData.driver_fees_lbp ?? orderData.driver_fee_lbp ?? 0;
+
+        // Dual currency compute for delivery fees
+        let dfUsd = Number(deliveryFeeUsdInput) || 0;
+        let dfLbp = Number(deliveryFeeLbpInput) || 0;
+        if (dfUsd > 0 && (!dfLbp || dfLbp === 0)) {
+          dfLbp = await usdToLbp(dfUsd);
+        } else if (dfLbp > 0 && (!dfUsd || dfUsd === 0)) {
+          dfUsd = await lbpToUsd(dfLbp);
+        }
+        order.delivery_fee_usd = dfUsd;
+        order.delivery_fee_lbp = dfLbp;
+
+        // Dual currency compute for totals if provided
+        let totUsd = Number(orderData.total_usd || 0);
+        let totLbp = Number(orderData.total_lbp || 0);
+        if (totUsd > 0 && (!totLbp || totLbp === 0)) {
+          totLbp = await usdToLbp(totUsd);
+        } else if (totLbp > 0 && (!totUsd || totUsd === 0)) {
+          totUsd = await lbpToUsd(totLbp);
+        }
+        order.total_usd = totUsd;
+        order.total_lbp = totLbp;
+
+        // Support third_party_id if provided
+        const thirdPartyId = orderData.third_party_id || null;
+
         // Insert order
         const insertQuery = `
           INSERT INTO orders (
             order_ref, type, is_purchase, customer_phone, customer_name, customer_address,
-            brand_name, voucher_code, deliver_method, delivery_mode, third_party_name,
+            brand_name, voucher_code, deliver_method, delivery_mode, third_party_name, third_party_id,
             third_party_fee_usd, third_party_fee_lbp, driver_id, driver_fee_usd, driver_fee_lbp,
             instant, notes, total_usd, total_lbp, delivery_fee_usd, delivery_fee_lbp,
             status, payment_status, prepaid_status, latitude, longitude, location_text, created_by
           ) VALUES (
-            $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29
+            $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26, $27, $28, $29, $30
           ) RETURNING *
         `;
 
         const values = [
           order.order_ref, order.type, order.is_purchase, order.customer_phone, order.customer_name,
           order.customer_address, order.brand_name, order.voucher_code, order.deliver_method,
-          order.delivery_mode, order.third_party_name, order.third_party_fee_usd, order.third_party_fee_lbp,
+          order.delivery_mode, order.third_party_name, thirdPartyId, order.third_party_fee_usd, order.third_party_fee_lbp,
           order.driver_id, order.driver_fee_usd, order.driver_fee_lbp, order.instant, order.notes,
           order.total_usd, order.total_lbp, order.delivery_fee_usd, order.delivery_fee_lbp,
           order.status, order.payment_status, order.prepaid_status, order.latitude, order.longitude,
diff --git a/server/routes/priceList.js b/server/routes/priceList.js
index 845f6b0..bd5d650 100644
--- a/server/routes/priceList.js
+++ b/server/routes/priceList.js
@@ -6,7 +6,7 @@ const router = express.Router();
 // Get all price list items
 router.get('/', authenticateToken, async (req, res) => {
   try {
-    const { page = 1, limit = 20, country = '', area = '' } = req.query;
+    const { page = 1, limit = 20, country = '', area = '', search = '' } = req.query;
     const offset = (page - 1) * limit;
     
     let whereClause = '';
@@ -25,6 +25,16 @@ router.get('/', authenticateToken, async (req, res) => {
       params.push(`%${area}%`);
     }
 
+    if (search) {
+      if (whereClause) {
+        whereClause += ' AND (LOWER(country) LIKE LOWER(?) OR LOWER(area) LIKE LOWER(?))';
+        params.push(`%${search}%`, `%${search}%`);
+      } else {
+        whereClause = 'WHERE (LOWER(country) LIKE LOWER(?) OR LOWER(area) LIKE LOWER(?))';
+        params.push(`%${search}%`, `%${search}%`);
+      }
+    }
+
     // Get total count
     const countQuery = `SELECT COUNT(*) as count FROM price_list ${whereClause}`;
     const countResult = await query(countQuery, params);
@@ -32,7 +42,14 @@ router.get('/', authenticateToken, async (req, res) => {
 
     // Get price list items
     const priceListQuery = `
-      SELECT id, country, area, fees_usd as fee_usd, fees_lbp as fee_lbp, created_at, updated_at FROM price_list
+      SELECT id, country, area, 
+             COALESCE(fees_usd, 0) as fee_usd, 
+             COALESCE(fees_lbp, 0) as fee_lbp, 
+             COALESCE(third_party_fee_usd, 0) as third_party_fee_usd, 
+             COALESCE(third_party_fee_lbp, 0) as third_party_fee_lbp,
+             COALESCE(is_active, true) as is_active,
+             created_at, updated_at 
+      FROM price_list
       ${whereClause}
       ORDER BY country, area
       LIMIT ? OFFSET ?
@@ -66,7 +83,7 @@ router.get('/:id', authenticateToken, async (req, res) => {
   try {
     const { id } = req.params;
     
-    const priceListQuery = 'SELECT id, country, area, fees_usd as fee_usd, fees_lbp as fee_lbp, created_at, updated_at FROM price_list WHERE id = ?';
+    const priceListQuery = 'SELECT id, country, area, fees_usd as fee_usd, fees_lbp as fee_lbp, COALESCE(is_active, true) as is_active, created_at, updated_at FROM price_list WHERE id = ?';
     const result = await query(priceListQuery, [id]);
     
     if (result.length === 0) {
@@ -90,6 +107,54 @@ router.get('/:id', authenticateToken, async (req, res) => {
   }
 });
 
+// Search price list items for autocomplete
+router.get('/search', authenticateToken, async (req, res) => {
+  try {
+    const { q = '' } = req.query;
+    
+    if (!q || q.length < 2) {
+      return res.json({
+        success: true,
+        data: []
+      });
+    }
+
+    const searchQuery = `
+      SELECT id, country, area, 
+             COALESCE(fees_usd, 0) as fee_usd, 
+             COALESCE(fees_lbp, 0) as fee_lbp, 
+             COALESCE(third_party_fee_usd, 0) as third_party_fee_usd, 
+             COALESCE(third_party_fee_lbp, 0) as third_party_fee_lbp
+      FROM price_list 
+      WHERE (LOWER(country) LIKE LOWER(?) OR LOWER(area) LIKE LOWER(?))
+      AND COALESCE(is_active, true) = true
+      ORDER BY 
+        CASE 
+          WHEN LOWER(area) LIKE LOWER(?) THEN 1
+          WHEN LOWER(country) LIKE LOWER(?) THEN 2
+          ELSE 3
+        END,
+        country, area
+      LIMIT 10
+    `;
+    
+    const searchTerm = `%${q}%`;
+    const result = await query(searchQuery, [searchTerm, searchTerm, searchTerm, searchTerm]);
+
+    res.json({
+      success: true,
+      data: result
+    });
+  } catch (error) {
+    console.error('Error searching price list:', error);
+    res.status(500).json({ 
+      success: false, 
+      message: 'Failed to search price list',
+      error: error.message 
+    });
+  }
+});
+
 // Create new price list item
 router.post('/', authenticateToken, async (req, res) => {
   try {
@@ -97,7 +162,10 @@ router.post('/', authenticateToken, async (req, res) => {
       country,
       area,
       fee_usd = 0,
-      fee_lbp = 200000
+      fee_lbp = 0,
+      third_party_fee_usd = 0,
+      third_party_fee_lbp = 0,
+      is_active = true
     } = req.body;
 
     if (!country || !area) {
@@ -108,15 +176,24 @@ router.post('/', authenticateToken, async (req, res) => {
     }
 
     const insertQuery = `
-      INSERT INTO price_list (country, area, fees_usd, fees_lbp)
-      VALUES (?, ?, ?, ?)
+      INSERT INTO price_list (country, area, fees_usd, fees_lbp, third_party_fee_usd, third_party_fee_lbp, is_active)
+      VALUES (?, ?, ?, ?, ?, ?, ?)
     `;
 
-    const params = [country, area, fee_usd, fee_lbp];
+    const params = [country, area, fee_usd, fee_lbp, third_party_fee_usd, third_party_fee_lbp, is_active];
     const result = await run(insertQuery, params);
 
     // Fetch the created item
-    const priceListQuery = 'SELECT id, country, area, fees_usd as fee_usd, fees_lbp as fee_lbp, created_at, updated_at FROM price_list WHERE id = ?';
+    const priceListQuery = `
+      SELECT id, country, area, 
+             COALESCE(fees_usd, 0) as fee_usd, 
+             COALESCE(fees_lbp, 0) as fee_lbp, 
+             COALESCE(third_party_fee_usd, 0) as third_party_fee_usd, 
+             COALESCE(third_party_fee_lbp, 0) as third_party_fee_lbp,
+             COALESCE(is_active, true) as is_active,
+             created_at, updated_at 
+      FROM price_list WHERE id = ?
+    `;
     const priceListResult = await query(priceListQuery, [result.id]);
 
     res.status(201).json({
@@ -161,7 +238,16 @@ router.put('/:id', authenticateToken, async (req, res) => {
     await run(updateQuery, values);
 
     // Fetch the updated item
-    const priceListQuery = 'SELECT id, country, area, fees_usd as fee_usd, fees_lbp as fee_lbp, created_at, updated_at FROM price_list WHERE id = ?';
+    const priceListQuery = `
+      SELECT id, country, area, 
+             COALESCE(fees_usd, 0) as fee_usd, 
+             COALESCE(fees_lbp, 0) as fee_lbp, 
+             COALESCE(third_party_fee_usd, 0) as third_party_fee_usd, 
+             COALESCE(third_party_fee_lbp, 0) as third_party_fee_lbp,
+             is_active,
+             created_at, updated_at 
+      FROM price_list WHERE id = ?
+    `;
     const priceListResult = await query(priceListQuery, [id]);
 
     if (priceListResult.length === 0) {
@@ -186,6 +272,50 @@ router.put('/:id', authenticateToken, async (req, res) => {
   }
 });
 
+// Toggle price list item status
+router.patch('/:id/toggle-status', authenticateToken, async (req, res) => {
+  try {
+    const { id } = req.params;
+    const { is_active } = req.body;
+
+    const updateQuery = `UPDATE price_list SET is_active = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?`;
+    await run(updateQuery, [is_active ? 1 : 0, id]);
+
+    // Fetch the updated item
+    const priceListQuery = `
+      SELECT id, country, area, 
+             COALESCE(fees_usd, 0) as fee_usd, 
+             COALESCE(fees_lbp, 0) as fee_lbp, 
+             COALESCE(third_party_fee_usd, 0) as third_party_fee_usd, 
+             COALESCE(third_party_fee_lbp, 0) as third_party_fee_lbp,
+             COALESCE(is_active, true) as is_active,
+             created_at, updated_at 
+      FROM price_list WHERE id = ?
+    `;
+    const priceListResult = await query(priceListQuery, [id]);
+
+    if (priceListResult.length === 0) {
+      return res.status(404).json({ 
+        success: false, 
+        message: 'Price list item not found' 
+      });
+    }
+
+    res.json({
+      success: true,
+      message: 'Price list item status updated successfully',
+      data: priceListResult[0]
+    });
+  } catch (error) {
+    console.error('Error toggling price list item status:', error);
+    res.status(500).json({ 
+      success: false, 
+      message: 'Failed to update price list item status',
+      error: error.message 
+    });
+  }
+});
+
 // Delete price list item
 router.delete('/:id', authenticateToken, async (req, res) => {
   try {
diff --git a/server/scripts/ensureNeonSetup.js b/server/scripts/ensureNeonSetup.js
index f122b7b..52db065 100644
--- a/server/scripts/ensureNeonSetup.js
+++ b/server/scripts/ensureNeonSetup.js
@@ -78,6 +78,38 @@ async function ensureAllTables() {
     effective_at TIMESTAMPTZ NOT NULL DEFAULT now()
   );`);
 
+  // Delivery prices table (used for location-based fees)
+  await pool.query(`CREATE TABLE IF NOT EXISTS delivery_prices (
+    id SERIAL PRIMARY KEY,
+    country TEXT DEFAULT 'Lebanon',
+    region TEXT NOT NULL,
+    sub_region TEXT,
+    price_lbp BIGINT DEFAULT 0,
+    price_usd NUMERIC(10,2) DEFAULT 0,
+    is_active BOOLEAN DEFAULT true,
+    created_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
+    created_at TIMESTAMPTZ DEFAULT now(),
+    updated_at TIMESTAMPTZ DEFAULT now()
+  );`);
+
+  await pool.query(`
+    CREATE INDEX IF NOT EXISTS idx_delivery_prices_region ON delivery_prices(country, region, COALESCE(sub_region,'~'));
+    CREATE INDEX IF NOT EXISTS idx_delivery_prices_active ON delivery_prices(is_active);
+  `);
+
+  // Third parties table
+  await pool.query(`CREATE TABLE IF NOT EXISTS third_parties (
+    id SERIAL PRIMARY KEY,
+    name TEXT UNIQUE NOT NULL,
+    contact_person TEXT,
+    contact_phone TEXT,
+    email TEXT,
+    commission_rate NUMERIC(5,2) DEFAULT 0,
+    active BOOLEAN DEFAULT true,
+    created_at TIMESTAMPTZ DEFAULT now(),
+    updated_at TIMESTAMPTZ DEFAULT now()
+  );`);
+
   // Orders table
   await pool.query(`CREATE TABLE IF NOT EXISTS orders (
     id SERIAL PRIMARY KEY,
@@ -110,6 +142,23 @@ async function ensureAllTables() {
     completed_at TIMESTAMPTZ
   );`);
 
+  // Ensure additional order fields exist (non-destructive migrations)
+  await pool.query(`
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS prepaid_status BOOLEAN DEFAULT false;
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS third_party_id INTEGER REFERENCES third_parties(id) ON DELETE SET NULL;
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_mode TEXT DEFAULT 'direct';
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS fee_usd NUMERIC(12,2) DEFAULT 0;
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS fee_lbp BIGINT DEFAULT 0;
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_country TEXT DEFAULT 'Lebanon';
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_region TEXT;
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_sub_region TEXT;
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS delivery_price_id INTEGER REFERENCES delivery_prices(id) ON DELETE SET NULL;
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS latitude NUMERIC(10,6);
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS longitude NUMERIC(10,6);
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS location_text TEXT;
+    ALTER TABLE orders ADD COLUMN IF NOT EXISTS external_id TEXT;
+  `);
+
   // Transactions table
   await pool.query(`CREATE TABLE IF NOT EXISTS transactions (
     id SERIAL PRIMARY KEY,
@@ -121,8 +170,21 @@ async function ensureAllTables() {
     debit_account TEXT,
     credit_account TEXT,
     description TEXT,
+    category TEXT,
+    direction TEXT,
     order_id INTEGER REFERENCES orders(id) ON DELETE SET NULL,
     created_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
+    created_at TIMESTAMPTZ DEFAULT now(),
+    updated_at TIMESTAMPTZ DEFAULT now()
+  );`);
+
+  // Order history / audit table
+  await pool.query(`CREATE TABLE IF NOT EXISTS order_history (
+    id SERIAL PRIMARY KEY,
+    order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,
+    action TEXT NOT NULL,
+    actor TEXT,
+    details JSONB,
     created_at TIMESTAMPTZ DEFAULT now()
   );`);
 
@@ -176,6 +238,7 @@ async function ensureAllTables() {
     CREATE INDEX IF NOT EXISTS idx_transactions_actor ON transactions(actor_type, actor_id);
     CREATE INDEX IF NOT EXISTS idx_transactions_type ON transactions(tx_type);
     CREATE INDEX IF NOT EXISTS idx_transactions_created_at ON transactions(created_at);
+    CREATE INDEX IF NOT EXISTS idx_order_history_order ON order_history(order_id, created_at);
   `);
 
   console.log('Γ£à All tables and indexes created successfully');
@@ -202,9 +265,20 @@ async function seedInitialData() {
   console.log('Γ£à Cashbox initialized');
 
   // Ensure exchange rate exists
-  await pool.query(`INSERT INTO exchange_rates(lbp_per_usd)
-    VALUES ($1) ON CONFLICT DO NOTHING`, [Number(process.env.EXCHANGE_RATE || 89000)]);
+  await pool.query(`
+    INSERT INTO exchange_rates(lbp_per_usd)
+    SELECT $1
+    WHERE NOT EXISTS (SELECT 1 FROM exchange_rates)
+  `, [Number(process.env.EXCHANGE_RATE || 89000)]);
   console.log('Γ£à Exchange rate initialized');
+
+  // Seed delivery prices if table exists and empty (minimal seed)
+  await pool.query(`
+    INSERT INTO delivery_prices(country, region, sub_region, price_lbp, price_usd, is_active)
+    SELECT 'Lebanon','Beirut',NULL, 200000, 0, true
+    WHERE NOT EXISTS (SELECT 1 FROM delivery_prices)
+  `);
+  console.log('Γ£à Delivery prices seeded (minimal)');
 }
 
 async function verifyConnection() {
diff --git a/server/scripts/fixMissingColumns.js b/server/scripts/fixMissingColumns.js
index 9b9aa3e..1486b51 100644
--- a/server/scripts/fixMissingColumns.js
+++ b/server/scripts/fixMissingColumns.js
@@ -80,6 +80,23 @@ async function fixMissingColumns() {
       console.log('Γä╣∩╕Å price_list area column check:', e.message);
     }
 
+    // Ensure third-party fee columns exist on price_list
+    try {
+      await pool.query(`ALTER TABLE price_list ADD COLUMN IF NOT EXISTS third_party_fee_usd NUMERIC(10,2) DEFAULT 0`);
+      await pool.query(`ALTER TABLE price_list ADD COLUMN IF NOT EXISTS third_party_fee_lbp BIGINT DEFAULT 0`);
+      console.log('Γ£à Ensured third-party fee columns on price_list');
+    } catch (e) {
+      console.log('Γä╣∩╕Å price_list third-party fee columns check:', e.message);
+    }
+
+    // Ensure is_active column exists on price_list (boolean)
+    try {
+      await pool.query(`ALTER TABLE price_list ADD COLUMN IF NOT EXISTS is_active BOOLEAN DEFAULT true`);
+      console.log('Γ£à Ensured is_active column on price_list');
+    } catch (e) {
+      console.log('Γä╣∩╕Å price_list is_active column check:', e.message);
+    }
+
     // 3. Ensure clients table exists with proper structure
     console.log('≡ƒôï Ensuring clients table exists...');
     
@@ -174,6 +191,57 @@ async function fixMissingColumns() {
       console.log('Γä╣∩╕Å driver_operations table already exists or error:', e.message);
     }
 
+    // 5. Ensure orders computed totals and accounting flags
+    try {
+      await pool.query(`ALTER TABLE orders ADD COLUMN IF NOT EXISTS computed_total_usd NUMERIC(12,2) DEFAULT 0`);
+      await pool.query(`ALTER TABLE orders ADD COLUMN IF NOT EXISTS computed_total_lbp BIGINT DEFAULT 0`);
+      await pool.query(`ALTER TABLE orders ADD COLUMN IF NOT EXISTS moved_to_history BOOLEAN DEFAULT false`);
+      await pool.query(`ALTER TABLE orders ADD COLUMN IF NOT EXISTS accounting_cashed BOOLEAN DEFAULT false`);
+      await pool.query(`ALTER TABLE orders ADD COLUMN IF NOT EXISTS moved_at TIMESTAMPTZ`);
+      await pool.query(`ALTER TABLE orders ADD COLUMN IF NOT EXISTS created_at TIMESTAMPTZ DEFAULT now()`);
+      await pool.query(`ALTER TABLE orders ADD COLUMN IF NOT EXISTS updated_at TIMESTAMPTZ DEFAULT now()`);
+      console.log('Γ£à Ensured orders computed/accounting flags/created_at/updated_at columns');
+    } catch (e) {
+      console.log('Γä╣∩╕Å orders column ensure check:', e.message);
+    }
+
+    // 6. Ensure cashbox tables exist or have required columns
+    try {
+      await pool.query(`
+        CREATE TABLE IF NOT EXISTS cashbox_entries (
+          id SERIAL PRIMARY KEY,
+          order_id INTEGER REFERENCES orders(id) ON DELETE SET NULL,
+          entry_type TEXT NOT NULL,
+          amount_usd NUMERIC(12,2) DEFAULT 0,
+          amount_lbp BIGINT DEFAULT 0,
+          actor_type TEXT,
+          actor_id INTEGER,
+          description TEXT,
+          created_by INTEGER REFERENCES users(id) ON DELETE SET NULL,
+          created_at TIMESTAMPTZ DEFAULT now()
+        )
+      `);
+      console.log('Γ£à cashbox_entries ensured');
+    } catch (e) {
+      console.log('Γä╣∩╕Å cashbox_entries ensure check:', e.message);
+    }
+
+    try {
+      await pool.query(`
+        CREATE TABLE IF NOT EXISTS cashbox_reservations (
+          id SERIAL PRIMARY KEY,
+          order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,
+          amount_usd NUMERIC(12,2) DEFAULT 0,
+          amount_lbp BIGINT DEFAULT 0,
+          created_at TIMESTAMPTZ DEFAULT now(),
+          released_at TIMESTAMPTZ
+        )
+      `);
+      console.log('Γ£à cashbox_reservations ensured');
+    } catch (e) {
+      console.log('Γä╣∩╕Å cashbox_reservations ensure check:', e.message);
+    }
+
     console.log('Γ£à All missing columns and tables have been fixed!');
     
   } catch (error) {
diff --git a/server/test-neon-endpoints.js b/server/test-neon-endpoints.js
index 919d23c..f36c923 100644
--- a/server/test-neon-endpoints.js
+++ b/server/test-neon-endpoints.js
@@ -109,6 +109,31 @@ async function testOrders() {
       console.log(`Γ¥î ${endpoint} - Failed`);
     }
   }
+
+  // Batch create two orders and complete one
+  console.log('Γ₧ò Creating batch orders...');
+  const batch = await makeAuthRequest('POST', '/orders/batch', {
+    orders: [
+      { brand_name: 'Test Client A', customer: 'Alice', customer_phone: '70000001', customer_address: 'Addr 1', delivery_mode: 'direct', fee_lbp: 200000, notes: 'A' },
+      { brand_name: 'Test Client B', customer: 'Bob', customer_phone: '70000002', customer_address: 'Addr 2', delivery_mode: 'third_party', third_party_fee_lbp: 100000, fee_lbp: 250000, notes: 'B' }
+    ]
+  });
+  if (!batch || !batch.success) {
+    console.log('Γ¥î /orders/batch - Failed');
+  } else {
+    console.log('Γ£à /orders/batch - OK');
+    const created = batch.data || [];
+    if (created.length >= 2) {
+      const ord = created[1];
+      console.log('≡ƒÜÜ Completing order', ord.id);
+      const complete = await makeAuthRequest('POST', `/orders/${ord.id}/complete`, { status: 'completed', payment_status: 'paid' });
+      if (complete && complete.success) {
+        console.log('Γ£à /orders/:id/complete - OK');
+      } else {
+        console.log('Γ¥î /orders/:id/complete - Failed');
+      }
+    }
+  }
 }
 
 // Test Drivers endpoints
diff --git a/server/test-simple.js b/server/test-simple.js
index 3462296..d97b43b 100644
--- a/server/test-simple.js
+++ b/server/test-simple.js
@@ -1,3 +1,68 @@
+const { computeDisplayedAmounts } = require('./utils/computeDisplayedAmounts');
+
+function assertEqual(a, b, msg) {
+  if (JSON.stringify(a) !== JSON.stringify(b)) {
+    console.error('Γ¥î', msg, 'Expected:', b, 'Got:', a);
+    process.exit(1);
+  }
+}
+
+// In-house ecommerce
+const ih = computeDisplayedAmounts({
+  total_usd: 10,
+  total_lbp: 1000,
+  delivery_fee_usd: 2,
+  delivery_fee_lbp: 200,
+  third_party_fee_usd: 0,
+  third_party_fee_lbp: 0,
+  driver_fee_usd: 1,
+  driver_fee_lbp: 100,
+  deliver_method: 'in_house',
+  type: 'ecommerce'
+});
+assertEqual({u: ih.computedTotalUSD, l: ih.computedTotalLBP, show: ih.showDeliveryFees}, {u: 10, l: 1000, show: true}, 'in_house ecommerce totals');
+
+// In-house instant
+const ihInst = computeDisplayedAmounts({
+  total_usd: 10,
+  total_lbp: 1000,
+  delivery_fee_usd: 2,
+  delivery_fee_lbp: 200,
+  driver_fee_usd: 1,
+  driver_fee_lbp: 100,
+  deliver_method: 'in_house',
+  type: 'instant'
+});
+assertEqual({u: ihInst.computedTotalUSD, l: ihInst.computedTotalLBP, show: ihInst.showDeliveryFees}, {u: 11, l: 1100, show: false}, 'in_house instant totals');
+
+// Third party ecommerce
+const tp = computeDisplayedAmounts({
+  total_usd: 10,
+  total_lbp: 1000,
+  delivery_fee_usd: 2,
+  delivery_fee_lbp: 200,
+  third_party_fee_usd: 3,
+  third_party_fee_lbp: 300,
+  deliver_method: 'third_party',
+  type: 'ecommerce'
+});
+assertEqual({u: tp.computedTotalUSD, l: tp.computedTotalLBP, show: tp.showDeliveryFees}, {u: 15, l: 1500, show: true}, 'third_party ecommerce totals');
+
+// Third party instant
+const tpInst = computeDisplayedAmounts({
+  total_usd: 10,
+  total_lbp: 1000,
+  driver_fee_usd: 1,
+  driver_fee_lbp: 100,
+  third_party_fee_usd: 3,
+  third_party_fee_lbp: 300,
+  deliver_method: 'third_party',
+  type: 'instant'
+});
+assertEqual({u: tpInst.computedTotalUSD, l: tpInst.computedTotalLBP, show: tpInst.showDeliveryFees}, {u: 14, l: 1400, show: false}, 'third_party instant totals');
+
+console.log('Γ£à computeDisplayedAmounts unit tests passed');
+
 const axios = require('axios');
 
 const API_BASE = 'http://localhost:5000/api';
